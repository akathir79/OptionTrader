<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading - Options Chain</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .atm-strike {
            background-color: #fff3cd !important;
            border: 2px solid #ffeaa7 !important;
        }
        
        .table-success {
            background-color: #d4edda !important;
        }
        
        .option-chain-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .table th {
            position: sticky;
            top: 0;
            background-color: #343a40 !important;
            z-index: 10;
        }
        
        .resizable-container {
            display: flex;
            height: 100vh;
        }
        
        .left-panel {
            width: 300px;
            min-width: 250px;
            background-color: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #dee2e6;
        }
        
        .right-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #dee2e6;
        }
        
        .resizer:hover {
            background-color: #007bff;
        }
        
        .spot-price {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .atm-display {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }
        
        .symbol-display {
            font-size: 20px;
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <!-- Symbol Selection Panel -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Symbol Selection</h5>
                    </div>
                    <div class="card-body">
                        <!-- Index Selection -->
                        <div class="mb-3">
                            <label class="form-label">Index</label>
                            <select class="form-select" id="indexSelect">
                                <option value="">Select Index</option>
                                <option value="NIFTY 50">NIFTY 50</option>
                                <option value="BANK NIFTY">BANK NIFTY</option>
                                <option value="NIFTY MIDCAP 50">NIFTY MIDCAP 50</option>
                                <option value="NIFTY SMALLCAP 50">NIFTY SMALLCAP 50</option>
                                <option value="NIFTY FINANCIAL SERVICES">NIFTY FINANCIAL SERVICES</option>
                                <option value="NIFTY IT">NIFTY IT</option>
                                <option value="NIFTY FMCG">NIFTY FMCG</option>
                                <option value="NIFTY PHARMA">NIFTY PHARMA</option>
                                <option value="NIFTY REALTY">NIFTY REALTY</option>
                                <option value="NIFTY METAL">NIFTY METAL</option>
                                <option value="NIFTY ENERGY">NIFTY ENERGY</option>
                                <option value="NIFTY AUTO">NIFTY AUTO</option>
                                <option value="NIFTY MEDIA">NIFTY MEDIA</option>
                                <option value="NIFTY PSU BANK">NIFTY PSU BANK</option>
                                <option value="NIFTY PRIVATE BANK">NIFTY PRIVATE BANK</option>
                            </select>
                        </div>
                        
                        <!-- Expiry Selection -->
                        <div class="mb-3">
                            <label class="form-label">Expiry Date</label>
                            <div id="expiryCarousel" class="d-flex align-items-center">
                                <button class="btn btn-outline-secondary btn-sm me-2" id="prevExpiry">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="flex-grow-1 overflow-hidden">
                                    <div id="expiryView" class="d-flex" style="transition: transform 0.3s ease;">
                                        <!-- Expiry options will be populated here -->
                                    </div>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm ms-2" id="nextExpiry">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Selection Display -->
                        <div class="mb-3">
                            <div class="card bg-light">
                                <div class="card-body p-2">
                                    <div class="symbol-display" id="symbolDisplay">Select an index</div>
                                    <div class="spot-price" id="spotPrice">-</div>
                                    <div class="atm-display" id="atmDisplay">ATM: -</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="loadChain">Load Option Chain</button>
                            <button class="btn btn-success" id="startLive">Start Live Data</button>
                            <button class="btn btn-warning" id="stopLive">Stop Live Data</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- Option Chain Table -->
                <div class="card">
                    <div class="card-header">
                        <h5>Option Chain - <span id="chainTitle">Select Symbol</span></h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="option-chain-container">
                            <table class="table table-sm table-striped mb-0" id="optionChainTable">
                                <thead>
                                    <tr>
                                        <th>CE B/S</th>
                                        <th>LTP</th>
                                        <th>Δ</th>
                                        <th>Strike</th>
                                        <th>Δ</th>
                                        <th>LTP</th>
                                        <th>PE B/S</th>
                                    </tr>
                                </thead>
                                <tbody id="optionChainBody">
                                    <!-- Option chain rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/symbol_selector_fixed.js') }}"></script>
    <script src="{{ url_for('static', filename='js/websocket_handler_simple.js') }}"></script>
    
    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Live Trading page loaded');
            
            // Initialize WebSocket handler
            if (typeof WebSocketHandler !== 'undefined') {
                window.wsHandler = new WebSocketHandler();
                window.wsHandler.init();
            }
            
            // Initialize symbol selector
            initSymbolSelector();
        });
        
        function initSymbolSelector() {
            const indexSelect = document.getElementById('indexSelect');
            const loadChainBtn = document.getElementById('loadChain');
            const startLiveBtn = document.getElementById('startLive');
            const stopLiveBtn = document.getElementById('stopLive');
            
            // Index selection handler
            indexSelect.addEventListener('change', function() {
                const selectedIndex = this.value;
                if (selectedIndex) {
                    fetchExpiryForIndex(selectedIndex);
                    updateSymbolDisplay(selectedIndex);
                }
            });
            
            // Load option chain
            loadChainBtn.addEventListener('click', function() {
                const selectedIndex = indexSelect.value;
                const selectedExpiry = document.querySelector('.expiry-option.selected');
                
                if (selectedIndex && selectedExpiry) {
                    const expiry = selectedExpiry.textContent.trim();
                    loadOptionChain(selectedIndex, expiry);
                }
            });
            
            // Start live data
            startLiveBtn.addEventListener('click', function() {
                if (window.wsHandler) {
                    const selectedIndex = indexSelect.value;
                    const selectedExpiry = document.querySelector('.expiry-option.selected');
                    
                    if (selectedIndex && selectedExpiry) {
                        const expiry = selectedExpiry.textContent.trim();
                        window.wsHandler.startLiveData(selectedIndex, expiry);
                    }
                }
            });
            
            // Stop live data
            stopLiveBtn.addEventListener('click', function() {
                if (window.wsHandler) {
                    window.wsHandler.stop();
                }
            });
        }
        
        function fetchExpiryForIndex(symbol) {
            fetch(`/api/expiry-dates?symbol=${encodeURIComponent(symbol)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderExpiryCarousel(data.expiry_dates);
                    }
                })
                .catch(error => {
                    console.error('Error fetching expiry dates:', error);
                });
        }
        
        function renderExpiryCarousel(expiries) {
            const expiryView = document.getElementById('expiryView');
            expiryView.innerHTML = '';
            
            expiries.forEach((expiry, index) => {
                const expiryOption = document.createElement('div');
                expiryOption.className = 'expiry-option btn btn-outline-primary btn-sm me-2 mb-2';
                expiryOption.textContent = expiry;
                expiryOption.style.minWidth = '80px';
                expiryOption.style.cursor = 'pointer';
                
                expiryOption.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.expiry-option').forEach(opt => {
                        opt.classList.remove('selected', 'btn-primary');
                        opt.classList.add('btn-outline-primary');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected', 'btn-primary');
                    this.classList.remove('btn-outline-primary');
                });
                
                expiryView.appendChild(expiryOption);
            });
            
            // Select first expiry by default
            if (expiries.length > 0) {
                const firstExpiry = expiryView.querySelector('.expiry-option');
                if (firstExpiry) {
                    firstExpiry.click();
                }
            }
        }
        
        function updateSymbolDisplay(symbol) {
            const symbolDisplay = document.getElementById('symbolDisplay');
            const chainTitle = document.getElementById('chainTitle');
            
            symbolDisplay.textContent = symbol;
            chainTitle.textContent = symbol;
        }
        
        function loadOptionChain(symbol, expiry) {
            console.log('Loading option chain for:', symbol, expiry);
            
            // Show loading state
            const tableBody = document.getElementById('optionChainBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading option chain...</td></tr>';
            
            // This would be handled by the WebSocket handler
            if (window.wsHandler) {
                window.wsHandler.startLiveData(symbol, expiry);
            }
        }
    </script>
</body>
</html>