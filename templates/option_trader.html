<!-- templates/option_trader.html -->
{% extends "base.html" %}
{% block title %}Option Trader - Modern Trading Platform{% endblock %}

{% block content %}
<style>
/* Replit-inspired Modern UI Styles */
:root {
  --primary-bg: #0e1525;
  --secondary-bg: #1c2333;
  --accent-bg: #242b3d;
  --border-color: #3c4857;
  --text-primary: #f5f6fa;
  --text-secondary: #c7d2fe;
  --accent-color: #6366f1;
  --success-color: #10b981;
  --danger-color: #ef4444;
  --warning-color: #f59e0b;
  --sidebar-width: 280px;
  --header-height: 60px;
}

/* Modern Font System */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  font-size: 14px;
  line-height: 1.5;
  background: var(--primary-bg);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

/* Header Navigation - Replit Style */
.modern-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  padding: 0 20px;
  z-index: 1000;
  backdrop-filter: blur(8px);
}

.header-brand {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  text-decoration: none;
  margin-right: 40px;
}

.header-nav {
  display: flex;
  gap: 24px;
  margin-left: auto;
}

.nav-item {
  color: var(--text-secondary);
  text-decoration: none;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
  font-size: 13px;
  font-weight: 500;
}

.nav-item:hover {
  color: var(--text-primary);
  background: var(--accent-bg);
}

.nav-item.active {
  color: var(--accent-color);
  background: rgba(99, 102, 241, 0.1);
}

/* Main Layout Container */
.main-container {
  display: flex;
  height: 100vh;
  margin-top: var(--header-height);
}

/* Left Sidebar - Replit Style */
.left-sidebar {
  width: var(--sidebar-width);
  background: var(--secondary-bg);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-section:last-child {
  border-bottom: none;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* Right Content Area */
.content-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Resizable Panes - Replit Style */
.pane-container {
  display: flex;
  flex: 1;
  gap: 1px;
  background: var(--border-color);
}

.pane {
  background: var(--primary-bg);
  display: flex;
  flex-direction: column;
  min-width: 300px;
  position: relative;
}

.pane-header {
  height: 40px;
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  padding: 0 16px;
  justify-content: space-between;
}

.pane-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

.pane-controls {
  display: flex;
  gap: 8px;
}

.pane-control {
  width: 20px;
  height: 20px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s ease;
}

.pane-control:hover {
  background: var(--accent-bg);
  color: var(--text-primary);
}

.pane-content {
  flex: 1;
  overflow: auto;
  padding: 16px;
}

/* Docking System */
.docked-fullscreen {
  position: fixed;
  top: var(--header-height);
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  background: var(--primary-bg);
}

.docked-fullscreen .pane-header {
  background: var(--accent-bg);
}

/* Resizable Splitter */
.splitter {
  width: 4px;
  background: var(--border-color);
  cursor: col-resize;
  transition: background-color 0.2s ease;
}

.splitter:hover {
  background: var(--accent-color);
}

/* Modern Form Controls */
.modern-form-group {
  margin-bottom: 16px;
}

.modern-label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.modern-select, .modern-input {
  width: 100%;
  padding: 8px 12px;
  background: var(--accent-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  transition: all 0.2s ease;
}

.modern-select:focus, .modern-input:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.modern-button {
  padding: 8px 16px;
  background: var(--accent-color);
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.modern-button:hover {
  background: #5855eb;
  transform: translateY(-1px);
}

.modern-button.secondary {
  background: var(--accent-bg);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.modern-button.secondary:hover {
  background: var(--border-color);
}

/* Tables */
.modern-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.modern-table th {
  padding: 12px 8px;
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  text-align: left;
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.modern-table td {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
}

.modern-table tr:hover {
  background: var(--accent-bg);
}

/* Cards */
.modern-card {
  background: var(--secondary-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 16px;
}

.card-header {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
  background: var(--accent-bg);
}

.card-title {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.card-content {
  padding: 16px;
}

/* Responsive Design */
@media (max-width: 1200px) {
  .left-sidebar {
    width: 240px;
  }
}

@media (max-width: 768px) {
  .left-sidebar {
    width: 100%;
    position: fixed;
    top: var(--header-height);
    left: -100%;
    z-index: 998;
    transition: left 0.3s ease;
  }
  
  .left-sidebar.mobile-open {
    left: 0;
  }
  
  .content-area {
    width: 100%;
  }
  
  .pane-container {
    flex-direction: column;
  }
  
  .pane {
    min-width: unset;
    min-height: 300px;
  }
  
  .header-nav {
    display: none;
  }
}

/* Trading Button Styles */
.trading-buttons {
  display: flex;
  gap: 4px;
}

.btn-buy, .btn-sell {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.btn-buy {
  background: var(--success-color);
  color: white;
}

.btn-buy:hover {
  background: #059669;
}

.btn-sell {
  background: var(--danger-color);
  color: white;
}

.btn-sell:hover {
  background: #dc2626;
}

.button-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--warning-color);
  color: var(--primary-bg);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  font-size: 9px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 16px;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: var(--secondary-bg);
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent-color);
}

/* Loading States */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-secondary);
}

.loading::after {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-top: 2px solid var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ATM Strike Highlighting */
.atm-strike-highlight {
  background-color: rgba(99, 102, 241, 0.2) !important;
  border: 1px solid var(--accent-color) !important;
}

/* ITM/OTM Color Coding */
.itm-call, .itm-put {
  background-color: rgba(16, 185, 129, 0.1) !important;
}

.otm-call, .otm-put {
  background-color: rgba(239, 68, 68, 0.1) !important;
}

/* Value Change Animations */
.value-increased {
  color: var(--success-color) !important;
  transition: color 0.3s ease;
}

.value-decreased {
  color: var(--danger-color) !important;
  transition: color 0.3s ease;
}

/* Chart Container */
.chart-container {
  height: 400px;
  width: 100%;
  background: var(--secondary-bg);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

/* Status Indicators */
.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.status-online {
  background: var(--success-color);
}

.status-offline {
  background: var(--danger-color);
}

.status-warning {
  background: var(--warning-color);
}
</style>

<!-- Modern Header -->
<header class="modern-header">
  <a href="/" class="header-brand">🚀 Option Trader</a>
  <nav class="header-nav">
    <a href="/option-trader" class="nav-item active">Trading</a>
    <a href="#" class="nav-item">Portfolio</a>
    <a href="#" class="nav-item">Analytics</a>
    <a href="#" class="nav-item">Settings</a>
  </nav>
</header>

<!-- Main Layout Container -->
<div class="main-container">
  <!-- Left Sidebar -->
  <div class="left-sidebar">
    <!-- Broker Configuration -->
    <div class="sidebar-section">
      <div class="section-title">Broker Setup</div>
      <div class="modern-form-group">
        <label class="modern-label">Broker</label>
        <select id="brokerSelect" class="modern-select">
          <option value="">Select Broker</option>
        </select>
      </div>
      <div class="modern-form-group">
        <label class="modern-label">User ID</label>
        <select id="userIdSelect" class="modern-select" disabled>
          <option value="">Select User ID</option>
        </select>
      </div>
      <div id="brokerInfo" style="display: none;">
        <div class="modern-card">
          <div class="card-content">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span class="status-indicator status-online"></span>
              <span id="selectedBrokerName" style="font-weight: 600;"></span>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">
              User: <span id="selectedBrokerUserId"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Symbol Selection -->
    <div class="sidebar-section">
      <div class="section-title">Symbol Selection</div>
      <div class="modern-form-group">
        <label class="modern-label">Index</label>
        <select id="indexSelect" class="modern-select">
          <option value="">Select Index</option>
          <option value="NIFTY 50">NIFTY 50</option>
          <option value="NIFTY BANK">NIFTY BANK</option>
          <option value="NIFTY FIN SERVICE">NIFTY FIN SERVICE</option>
        </select>
      </div>
      <div class="modern-form-group">
        <label class="modern-label">Expiry Date</label>
        <select id="expirySelect" class="modern-select" disabled>
          <option value="">Select Expiry</option>
        </select>
      </div>
      <div class="modern-form-group">
        <label class="modern-label">Strike Count</label>
        <input type="number" id="strikeCount" class="modern-input" value="10" min="5" max="50">
      </div>
      <button id="loadDataBtn" class="modern-button" style="width: 100%;">Load Option Chain</button>
    </div>

    <!-- Market Status -->
    <div class="sidebar-section">
      <div class="section-title">Market Status</div>
      <div class="modern-card">
        <div class="card-content">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>NIFTY 50</span>
            <span id="spotPrice" style="font-weight: 600;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 12px;">
            <span style="color: var(--text-secondary);">Change</span>
            <span id="spotChange" style="font-weight: 600;">--</span>
          </div>
        </div>
      </div>
      <button id="marketsBtn" class="modern-button secondary" style="width: 100%; margin-top: 12px;">
        🌍 World Markets
      </button>
    </div>

    <!-- Position Summary -->
    <div class="sidebar-section">
      <div class="section-title">Position Summary</div>
      <div class="modern-card">
        <div class="card-content">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Realized P&L</span>
            <span id="realizedPnL" style="font-weight: 600; color: var(--success-color);">₹0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Unrealized P&L</span>
            <span id="unrealizedPnL" style="font-weight: 600;">₹0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 12px;">
            <span style="color: var(--text-secondary);">Active Positions</span>
            <span id="activePositionCount">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="content-area">
    <!-- Resizable Panes Container -->
    <div class="pane-container">
      <!-- Option Chain Pane -->
      <div id="optionChainPane" class="pane" style="flex: 2;">
        <div class="pane-header">
          <div class="pane-title">📊 Option Chain</div>
          <div class="pane-controls">
            <button class="pane-control" onclick="toggleDocking('optionChainPane')" title="Toggle Fullscreen">⛶</button>
            <button class="pane-control" onclick="refreshOptionChain()" title="Refresh">↻</button>
          </div>
        </div>
        <div class="pane-content">
          <!-- Option Chain Loading Indicator -->
          <div id="optionChainLoading" class="loading" style="display: none;">
            Loading option chain data...
          </div>
          
          <!-- Option Chain Table Container -->
          <div id="optionChainContainer" style="overflow-y: auto; max-height: calc(100vh - 200px);">
            <table class="modern-table" id="optionChainTable">
              <thead>
                <tr>
                  <th>CE B/S</th>
                  <th>Veta</th>
                  <th>Volga</th>
                  <th>Charm</th>
                  <th>Vanna</th>
                  <th>Vega</th>
                  <th>Theta</th>
                  <th>Gamma</th>
                  <th>Chng</th>
                  <th>Bid Qty</th>
                  <th>Bid</th>
                  <th>Ask</th>
                  <th>Ask Qty</th>
                  <th>Chng in OI</th>
                  <th>OI</th>
                  <th>Vol</th>
                  <th>Chart</th>
                  <th>LTP</th>
                  <th>Δ</th>
                  <th style="background-color: var(--accent-color); color: white; font-weight: 600;">Strike</th>
                  <th>Δ</th>
                  <th>LTP</th>
                  <th>Chart</th>
                  <th>Vol</th>
                  <th>OI</th>
                  <th>Chng in OI</th>
                  <th>Ask Qty</th>
                  <th>Ask</th>
                  <th>Bid</th>
                  <th>Bid Qty</th>
                  <th>Chng</th>
                  <th>Gamma</th>
                  <th>Theta</th>
                  <th>Vega</th>
                  <th>Vanna</th>
                  <th>Charm</th>
                  <th>Volga</th>
                  <th>Veta</th>
                  <th>PE B/S</th>
                </tr>
              </thead>
              <tbody>
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Splitter -->
      <div class="splitter" onmousedown="initResize(event)"></div>

      <!-- Right Panel Container -->
      <div style="flex: 1; display: flex; flex-direction: column;">
        <!-- Payoff Chart Pane -->
        <div id="payoffChartPane" class="pane" style="flex: 1;">
          <div class="pane-header">
            <div class="pane-title">📈 Payoff Chart</div>
            <div class="pane-controls">
              <button class="pane-control" onclick="toggleDocking('payoffChartPane')" title="Toggle Fullscreen">⛶</button>
              <button class="pane-control" onclick="resetChart()" title="Reset Chart">⟲</button>
            </div>
          </div>
          <div class="pane-content">
            <!-- Risk Metrics Display -->
            <div style="margin-bottom: 16px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 16px; font-size: 12px;">
              <div style="text-align: center;">
                <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 10px; text-transform: uppercase;">Req. Margin</div>
                <div id="marginValue" style="font-weight: 600; color: var(--accent-color);">₹3,391 <span style="color: var(--text-secondary);">□</span></div>
              </div>
              <div style="text-align: center;">
                <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 10px; text-transform: uppercase;">P&L</div>
                <div id="pnlValue" style="font-weight: 600; color: var(--success-color);">₹0 (0.00)</div>
              </div>
              <div style="text-align: center;">
                <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 10px; text-transform: uppercase;">Net Credit</div>
                <div id="netCreditValue" style="font-weight: 600;">₹0.00</div>
              </div>
              <div style="text-align: center;">
                <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 10px; text-transform: uppercase;">Max Profit</div>
                <div id="maxProfitValue" style="font-weight: 600; color: var(--success-color);">₹0.00</div>
              </div>
              <div style="text-align: center;">
                <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 10px; text-transform: uppercase;">Max Loss</div>
                <div id="maxLossValue" style="font-weight: 600; color: var(--danger-color);">₹0.00</div>
              </div>
            </div>
            
            <!-- Chart Container -->
            <div id="chartContainer" style="height: 400px; width: 100%; background: var(--secondary-bg); border-radius: 8px;">
              <!-- Highcharts payoff chart will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Position Tables Pane -->
        <div id="positionTablesPane" class="pane" style="flex: 1;">
          <div class="pane-header">
            <div class="pane-title">📋 Positions & Trades</div>
            <div class="pane-controls">
              <button class="pane-control" onclick="toggleDocking('positionTablesPane')" title="Toggle Fullscreen">⛶</button>
              <button class="pane-control" onclick="refreshPositions()" title="Refresh">↻</button>
            </div>
          </div>
          <div class="pane-content">
            <!-- Position Tabs -->
            <div style="margin-bottom: 16px;">
              <button id="activeTab" class="modern-button" onclick="switchPositionTab('active')" style="margin-right: 8px;">Active Positions</button>
              <button id="closedTab" class="modern-button secondary" onclick="switchPositionTab('closed')">Closed Trades</button>
            </div>
            
            <!-- Active Positions Table -->
            <div id="activePositionsContainer">
              <table id="activePositionsTable" class="modern-table">
                <thead>
                  <tr>
                    <th>Strike</th>
                    <th>Type</th>
                    <th>Action</th>
                    <th>Lots</th>
                    <th>Entry</th>
                    <th>Current</th>
                    <th>P&L</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                      No active positions
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Closed Trades Table -->
            <div id="closedTradesContainer" style="display: none;">
              <table id="closedTradesTable" class="modern-table">
                <thead>
                  <tr>
                    <th>Strike</th>
                    <th>Type</th>
                    <th>Action</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>P&L</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                      No closed trades
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals and Other Components will be added here -->

<script>
// Global Variables - Preserve the critical synchronization arrays
window.activeLots = [];
window.globalPositions = {};
window.closedTrades = [];
window.realizedPnL = 0;
window.currentExpiry = '';
window.currentSpotPrice = 0;

// Docking System
function toggleDocking(paneId) {
  const pane = document.getElementById(paneId);
  if (pane.classList.contains('docked-fullscreen')) {
    pane.classList.remove('docked-fullscreen');
  } else {
    // Remove any existing fullscreen panes
    document.querySelectorAll('.docked-fullscreen').forEach(p => p.classList.remove('docked-fullscreen'));
    pane.classList.add('docked-fullscreen');
  }
}

// Position Tab Switching
function switchPositionTab(tab) {
  const activeTab = document.getElementById('activeTab');
  const closedTab = document.getElementById('closedTab');
  const activeContainer = document.getElementById('activePositionsContainer');
  const closedContainer = document.getElementById('closedTradesContainer');

  if (tab === 'active') {
    activeTab.className = 'modern-button';
    closedTab.className = 'modern-button secondary';
    activeContainer.style.display = 'block';
    closedContainer.style.display = 'none';
  } else {
    activeTab.className = 'modern-button secondary';
    closedTab.className = 'modern-button';
    activeContainer.style.display = 'none';
    closedContainer.style.display = 'block';
  }
}

// Resizable Panes
let isResizing = false;

function initResize(e) {
  isResizing = true;
  document.addEventListener('mousemove', doResize);
  document.addEventListener('mouseup', stopResize);
  e.preventDefault();
}

function doResize(e) {
  if (!isResizing) return;
  const container = document.querySelector('.pane-container');
  const rect = container.getBoundingClientRect();
  const percentage = ((e.clientX - rect.left) / rect.width) * 100;
  
  if (percentage > 20 && percentage < 80) {
    const leftPane = document.getElementById('optionChainPane');
    const rightPane = leftPane.nextElementSibling.nextElementSibling;
    leftPane.style.flex = `${percentage / 50}`;
    rightPane.style.flex = `${(100 - percentage) / 50}`;
  }
}

function stopResize() {
  isResizing = false;
  document.removeEventListener('mousemove', doResize);
  document.removeEventListener('mouseup', stopResize);
}

// Placeholder functions - will be replaced with actual functionality
function refreshOptionChain() {
  console.log('Refreshing option chain...');
}

function resetChart() {
  console.log('Resetting chart...');
}

function refreshPositions() {
  console.log('Refreshing positions...');
}

// Mobile menu toggle
function toggleMobileMenu() {
  document.querySelector('.left-sidebar').classList.toggle('mobile-open');
}

// Initialize the modern UI
document.addEventListener('DOMContentLoaded', function() {
  console.log('Modern Option Trader UI initialized');
  
  // Add mobile menu button for small screens
  if (window.innerWidth <= 768) {
    const header = document.querySelector('.modern-header');
    const menuBtn = document.createElement('button');
    menuBtn.innerHTML = '☰';
    menuBtn.className = 'modern-button';
    menuBtn.style.marginRight = 'auto';
    menuBtn.onclick = toggleMobileMenu;
    header.insertBefore(menuBtn, header.querySelector('.header-nav'));
  }
});

// Handle window resize
window.addEventListener('resize', function() {
  if (window.innerWidth > 768) {
    document.querySelector('.left-sidebar').classList.remove('mobile-open');
  }
});
</script>

<!-- ===================================================================== -->
<!-- CRITICAL JAVASCRIPT FUNCTIONALITY - PRESERVE ALL SYNCHRONIZATION LOGIC -->
<!-- ALL EXISTING FUNCTIONS MOVED HERE WITH COMPLETE PRESERVATION -->
<!-- ===================================================================== -->

<!-- Include Required Libraries -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>

<script>
//====================================================================
// CRITICAL GLOBAL VARIABLES - DO NOT MODIFY THESE ARRAY STRUCTURES
// These arrays MUST remain synchronized at all times
//====================================================================
window.activeLots = [];           // Individual lot tracking for badge counts
window.globalPositions = {};      // Aggregated positions for tables/cards  
window.closedTrades = [];         // Closed trade records
window.realizedPnL = 0;          // Total realized P&L
window.currentExpiry = '';       // Current selected expiry
window.currentSpotPrice = 0;     // Current spot price

// Supporting global variables
let payoffChart = null;
let counters = {};               // Button click counters
let firstClickFlags = {};       // Track first clicks

// Chart and trading state
window.tradingState = {
    currentExpiry: null,
    currentSymbol: null,
    spotPrice: 0
};

//====================================================================
// HELPER FUNCTIONS
//====================================================================

// Function to get current LTP for a strike and option type
function getCurrentLTP(strike, optionType, expiry) {
    // Try to get LTP from the option chain table
    const table = document.getElementById('optionChainTable');
    if (!table) return 0;
    
    const rows = table.querySelectorAll('tbody tr');
    for (let row of rows) {
        const strikeTd = row.children[19]; // Strike column
        if (strikeTd && parseFloat(strikeTd.textContent) === strike) {
            if (optionType === 'CE') {
                const ltpTd = row.children[17]; // CE LTP column
                return parseFloat(ltpTd?.textContent || 0);
            } else {
                const ltpTd = row.children[21]; // PE LTP column  
                return parseFloat(ltpTd?.textContent || 0);
            }
        }
    }
    return 0;
}

// Function to update button badge display
function updateButtonBadge(rowIndex, key, count) {
    const badge = document.getElementById(`${key}Badge_${rowIndex}`);
    if (badge) {
        badge.textContent = count;
        if (count > 0) {
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Function to update realized P&L display
function updateRealizedPnLDisplay() {
    const realizedPnLElements = document.querySelectorAll('.realized-pnl-display, #realizedPnL');
    realizedPnLElements.forEach(element => {
        const color = window.realizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        const sign = window.realizedPnL >= 0 ? '+' : '';
        element.innerHTML = `<span style="color: ${color};">₹${sign}${window.realizedPnL.toFixed(2)}</span>`;
    });
}

//====================================================================
// CRITICAL SYNCHRONIZATION FUNCTION - DO NOT BREAK THIS LOGIC
// This function MUST update ALL THREE arrays: activeLots, globalPositions, closedTrades
// See replit.md "CRITICAL SYNCHRONIZATION LOGIC" section for preservation rules
//====================================================================
function handleButtonClick(rowIndex, key, action) {
    console.log(`🔥 handleButtonClick CALLED: row=${rowIndex}, key=${key}, action=${action}`);
    console.log(`🔥 Current activeLots BEFORE:`, window.activeLots);
    console.log(`🔥 Current closedTrades BEFORE:`, window.closedTrades);
    
    // Get current expiry and strike information
    const currentExpiry = window.tradingState?.currentExpiry || window.webSocketHandler?.currentExpiry;
    const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
    let strike = 0;
    if (row) {
        const strikeTd = row.children[19]; // Strike column
        strike = parseFloat(strikeTd?.textContent || 0);
    }
    
    console.log(`🔥 Strike: ${strike}, Expiry: ${currentExpiry}`);
    
    if (action === 'add') {
        const optionType = key.includes('ce') ? 'CE' : 'PE';
        const isCurrentBuy = key.includes('Buy');
        const currentAction = isCurrentBuy ? 'Buy' : 'Sell';
        
        // Get current LTP as price
        const currentLTP = getCurrentLTP(strike, optionType, currentExpiry);
        console.log(`🔥 Current LTP: ${currentLTP} for ${optionType} ${strike}`);
        
        // Check for opposite lots to net against (FIFO)
        const oppositeLots = window.activeLots.filter(lot => 
            lot.strike === strike && 
            lot.expiry === currentExpiry && 
            lot.optionType === optionType && 
            lot.action !== currentAction
        ).sort((a, b) => a.timestamp - b.timestamp); // FIFO: oldest first
        
        if (oppositeLots.length > 0) {
            // NETTING: Close the oldest opposite lot
            const oldestLot = oppositeLots[0];
            console.log(`🔥 NETTING: Closing lot opened at ${oldestLot.entryPrice}`);
            
            // Calculate realized P&L
            let sellPrice, buyPrice;
            if (isCurrentBuy) {
                // Buying to close a sell position
                sellPrice = oldestLot.entryPrice; // Original sell price
                buyPrice = currentLTP; // Current buy price
            } else {
                // Selling to close a buy position  
                buyPrice = oldestLot.entryPrice; // Original buy price
                sellPrice = currentLTP; // Current sell price
            }
            
            const pnlPerLot = sellPrice - buyPrice;
            const lotSize = 75;
            const realizedPnLAmount = pnlPerLot * lotSize;
            
            console.log(`🔥 REALIZED P&L: (${sellPrice} - ${buyPrice}) * ${lotSize} = ₹${realizedPnLAmount}`);
            
            // Create closed trade record
            const closedTrade = {
                strike: strike,
                expiry: currentExpiry,
                optionType: optionType,
                openAction: oldestLot.action,
                openPrice: oldestLot.entryPrice,
                openTime: oldestLot.timestamp,
                closeAction: currentAction,
                closePrice: currentLTP,
                closeTime: new Date(),
                realizedPnL: realizedPnLAmount,
                lotSize: lotSize,
                actionLabel: `${oldestLot.action} to Open → ${currentAction} to Close`
            };
            
            window.closedTrades.push(closedTrade);
            window.realizedPnL += realizedPnLAmount;
            
            // Remove the closed lot from active lots
            const lotIndex = window.activeLots.findIndex(lot => lot.id === oldestLot.id);
            if (lotIndex !== -1) {
                window.activeLots.splice(lotIndex, 1);
            }
            
            //====================================================================
            // **CRITICAL NETTING SYNC - PRESERVE THIS EXACT LOGIC**
            // MUST update globalPositions during netting to keep all systems in sync
            // This ensures active trades table and position cards show correct counts
            //====================================================================
            const oppositeKey = oldestLot.action === 'Buy' ? 
                (oldestLot.optionType === 'CE' ? 'ceBuy' : 'peBuy') :
                (oldestLot.optionType === 'CE' ? 'ceSell' : 'peSell');
            const oppositePositionKey = `${strike}-${currentExpiry}-${oppositeKey}`;
            
            if (window.globalPositions[oppositePositionKey] && window.globalPositions[oppositePositionKey].lots > 0) {
                window.globalPositions[oppositePositionKey].lots--;
                console.log(`🔥 NETTING: Reduced globalPositions[${oppositePositionKey}] to ${window.globalPositions[oppositePositionKey].lots}`);
                
                // Remove from globalPositions if lots reach zero
                if (window.globalPositions[oppositePositionKey].lots <= 0) {
                    delete window.globalPositions[oppositePositionKey];
                    console.log(`🔥 NETTING: Removed globalPositions[${oppositePositionKey}] - lots reached zero`);
                }
            }
            
            console.log(`🔥 TRADE CLOSED:`, closedTrade);
            console.log(`🔥 Total Realized P&L: ₹${window.realizedPnL}`);
            
            // Update realized P&L display
            updateRealizedPnLDisplay();
            
        } else {
            // NO NETTING: Create new lot
            const newLot = {
                id: Date.now() + Math.random(), // Unique ID
                strike: strike,
                expiry: currentExpiry,
                optionType: optionType,
                action: currentAction,
                entryPrice: currentLTP,
                timestamp: new Date(),
                rowIndex: rowIndex,
                key: key,
                actionLabel: isCurrentBuy ? 'Buy to Open' : 'Sell to Open'
            };
            
            window.activeLots.push(newLot);
            console.log(`🔥 NEW LOT CREATED:`, newLot);
            
            // Also add to globalPositions for position management card synchronization
            const globalPositionKey = `${strike}-${currentExpiry}-${key}`;
            if (!window.globalPositions[globalPositionKey]) {
                window.globalPositions[globalPositionKey] = {
                    strike: strike,
                    expiry: currentExpiry,
                    optionType: optionType,
                    action: currentAction,
                    lots: 0,
                    rowIndex: rowIndex,
                    key: key,
                    entryPrice: currentLTP
                };
            }
            window.globalPositions[globalPositionKey].lots++;
            console.log(`🔥 ADDED TO GLOBAL POSITIONS:`, window.globalPositions[globalPositionKey]);
            
            // Update counter
            if (!counters[rowIndex]) counters[rowIndex] = {};
            if (!counters[rowIndex][key]) counters[rowIndex][key] = 0;
            counters[rowIndex][key]++;
        }
        
        // Update button badge based on remaining active lots for this type
        const remainingLots = window.activeLots.filter(lot => 
            lot.strike === strike && 
            lot.expiry === currentExpiry && 
            lot.optionType === optionType && 
            lot.action === currentAction
        ).length;
        
        updateButtonBadge(rowIndex, key, remainingLots);
        
        // Update opposite button badge
        const oppositeAction = isCurrentBuy ? 'Sell' : 'Buy';
        const oppositeKey = key.replace(currentAction, oppositeAction);
        const oppositeRemainingLots = window.activeLots.filter(lot => 
            lot.strike === strike && 
            lot.expiry === currentExpiry && 
            lot.optionType === optionType && 
            lot.action === oppositeAction
        ).length;
        
        updateButtonBadge(rowIndex, oppositeKey, oppositeRemainingLots);
        
        console.log(`🔥 Active lots: ${window.activeLots.length}, Closed trades: ${window.closedTrades.length}`);
        
    } else if (action === 'remove') {
        // Handle manual position removal (remove youngest lot first - LIFO for manual removal)
        const optionType = key.includes('ce') ? 'CE' : 'PE';
        const currentAction = key.includes('Buy') ? 'Buy' : 'Sell';
        
        const currentLots = window.activeLots.filter(lot => 
            lot.strike === strike && 
            lot.expiry === currentExpiry && 
            lot.optionType === optionType && 
            lot.action === currentAction
        ).sort((a, b) => b.timestamp - a.timestamp); // LIFO: newest first for manual removal
        
        if (currentLots.length > 0 && counters[rowIndex] && counters[rowIndex][key] > 0) {
            const newestLot = currentLots[0];
            const lotIndex = window.activeLots.findIndex(lot => lot.id === newestLot.id);
            if (lotIndex !== -1) {
                window.activeLots.splice(lotIndex, 1);
                counters[rowIndex][key]--;
                console.log(`🔥 MANUAL REMOVAL: Removed newest lot`);
            }
            
            // Update button badge
            updateButtonBadge(rowIndex, key, currentLots.length - 1);
        }
    }
    
    console.log(`🔥 Current activeLots AFTER:`, window.activeLots);
    console.log(`🔥 Current closedTrades AFTER:`, window.closedTrades);
    
    //====================================================================
    // **MANDATORY UPDATE CALLS - NEVER REMOVE THESE**
    // These MUST be called after any position change for full synchronization
    //====================================================================
    updateActiveTradesTable();     // ✅ SYNC: Update active trades table
    updateClosedTradesTable();     // ✅ SYNC: Update closed trades table
    
    //====================================================================
    // **MANDATORY PAYOFF CHART UPDATE - PRESERVE THIS**
    // This ensures payoff chart stays synchronized with position changes
    //====================================================================
    createPayoffChartFromOptionChain();
    
    // Update real-time payoff chart lines if WebSocket handler exists
    if (window.webSocketHandler && typeof window.webSocketHandler.updatePayoffChartSpotPrice === 'function') {
        window.webSocketHandler.updatePayoffChartSpotPrice();
    }
}

// Table update functions - Critical for synchronization
function updateActiveTradesTable() {
    const tableBody = document.querySelector('#activePositionsTable tbody');
    if (!tableBody) return;
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    // Group positions by key for display
    const positionGroups = {};
    Object.entries(window.globalPositions || {}).forEach(([key, position]) => {
        if (position.lots > 0) {
            positionGroups[key] = position;
        }
    });
    
    if (Object.keys(positionGroups).length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No active positions
                </td>
            </tr>
        `;
        return;
    }
    
    // Add position rows
    Object.entries(positionGroups).forEach(([key, position]) => {
        const currentLTP = getCurrentLTP(position.strike, position.optionType, position.expiry);
        const pnl = (currentLTP - position.entryPrice) * position.lots * 75;
        const pnlClass = pnl >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${position.strike}</td>
            <td>${position.optionType}</td>
            <td>${position.action}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="pane-control" onclick="adjustLots('${key}', -1, event)">-</button>
                    <span style="min-width: 20px; text-align: center;">${position.lots}</span>
                    <button class="pane-control" onclick="adjustLots('${key}', 1, event)">+</button>
                </div>
            </td>
            <td>₹${position.entryPrice.toFixed(2)}</td>
            <td>₹${currentLTP.toFixed(2)}</td>
            <td style="color: ${pnlClass};">₹${pnl.toFixed(2)}</td>
            <td>
                <button class="modern-button" style="padding: 4px 8px; font-size: 11px;" onclick="removePosition('${key}')">
                    Close
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function updateClosedTradesTable() {
    const tableBody = document.querySelector('#closedTradesTable tbody');
    if (!tableBody) return;
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    if (window.closedTrades.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No closed trades
                </td>
            </tr>
        `;
        return;
    }
    
    // Add closed trade rows (show recent first)
    const recentTrades = [...window.closedTrades].reverse().slice(0, 50);
    recentTrades.forEach(trade => {
        const pnlClass = trade.realizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        const timeStr = trade.closeTime ? trade.closeTime.toLocaleTimeString() : '--';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${trade.strike}</td>
            <td>${trade.optionType}</td>
            <td>${trade.actionLabel}</td>
            <td>₹${trade.openPrice.toFixed(2)}</td>
            <td>₹${trade.closePrice.toFixed(2)}</td>
            <td style="color: ${pnlClass};">₹${trade.realizedPnL.toFixed(2)}</td>
            <td>${timeStr}</td>
        `;
        tableBody.appendChild(row);
    });
}

//====================================================================
// PAYOFF CHART FUNCTIONS - CRITICAL FOR CHART SYNCHRONIZATION
//====================================================================

// Initialize payoff chart
function initPayoffChart() {
    if (payoffChart) return; // Already initialized
    
    const chartContainer = document.getElementById('chartContainer');
    if (!chartContainer) return;
    
    payoffChart = Highcharts.chart('chartContainer', {
        chart: { 
            type: 'line', 
            height: 400,
            backgroundColor: 'var(--secondary-bg)',
            zoomType: 'xy',
            panning: {
                enabled: true,
                type: 'xy'
            },
            panKey: 'shift'
        },
        title: { text: null },
        legend: { enabled: false },
        xAxis: {
            title: { 
                text: 'Spot Price',
                style: { color: 'var(--text-primary)' }
            },
            gridLineColor: 'var(--border-color)',
            lineColor: 'var(--border-color)',
            tickColor: 'var(--border-color)',
            labels: { style: { color: 'var(--text-primary)' } }
        },
        yAxis: {
            title: { 
                text: 'P&L (₹)',
                style: { color: 'var(--text-primary)' }
            },
            gridLineColor: 'var(--border-color)',
            lineColor: 'var(--border-color)',
            tickColor: 'var(--border-color)',
            labels: { style: { color: 'var(--text-primary)' } },
            plotLines: [{
                value: 0,
                color: 'var(--text-secondary)',
                dashStyle: 'dash',
                width: 1,
                zIndex: 3
            }]
        },
        plotOptions: {
            series: {
                marker: { enabled: false },
                lineWidth: 2
            }
        },
        credits: { enabled: false },
        exporting: { enabled: false },
        series: []
    });
    
    console.log('Payoff chart initialized');
}

// Create payoff chart from current positions
function createPayoffChartFromOptionChain() {
    if (!payoffChart) {
        initPayoffChart();
        if (!payoffChart) return;
    }
    
    // Clear existing series
    while (payoffChart.series.length > 0) {
        payoffChart.series[0].remove(false);
    }
    
    const positions = window.globalPositions || {};
    const positionArray = Object.values(positions).filter(pos => pos.lots > 0);
    
    if (positionArray.length === 0) {
        payoffChart.redraw();
        return;
    }
    
    // Calculate spot price range for chart
    const strikes = positionArray.map(pos => pos.strike);
    const minStrike = Math.min(...strikes);
    const maxStrike = Math.max(...strikes);
    const range = maxStrike - minStrike;
    const buffer = Math.max(range * 0.2, 100);
    
    const spotStart = Math.max(minStrike - buffer, 0);
    const spotEnd = maxStrike + buffer;
    const step = (spotEnd - spotStart) / 100;
    
    // Calculate combined payoff
    const combinedPayoff = [];
    let maxProfit = -Infinity;
    let maxLoss = Infinity;
    let netCredit = 0;
    
    for (let spot = spotStart; spot <= spotEnd; spot += step) {
        let totalPnL = 0;
        
        positionArray.forEach(position => {
            const strike = position.strike;
            const optionType = position.optionType;
            const action = position.action;
            const lots = position.lots;
            const entryPrice = position.entryPrice;
            const lotSize = 75;
            
            let optionValue = 0;
            if (optionType === 'CE') {
                optionValue = Math.max(0, spot - strike);
            } else {
                optionValue = Math.max(0, strike - spot);
            }
            
            let positionPnL = 0;
            if (action === 'Buy') {
                positionPnL = (optionValue - entryPrice) * lots * lotSize;
                netCredit -= entryPrice * lots * lotSize;
            } else {
                positionPnL = (entryPrice - optionValue) * lots * lotSize;
                netCredit += entryPrice * lots * lotSize;
            }
            
            totalPnL += positionPnL;
        });
        
        combinedPayoff.push([spot, totalPnL]);
        maxProfit = Math.max(maxProfit, totalPnL);
        maxLoss = Math.min(maxLoss, totalPnL);
    }
    
    // Add combined payoff series
    payoffChart.addSeries({
        name: 'Net P&L',
        type: 'line',
        data: combinedPayoff,
        color: 'var(--accent-color)',
        lineWidth: 3,
        zIndex: 10
    }, false);
    
    // Add current spot price line if available
    if (window.currentSpotPrice > 0) {
        payoffChart.xAxis[0].addPlotLine({
            id: 'currentSpot',
            value: window.currentSpotPrice,
            color: 'var(--warning-color)',
            width: 2,
            zIndex: 7,
            label: {
                text: `Spot: ₹${window.currentSpotPrice.toFixed(0)}`,
                align: 'center',
                style: { color: 'var(--text-primary)' }
            }
        });
    }
    
    payoffChart.redraw();
    
    // Update risk metrics
    updateMarginInfo(netCredit, maxProfit, maxLoss);
    
    console.log(`Payoff chart updated with ${positionArray.length} positions`);
}

// Update margin and risk information
function updateMarginInfo(netCredit, maxProfit, maxLoss) {
    const netCreditEl = document.getElementById('netCreditValue');
    const maxProfitEl = document.getElementById('maxProfitValue');
    const maxLossEl = document.getElementById('maxLossValue');
    
    if (netCreditEl) {
        netCreditEl.textContent = `₹${netCredit.toFixed(2)}`;
        netCreditEl.style.color = netCredit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
    }
    
    if (maxProfitEl) {
        maxProfitEl.textContent = maxProfit === -Infinity ? '₹0.00' : `₹${maxProfit.toFixed(2)}`;
    }
    
    if (maxLossEl) {
        maxLossEl.textContent = maxLoss === Infinity ? '₹0.00' : `₹${maxLoss.toFixed(2)}`;
    }
}

//====================================================================
// POSITION MANAGEMENT FUNCTIONS
//====================================================================

// Adjust lots function for +/- buttons in tables
window.adjustLots = function adjustLots(positionKey, change, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const position = window.globalPositions[positionKey];
    if (!position) return;
    
    const newLots = Math.max(0, position.lots + change);
    
    if (newLots === 0) {
        // Remove position entirely
        delete window.globalPositions[positionKey];
        
        // Also remove from activeLots
        window.activeLots = window.activeLots.filter(lot => {
            const lotKey = `${lot.strike}-${lot.expiry}-${lot.key}`;
            return lotKey !== positionKey;
        });
    } else {
        // Update lots count
        position.lots = newLots;
        
        // Sync activeLots array to match
        const currentActiveLots = window.activeLots.filter(lot => {
            const lotKey = `${lot.strike}-${lot.expiry}-${lot.key}`;
            return lotKey === positionKey;
        });
        
        const difference = newLots - currentActiveLots.length;
        
        if (difference > 0) {
            // Add new lots
            for (let i = 0; i < difference; i++) {
                const newLot = {
                    id: Date.now() + Math.random(),
                    strike: position.strike,
                    expiry: position.expiry,
                    optionType: position.optionType,
                    action: position.action,
                    entryPrice: position.entryPrice,
                    timestamp: new Date(),
                    rowIndex: position.rowIndex,
                    key: position.key,
                    actionLabel: `${position.action} to Open`
                };
                window.activeLots.push(newLot);
            }
        } else if (difference < 0) {
            // Remove excess lots (LIFO)
            const sortedLots = currentActiveLots.sort((a, b) => b.timestamp - a.timestamp);
            for (let i = 0; i < Math.abs(difference); i++) {
                const lotToRemove = sortedLots[i];
                if (lotToRemove) {
                    const index = window.activeLots.findIndex(lot => lot.id === lotToRemove.id);
                    if (index !== -1) {
                        window.activeLots.splice(index, 1);
                    }
                }
            }
        }
    }
    
    console.log(`[ADJUST LOTS] Updated ${positionKey}: ${position?.lots || 0} lots`);
    
    // Update all displays
    updateActiveTradesTable();
    updateClosedTradesTable();
    createPayoffChartFromOptionChain();
    updateRealizedPnLDisplay();
    
    // Update position count in sidebar
    updateActivePositionCount();
};

// Remove entire position
window.removePosition = function removePosition(positionKey) {
    delete window.globalPositions[positionKey];
    
    // Remove all related lots from activeLots
    window.activeLots = window.activeLots.filter(lot => {
        const lotKey = `${lot.strike}-${lot.expiry}-${lot.key}`;
        return lotKey !== positionKey;
    });
    
    console.log(`[REMOVE POSITION] Removed position: ${positionKey}`);
    
    // Update all displays
    updateActiveTradesTable();
    updateClosedTradesTable();
    createPayoffChartFromOptionChain();
    updateActivePositionCount();
};

// Update active position count in sidebar
function updateActivePositionCount() {
    const countEl = document.getElementById('activePositionCount');
    if (countEl) {
        const count = Object.keys(window.globalPositions || {}).length;
        countEl.textContent = count;
    }
}

// Expose all critical functions to global scope for preservation
window.handleButtonClick = handleButtonClick;
window.updateRealizedPnLDisplay = updateRealizedPnLDisplay;
window.getCurrentLTP = getCurrentLTP;
window.updateActiveTradesTable = updateActiveTradesTable;
window.updateClosedTradesTable = updateClosedTradesTable;
window.createPayoffChartFromOptionChain = createPayoffChartFromOptionChain;
window.initPayoffChart = initPayoffChart;
window.updateMarginInfo = updateMarginInfo;

// Initialize chart when document loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initPayoffChart();
        console.log('Modern Option Trader - All systems initialized');
    }, 1000);
});

{% endblock %}