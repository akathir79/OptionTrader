<!-- templates/live_trade.html -->
{% extends "base.html" %}
{% block title %}Live Trading Platform{% endblock %}

{% block content %}



<style>
/* ATM Strike Highlighting Styles */
.atm-strike-highlight {
  background-color: rgba(255, 193, 7, 0.3) !important;
  border: 1px solid #ffc107 !important;
}

.atm-strike-highlight:hover {
  background-color: rgba(255, 193, 7, 0.5) !important;
}

/* ATM Controls Styling */
#atmCheckbox {
  margin-right: 5px;
}

#atmDisplay {
  font-family: 'Courier New', monospace;
  letter-spacing: 0.5px;
}

/* ITM/OTM Color Coding */
.itm-call {
  background-color: #fff3cd !important; /* Light yellow for ITM calls */
}

.otm-call {
  background-color: #ffffff !important; /* White for OTM calls */
}

.itm-put {
  background-color: #fff3cd !important; /* Light yellow for ITM puts */
}

.otm-put {
  background-color: #ffffff !important; /* White for OTM puts */
}

/* Strike distance indicator */
.strike-distance {
  font-size: 8px;
  color: #6c757d;
  display: block;
  margin-top: 2px;
}

/* Market Data Carousel Styles */
.carousel-container {
  overflow: hidden;
  width: 100%;
  position: relative;
}

#marketDataCarousel {
  display: flex;
  width: 700%; /* 7 pages Ã— 100% each */
  transition: transform 0.3s ease;
}

.carousel-page {
  flex-shrink: 0;
  width: 14.2857%; /* Each page takes 1/7 of the total carousel width */
  min-width: 14.2857%;
}

/* Saved Tables Icon Button Styles */
.saved-tables-controls .btn {
  transition: all 0.2s ease;
  border-radius: 6px;
  padding: 6px 10px;
  margin: 0 2px;
}

.saved-tables-controls .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.saved-tables-controls .btn i {
  font-size: 14px;
}

.saved-tables-controls .btn-primary:hover {
  background-color: #0056b3;
  border-color: #004085;
}

.saved-tables-controls .btn-success:hover {
  background-color: #218838;
}

/* Position Highlighting Styles for Three-Card Synchronization */
.position-highlight {
  background-color: rgba(13, 110, 253, 0.1) !important;
  border-left: 3px solid #0d6efd !important;
}

.position-active {
  background-color: rgba(13, 110, 253, 0.2) !important;
  font-weight: bold !important;
  border: 1px solid #0d6efd !important;
}

.position-highlight:hover {
  background-color: rgba(13, 110, 253, 0.15) !important;
}

/* Payoff Chart Fullscreen Styles */
.payoff-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.payoff-fullscreen .card-body {
  height: calc(100vh - 60px) !important;
  overflow-y: auto;
}

.payoff-fullscreen #chartContainer {
  height: calc(100vh - 300px) !important;
  min-height: 400px;
}

.payoff-fullscreen-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998;
  display: none;
}

.fullscreen-exit-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10000;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
}

.fullscreen-exit-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Option Chain Fullscreen Styles */
.option-chain-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.option-chain-fullscreen .card-body {
  height: calc(100vh - 120px) !important;
  overflow: auto;
}

.option-chain-fullscreen .table-container {
  height: calc(100vh - 140px) !important;
  overflow: auto;
}

/* Clean B/S Button Styles - Match original design */
.option_button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 4px;
  height: 16px;
  font-size: 9px;
  border: 1px solid;
  border-radius: 2px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
  min-width: 14px;
  font-weight: normal;
}

.option_button:hover {
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 40px;
  text-align: center;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #28a745;
  border-color: #28a745;
  background: #fff;
}

.buy_button:hover {
  background: #28a745;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: #fff;
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

/* Count Badge and Dropdown Menu Styles */
.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Option Chain Table Enhanced Styling */
.option-chain-content {
  position: relative;
}

.saved-tables-controls .btn-danger:hover {
  background-color: #c82333;
  border-color: #bd2130;
}

.saved-tables-controls .btn-info:hover {
  background-color: #138496;
  border-color: #117a8b;
}

/* Enhanced Live Trading Styling */
.card {
  border: none;
  border-radius: 8px;
}

.card-header {
  border-radius: 8px 8px 0 0 !important;
  font-weight: 600;
}

.option_button {
  display: none;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 6px;
  height: 20px;
  font-size: 10px;
  border: 1px solid;
  border-radius: 3px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
}

.option_button:hover {
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transform: translateY(-1px);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 60px;
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 2px !important;
}

/* Four Tab Styles */
.option-chain-tab-pane {
  display: none;
}

.option-chain-tab-pane.active {
  display: block;
}

.active-option-tab {
  background-color: #fff !important;
  color: #000 !important;
  border-color: #fff !important;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #198754;
  border-color: #198754;
  background: rgba(25, 135, 84, 0.1);
}

.buy_button:hover {
  background: #198754;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.1);
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Expiry buttons */
.expiry_button {
  display: inline-block;
  padding: 4px 8px;
  margin: 2px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  font-size: 11px;
  transition: all 0.2s;
}

.expiry_button:hover {
  background: #e9ecef;
  border-color: #007bff;
}

.expiry_button.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

/* Buy/Sell button styling - using attached code approach */
.option_button {
  display: none;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 0 10px;
  height: 28px;
  font-size: 12px;
  border: 1px solid;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  margin: 0 5px;
  transition: 0.3s;
}

.option_button:hover {
  box-shadow: 0 0 5px -1px rgba(0, 0, 0, 0.5);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.5rem !important;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #03b760;
  border-color: #03b760;
}

.sell_button {
  color: #ef6161;
  border-color: #ef6161;
}

.count_badge {
  display: none;
  position: absolute;
  top: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  line-height: 18px;
  text-align: center;
  font-size: 11px;
  color: #fff;
  border-radius: 50%;
}

.buy_button .count_badge {
  background: #03b760;
}

.sell_button .count_badge {
  background: #ef6161;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 12px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 12px;
}

.dropdown_menu button:hover {
  background: #f2f2f2;
}

/* Position table enhancements */
.position-row {
  transition: background-color 0.2s;
}

.position-row:hover {
  background-color: rgba(0,123,255,0.1);
}

/* Option Chain Table Header Styling */
#optionChainTable thead {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 2px solid #dee2e6;
  font-size: 10px; /* Reduced font size for better look and feel */
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #333;
}

#optionChainTable thead th {
  padding: 8px 6px;
  text-align: center;
  border-right: 1px solid #e9ecef;
  white-space: nowrap;
}

#optionChainTable thead th:last-child,
#optionChainTable thead th:first-child {
  border-right: none;
}

#optionChainTable th[style*="background-color: #f39c12"] {
  background: #f39c12 !important;
  color: #fff !important;
  font-weight: 700;
}

/* Enhanced Option Chain Table Professional Styling */
#optionChainTable {
  border-collapse: collapse;
  width: 100%;
  font-size: 11px;
  border: 1px solid #dee2e6;
}

#optionChainTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

/* Enhanced table body styling */
#optionChainTable tbody tr {
  border-bottom: 1px solid #f1f3f4;
  transition: background-color 0.15s ease;
}

#optionChainTable tbody tr:hover {
  background-color: #f8f9fa;
}

#optionChainTable tbody tr:nth-child(even) {
  background-color: #fafafa;
}

#optionChainTable tbody tr:nth-child(even):hover {
  background-color: #f0f0f0;
}

#optionChainTable tbody td {
  padding: 4px 6px;
  text-align: center;
  border-right: 1px solid #f1f3f4;
  white-space: nowrap;
  font-size: 10px;
  line-height: 1.4;
}

#optionChainTable tbody td:last-child {
  border-right: none;
}

/* Remove ATM highlighting */
#optionChainTable .atm-strike {
  background-color: inherit !important;
}

/* Strike column enhancement */
#optionChainTable tbody td:nth-child(20) {
  font-weight: 600;
  background-color: #fff3cd;
  border-left: 2px solid #f39c12;
  border-right: 2px solid #f39c12;
}

/* ITM styling with yellow color for calls and puts */
.itm-call {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM calls */
}

.itm-put {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM puts */
}

/* Maintain hover effects for ITM rows */
.itm-call:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

.itm-put:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .card-body {
    padding: 0.75rem;
  }

  .option_button {
    height: 18px;
    font-size: 9px;
    padding: 1px 4px;
  }

  #chartContainer {
    height: 250px !important;
  }
}

/* Live data indicator animation */
@keyframes pulse {
  0% { background-color: #6c757d; }
  50% { background-color: #28a745; }
  100% { background-color: #6c757d; }
}

.badge.bg-secondary {
  animation: pulse 2s infinite;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<!-- Live Trading Container with Enhanced Bootstrap Design -->
<div class="container-fluid py-3">
  <!-- Resizable Layout Container -->
  <div class="resizable-container">
    <!-- Left Panel - Symbol Selection & Option Chain -->
    <div class="resizable-panel left-panel">
      <!-- Symbol Selection & Expiry Dates Card -->
      <div class="card shadow-sm mb-2">
        <div class="card-body">
          <!-- Symbol Selection Row -->
          <div class="row g-2 align-items-center mb-3">
            <!-- Index Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 50px;">Index:</label>
              <select id="indexSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Index</option>
                <optgroup label="NSE">
                  <option value="NIFTY" selected>NIFTY 50</option>
                  <option value="BANKNIFTY">BANK NIFTY</option>
                  <option value="FINNIFTY">FIN NIFTY</option>
                  <option value="MIDCPNIFTY">MIDCAP NIFTY</option>
                </optgroup>
                <optgroup label="BSE">
                  <option value="SENSEX">SENSEX</option>
                  <option value="BANKEX">BANKEX</option>
                </optgroup>
              </select>
            </div>

            <!-- Exchange Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 70px;">Exchange:</label>
              <select id="exchangeSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Exchange</option>
                <option value="NSE">NSE</option>
                <option value="BSE">BSE</option>
                <option value="MCX">MCX</option>
                <option value="Crypto">Crypto</option>
                <option value="NSEâ€“Commodity">NSE Commodity</option>
              </select>
            </div>

            <!-- Symbol Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 55px;">Symbol:</label>
              <select id="extraSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Symbol</option>
              </select>
            </div>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Expiry Dates Row -->
          <div class="d-flex align-items-center mb-3">
            <label class="form-label small fw-semibold me-3 mb-0" style="min-width: 80px;">
              <i class="fas fa-calendar-alt me-1"></i>Expiry:
            </label>
            <button id="expiryPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden">
              <div id="expiryViewerCarousel" class="d-flex gap-2 transition-all" style="transition: transform 0.3s ease;">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            <button id="expiryNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Market Data Carousel -->
          <div class="d-flex align-items-center">
            <button id="marketDataPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden carousel-container">
              <div id="marketDataCarousel" class="d-flex" style="transition: transform 0.3s ease; width: 700%;">
                <!-- Page 1: Primary Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Spot Price:</small>
                      <strong id="spotPrice" class="text-muted">Select Symbol</strong>
                      <i id="chartIcon" class="fas fa-chart-line text-primary ms-2" 
                         style="cursor: pointer; font-size: 14px; display: none;" 
                         title="Open Candlestick Chart"
                         onclick="openCandlestickChart()"></i>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Open:</small><strong class="text-secondary">23,649</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Future:</small><strong class="text-secondary">23,700</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">VIX:</small><strong class="text-warning">14.56</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 2: Extended Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Day High:</small><strong class="text-success">23,850</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Low:</small><strong class="text-danger">23,420</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Volume:</small><strong class="text-secondary">2.5M</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">OI:</small><strong class="text-secondary">1.8M</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 3: Additional Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Prev Close:</small><strong class="text-secondary">23,590</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change:</small><strong class="text-success">+18</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change %:</small><strong class="text-success">+0.08%</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">LTP:</small><strong class="text-muted">--</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 4: Options Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">PCR:</small><strong class="text-info">0.85</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Max Pain:</small><strong class="text-secondary">23,600</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Call OI:</small><strong class="text-success">12.5L</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Put OI:</small><strong class="text-danger">10.6L</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 5: Technical Indicators -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">RSI:</small><strong class="text-warning">62.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">MACD:</small><strong class="text-success">+15.2</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">EMA 20:</small><strong class="text-secondary">23,580</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">SMA 50:</small><strong class="text-secondary">23,520</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 6: Market Sentiment -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">FII Net:</small><strong class="text-success">+450Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">DII Net:</small><strong class="text-danger">-120Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">ADX:</small><strong class="text-info">28.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Bollinger:</small><strong class="text-secondary">Mid</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 7: Performance Metrics -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">52W High:</small><strong class="text-success">25,980</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">52W Low:</small><strong class="text-danger">19,280</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Beta:</small><strong class="text-secondary">1.05</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Avg Vol:</small><strong class="text-secondary">3.2M</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button id="marketDataNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Option Chain Card (Single Table) -->
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <!-- ATM Display Only - No checkbox -->
            <div class="d-flex align-items-center gap-2">
              <span id="atmDisplay" class="badge bg-warning text-dark" style="font-size: 10px; min-width: 50px; display: none;">
                ATM
              </span>
            </div>
            <!-- Strike Count Dropdown -->
            <div class="d-flex align-items-center gap-2">
              <label for="strikeCountSelect" class="form-label mb-0 text-light" style="font-size: 11px; font-weight: 500;">Strike Count:</label>
              <select id="strikeCountSelect" class="form-select form-select-sm" style="width: 80px; font-size: 11px;">
                <option value="5">5</option>
                <option value="7">7</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="ALL">ALL</option>
              </select>
            </div>
            <span id="fyersSymbolDisplay" class="d-none" style="font-size: 10px; color: #6c757d; font-weight: 500;">
              <span id="fyersSymbolText">NSE:NIFTY50-INDEX</span>
            </span>
          </div>
          <div class="d-flex align-items-center gap-3">
            <div id="selectedDetailsDisplay" style="font-size: 11px; color: #adb5bd; font-weight: 500;">
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="refreshBtn" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;">
                <i class="fas fa-sync"></i>
              </button>
              <button id="fullscreenOptionChain" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
              <div id="liveDataControls" class="d-flex align-items-center gap-2">
              <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle p-1" type="button" id="columnVisibilityDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="height: 30px; font-size: 11px;" title="Column Visibility">
                  <i class="fas fa-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="columnVisibilityDropdown" style="min-width: 250px; max-height: 400px; overflow-y: auto;">
                  <li><h6 class="dropdown-header">Column Visibility</h6></li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3 py-1">
                    <div class="d-flex gap-2 mb-2">
                      <button id="selectAllColumns" class="btn btn-success btn-sm flex-fill" style="font-size: 10px;">Select All</button>
                      <button id="deselectAllColumns" class="btn btn-secondary btn-sm flex-fill" style="font-size: 10px;">Clear All</button>
                      <button id="resetToDefaults" class="btn btn-primary btn-sm flex-fill" style="font-size: 10px;">Defaults</button>
                    </div>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3">
                    <div class="row" style="font-size: 11px;">
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="16" id="col16"><label class="form-check-label" for="col16">CE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="17" id="col17"><label class="form-check-label" for="col17">CE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="15" id="col15"><label class="form-check-label" for="col15">CE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="14" id="col14"><label class="form-check-label" for="col14">CE OI</label></div>
                      </div>
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="21" id="col21"><label class="form-check-label" for="col21">PE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="22" id="col22"><label class="form-check-label" for="col22">PE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="23" id="col23"><label class="form-check-label" for="col23">PE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="24" id="col24"><label class="form-check-label" for="col24">PE OI</label></div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
                <span id="liveDataStatus" style="font-size: 12px; color: #6c757d;">
                  <i class="fas fa-circle text-secondary"></i> Live Data Ready
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Single Option Chain Navigation -->
        <div class="card-header bg-secondary text-white p-2 border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1" style="font-size: 12px;">
            <span class="text-light" style="font-size: 11px; font-weight: 500;">
              Option Chain
            </span>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Loading Indicator -->
          <div id="optionChainLoading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">
              <small class="text-muted">Loading option chain data...</small>
            </div>
          </div>
          <!-- Single Option Chain Table -->
          <div id="optionChainContainer" style="max-height: 60vh; overflow-y: auto;">

            <div class="table-container">
              <table class="table table-sm mb-0" id="optionChainTable">
                <thead>
                  <tr>
                    <th>CE B/S</th>
                    <th>Veta</th>
                    <th>Volga</th>
                    <th>Charm</th>
                    <th>Vanna</th>
                    <th>Vega</th>
                    <th>Theta</th>
                    <th>Gamma</th>
                    <th>Chng</th>
                    <th>Bid Qty</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Ask Qty</th>
                    <th>Chng in OI</th>
                    <th>OI</th>
                    <th>Vol</th>
                    <th>Chart</th>
                    <th>LTP</th>
                    <th>Î”</th>
                    <th style="background-color: #f39c12; color: #000;">Strike</th>
                    <th>Î”</th>
                    <th>LTP</th>
                    <th>Chart</th>
                    <th>Vol</th>
                    <th>OI</th>
                    <th>Chng in OI</th>
                    <th>Ask Qty</th>
                    <th>Ask</th>
                    <th>Bid</th>
                    <th>Bid Qty</th>
                    <th>Chng</th>
                    <th>Gamma</th>
                    <th>Theta</th>
                    <th>Vega</th>
                    <th>Vanna</th>
                    <th>Charm</th>
                    <th>Volga</th>
                    <th>Veta</th>
                    <th>PE B/S</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resizable Separator -->
    <div class="resizer"></div>

    <!-- Right Panel - Charts & Trading -->
    <div class="resizable-panel right-panel">
      <!-- Enhanced Saved Tables Control with Broker Management (Responsive Fixed) -->
      <div class="mb-1 p-2 bg-light rounded">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <!-- Left Side: Saved Tables Controls -->
          <div class="d-flex align-items-center gap-2 saved-tables-controls flex-shrink-0">
            <label for="savedTablesSelect" class="form-label mb-0 me-1" style="white-space: nowrap; font-size: 12px;">Saved Tables:</label>
            <select id="savedTablesSelect" class="form-select form-select-sm" style="min-width: 120px; max-width: 150px;">
              <option value="">-- Select Saved Table --</option>
            </select>
            <div class="btn-group" role="group">
              <button id="addNewBtn" class="btn btn-primary btn-sm" title="Add New Table">
                <i class="fas fa-plus"></i>
              </button>
              <button id="saveBtn" class="btn btn-success btn-sm" title="Save Table">
                <i class="fas fa-save"></i>
              </button>
              <button id="deleteBtn" class="btn btn-danger btn-sm" title="Delete Table">
                <i class="fas fa-trash"></i>
              </button>
              <button id="newTabBtn" class="btn btn-info btn-sm" title="Open Selected in New Tab">
                <i class="fas fa-external-link-alt"></i>
              </button>
              <button id="viewBasketBtn" class="btn btn-secondary btn-sm" title="View Strategy Basket" onclick="window.location.href='/basket'">
                <i class="fas fa-shopping-basket"></i>
              </button>
            </div>
          </div>

          <!-- Broker Management - Enhanced Visual -->
          <div class="d-flex align-items-center gap-2 broker-management-controls flex-shrink-0">
            <!-- User Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="userSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">User:</label>
              <select id="userSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
            </div>

            <!-- Broker Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="brokerSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">Broker:</label>
              <select id="brokerSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
              <span id="tokenStatus" class="badge bg-secondary ms-1" style="font-size: 10px; white-space: nowrap; padding: 4px 6px;">No Token</span>
            </div>

            <!-- Token Management -->
            <div class="btn-group ms-2" role="group">
              <button id="createTokenBtn" class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Create New Token">
                <i class="fas fa-key me-1"></i>Create
              </button>
              <button id="refreshTokenBtn" class="btn btn-outline-warning btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Refresh Token">
                <i class="fas fa-sync me-1"></i>Refresh
              </button>
              <button id="brokerSettingsBtn" class="btn btn-outline-dark btn-sm" style="padding:4px 8px;font-size:11px;" title="Manage Broker Credentials">
                <i class="fas fa-user-cog me-1"></i>Broker Settings
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Tabs - Compact Single Line -->
      <div class="card shadow-sm">
        <div class="card-header p-2 bg-white border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1 flex-wrap" style="font-size: 13px;">
            <button class="btn btn-sm btn-primary active-tab-btn" id="payoff-tab" data-bs-toggle="tab" data-bs-target="#payoff-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Payoff Chart
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="mtm-tab" data-bs-toggle="tab" data-bs-target="#mtm-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              MTM
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Strategy
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="oi-tab" data-bs-toggle="tab" data-bs-target="#oi-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              OI
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="rolling-tab" data-bs-toggle="tab" data-bs-target="#rolling-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Rolling Straddle
            </button>
            <div class="ms-auto d-flex align-items-center gap-2">
              <label class="form-check-label" for="payoffSettings" style="font-size: 11px;">
                <input class="form-check-input" type="checkbox" id="payoffSettings"> Payoff Settings
              </label>
              <button id="togglePayoffView" class="btn btn-outline-secondary btn-sm" title="Hide/Show Payoff Chart">
                <i class="fas fa-chevron-up"></i>
              </button>
              <button id="fullscreenPayoff" class="btn btn-outline-primary btn-sm" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="payoffCardBody" class="card-body p-0">
          <div class="tab-content" id="analysisTabContent">
            <!-- Payoff Chart Tab Content -->
            <div class="tab-pane fade show active" id="payoff-content" role="tabpanel">
              <div class="p-3">

      <!-- Payoff Chart Content (Hideable) -->
      <div id="payoffChartContent">
        <!-- Risk Metrics - Label Top, Value Bottom -->
        <div class="mb-2 py-1">
          <div class="d-flex justify-content-between align-items-start flex-wrap" style="font-size: 12px;">
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Req. Margin</div>
              <div id="marginValue" class="fw-bold text-primary">â‚¹3,391 <span class="text-muted">â–¡</span></div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P&L</div>
              <div id="pnlValue" class="fw-bold text-success">â‚¹0 (0.00)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Profit</div>
              <div id="maxProfitValue" class="fw-bold text-success">â‚¹11,493 (1.3%)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Loss</div>
              <div id="maxLossValue" class="fw-bold text-danger">(Unlimited)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P.O.P.</div>
              <div id="popValue" class="fw-bold text-info">55.24%</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Net Credit</div>
              <div id="netCreditValue" class="fw-bold text-success">â‚¹11,487.5</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Breakeven</div>
              <div id="breakevenValue" class="fw-bold text-warning">26037 (+ 0.5%), 24902 (- 1.5%)</div>
            </div>
          </div>
        </div>

        <!-- Payoff Chart - No Header -->
        <div class="mb-3">
          <div id="chartContainer" style="width: 100%; height: 350px; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #fff;"></div>
        </div>
      </div>

      <!-- Current Positions Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 me-3">
              <i class="fas fa-briefcase me-2"></i>Current Positions
            </h6>
            <div id="brokerInfo" class="small text-white-75" style="display: none;">
              <span id="selectedBrokerName">No Broker Selected</span>
              <span class="mx-2">|</span>
              <span id="selectedBrokerUserId">No User ID</span>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button id="clearAllBtn" class="btn btn-outline-light btn-sm">
              <i class="fas fa-trash me-1"></i>Clear All
            </button>
            <span id="positionCount" class="badge bg-light text-dark">0 Positions</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm mb-0" style="font-size: 11px;">
              <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <tr>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">
                    <input type="checkbox" id="selectAllPositions" style="transform: scale(0.8);">
                  </th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 35px; text-align: center;">Type</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">Action</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Lots</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Qty</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Trade Date/Time</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Strike</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Expiry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 60px; text-align: center;">Entry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">LTP</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Delta</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">P&L</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Lots Exit</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Lock In</th>
                  <th style="padding: 8px 6px; width: 40px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="positionTableBody">
                <tr>
                  <td colspan="15" class="text-center text-muted py-3">
                    <i class="fas fa-plus-circle me-2"></i>No positions yet. Start trading!
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Position Table Footer with Controls -->
          <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 11px;">
            <div class="d-flex align-items-center gap-2">
              <span>Multiplier:</span>
              <select class="form-select form-select-sm" style="width: 60px; font-size: 10px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <span>Lot Size: 75</span>
              <button class="btn btn-outline-primary btn-sm" style="padding: 2px 8px; font-size: 10px;">Add Alert</button>
              <button class="btn btn-outline-success btn-sm" style="padding: 2px 8px; font-size: 10px;">Save</button>
              <button class="btn btn-outline-info btn-sm" style="padding: 2px 8px; font-size: 10px;">Share</button>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span id="totalDelta" class="text-info" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <span id="totalPnLSummary" class="text-success" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <span class="text-danger">Exit</span>
              <button class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; font-size: 10px;">Clear</button>
            </div>
          </div>
        </div>
      </div>

              </div>
            </div>

            <!-- MTM Tab Content -->
            <div class="tab-pane fade" id="mtm-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-calculator fa-3x mb-3"></i>
                  <h5>MTM Analysis</h5>
                  <p>Mark-to-market analysis and real-time P&L tracking will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Strategy Tab Content -->
            <div class="tab-pane fade" id="strategy-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chess fa-3x mb-3"></i>
                  <h5>Strategy Builder</h5>
                  <p>Advanced strategy creation and backtesting tools will be available here.</p>
                </div>
              </div>
            </div>

            <!-- OI Tab Content -->
            <div class="tab-pane fade" id="oi-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chart-bar fa-3x mb-3"></i>
                  <h5>Open Interest Analysis</h5>
                  <p>Open interest charts and PCR analysis will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Rolling Straddle Tab Content -->
            <div class="tab-pane fade" id="rolling-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-sync-alt fa-3x mb-3"></i>
                  <h5>Rolling Straddle</h5>
                  <p>Rolling straddle analysis and optimization tools will be available here.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Hidden Loader Template -->
<div id="loaderTemplate" style="display:none;">
  <div class="d-flex justify-content-center">
    <div class="spinner-border spinner-border-sm text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Include Resizable Layout CSS -->
<link href="{{ url_for('static', filename='css/resizable.css') }}" rel="stylesheet">

<!-- Option Chain Styling for WebSocket -->
<style>
  /* ATM Strike Highlighting */
  .atm-strike {
    background-color: #ffc107 !important;
    font-weight: bold;
  }
  
  .atm-strike td {
    background-color: #ffc107 !important;
    color: #000 !important;
  }
  
  /* ITM/OTM Styling - Subtle yellow for ITM like the reference image */
  .call-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .call-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  .put-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .put-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  /* Strike Price Column */
  .strike-price {
    background-color: #495057 !important;
    color: #fff !important;
    font-weight: bold;
  }
  
  /* Spot Price Animation */
  .spot-price-updated {
    animation: priceFlash 0.5s ease-in-out;
  }
  
  @keyframes priceFlash {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
  }
</style>

<!-- *** NEW: symbol / expiry logic *** -->
<script src="{{ url_for('static', filename='js/symbol_selector_fixed.js') }}"></script>
<script src="{{ url_for('static', filename='js/websocket_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/option_microchart.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart_popup.js') }}"></script>
<script src="{{ url_for('static', filename='js/candlestick_chart.js') }}"></script>


<!-- Highcharts (Pay-off chart) -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/stock.js"></script>

<!-- Resizable layout behaviour -->
<script src="{{ url_for('static', filename='js/resizable.js') }}"></script>

<!-- Chart controller (pay-off & option-chain fullscreen) -->
<script src="{{ url_for('static', filename='js/chart_controller.js') }}"></script>

<!-- Market data carousel -->
<script src="{{ url_for('static', filename='js/market_data_carousel.js') }}"></script>

<!-- Broker settings -->
<script src="{{ url_for('static', filename='js/broker_settings.js') }}"></script>

<script>
// Initialize components when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add World Clock button to payoff settings area
    setTimeout(() => {
        const payoffContainer = document.querySelector('.ms-auto.d-flex.align-items-center.gap-2');
        if (payoffContainer && !document.getElementById('worldClockBtn')) {
            const clockBtn = document.createElement('button');
            clockBtn.id = 'worldClockBtn';
            clockBtn.className = 'btn btn-warning btn-sm';
            clockBtn.title = 'World Market Times';
            clockBtn.innerHTML = '<i class="fas fa-clock me-1"></i>Markets';
            clockBtn.onclick = function() {
                if (window.marketClock) {
                    window.marketClock.showPopup();
                } else {
                    alert('Market clock not loaded. Please refresh the page.');
                }
            };
            
            // Insert before the first child (payoff settings)
            payoffContainer.insertBefore(clockBtn, payoffContainer.firstChild);
        }
        
        // Load market clock script if not already loaded
        if (!window.marketClock) {
            const script = document.createElement('script');
            script.src = '/static/js/market_clock.js';
            document.head.appendChild(script);
        }
    }, 1000);
    
    // Position tracking variables - using attached code approach
    const defaultLotSize = 75;
    const defaultLot = 1;
    let counters = [];
    let firstClickFlags = [];
    let payoffChart = null;
    
    // Initialize payoff chart
    function initPayoffChart() {
        const chartContainer = document.getElementById('payoffChart');
        if (chartContainer) {
            payoffChart = Highcharts.chart('payoffChart', {
                chart: { type: 'area', height: 300 },
                title: { text: 'Multi-Leg Payoff Chart' },
                xAxis: { 
                    title: { text: 'Underlying Price' }, 
                    crosshair: true 
                },
                yAxis: { 
                    title: { text: 'Net P&L (â‚¹)' },
                    plotLines: [{
                        value: 0,
                        color: '#000',
                        width: 1,
                        zIndex: 4
                    }]
                },
                tooltip: { 
                    valuePrefix: 'â‚¹',
                    valueDecimals: 2
                },
                plotOptions: {
                    area: {
                        marker: { enabled: false },
                        zoneAxis: 'y',
                        zones: [{
                            value: 0,
                            color: '#ff4444',
                            fillColor: 'rgba(255, 68, 68, 0.1)'
                        }, {
                            color: '#44ff44',
                            fillColor: 'rgba(68, 255, 68, 0.1)'
                        }]
                    }
                },
                series: [{ 
                    name: 'Net P&L', 
                    data: [],
                    color: '#007bff'
                }],
                credits: { enabled: false }
            });
        }
    }
    
    // Create Buy/Sell button with badge - using attached code approach
    function createOptionButton(rowIndex, key, label, extraClass) {
        const div = document.createElement('div');
        div.className = `option_button ${extraClass}`;
        div.id = `${key}Btn_${rowIndex}`;
        div.textContent = label + ' ';
        
        // The numeric badge that shows how many lots
        const badge = document.createElement('span');
        badge.className = 'count_badge';
        badge.id = `${key}Badge_${rowIndex}`;
        badge.textContent = '0';
        div.appendChild(badge);
        
        // Dropdown menu
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown_menu';
        dropdown.id = `${key}Menu_${rowIndex}`;
        
        const addBtn = document.createElement('button');
        addBtn.textContent = '+ Add';
        addBtn.onclick = (e) => {
            e.stopPropagation();
            handleButtonClick(rowIndex, key, 'add');
        };
        
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '- Remove';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            handleButtonClick(rowIndex, key, 'remove');
        };
        
        dropdown.appendChild(addBtn);
        dropdown.appendChild(removeBtn);
        div.appendChild(dropdown);
        
        // Main click handler
        div.onclick = (e) => {
            e.stopPropagation();
            if (firstClickFlags[rowIndex][key]) {
                handleButtonClick(rowIndex, key, 'add');
                firstClickFlags[rowIndex][key] = false;
            } else {
                toggleDropdown(rowIndex, key);
            }
        };
        
        return div;
    }
    
    // Handle button clicks - create payoff chart immediately on click
    function handleButtonClick(rowIndex, key, action) {
        if (action === 'add') {
            counters[rowIndex][key]++;
        } else if (action === 'remove' && counters[rowIndex][key] > 0) {
            counters[rowIndex][key]--;
        }
        
        updateButtonDisplay(rowIndex, key);
        closeAllDropdowns();
        
        // Immediately create and update payoff chart using loaded option chain data
        createPayoffChartFromOptionChain();
        
        // Keep existing position table intact - just log the action
        console.log(`${action} ${key} for row ${rowIndex}, new count: ${counters[rowIndex][key]}`);
    }
    
    // Update button display - using attached code approach
    function updateButtonDisplay(rowIndex, key) {
        const count = counters[rowIndex][key];
        const button = document.getElementById(`${key}Btn_${rowIndex}`);
        const badge = document.getElementById(`${key}Badge_${rowIndex}`);
        
        if (button && badge) {
            badge.textContent = count;
            if (count > 0) {
                button.classList.add('active');
                badge.style.display = 'block';
            } else {
                button.classList.remove('active');
                badge.style.display = 'none';
                firstClickFlags[rowIndex][key] = true;
            }
        }
    }
    
    // Toggle dropdown - using attached code approach
    function toggleDropdown(rowIndex, key) {
        closeAllDropdowns();
        const menu = document.getElementById(`${key}Menu_${rowIndex}`);
        if (menu) {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
    }
    
    // Close all dropdowns
    function closeAllDropdowns() {
        document.querySelectorAll('.dropdown_menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
    
    // Update payoff chart - using attached code approach
    function updatePayoffChart() {
        if (!payoffChart) return;
        
        const legs = [];
        
        // Iterate through all rows and their counters
        counters.forEach((rowCounters, rowIndex) => {
            if (!rowCounters) return;
            
            // Get strike and premiums from the table row
            const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
            if (!row) return;
            
            const strikeTd = row.children[19]; // Strike column
            const strike = parseFloat(strikeTd?.textContent || 0);
            if (strike === 0) return;
            
            // CE Buy
            if (rowCounters.ceBuy > 0) {
                const ltpTd = row.children[17]; // CE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'CE',
                        action: 'Buy',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.ceBuy,
                        qty: rowCounters.ceBuy * defaultLotSize
                    });
                }
            }
            
            // CE Sell
            if (rowCounters.ceSell > 0) {
                const ltpTd = row.children[17]; // CE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'CE',
                        action: 'Sell',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.ceSell,
                        qty: rowCounters.ceSell * defaultLotSize
                    });
                }
            }
            
            // PE Buy
            if (rowCounters.peBuy > 0) {
                const ltpTd = row.children[21]; // PE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'PE',
                        action: 'Buy',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.peBuy,
                        qty: rowCounters.peBuy * defaultLotSize
                    });
                }
            }
            
            // PE Sell
            if (rowCounters.peSell > 0) {
                const ltpTd = row.children[21]; // PE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'PE',
                        action: 'Sell',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.peSell,
                        qty: rowCounters.peSell * defaultLotSize
                    });
                }
            }
        });
        
        if (legs.length === 0) {
            payoffChart.series[0].setData([], true);
            updateMarginInfo(0, 0, 0);
            return;
        }
        
        // Calculate payoff curve
        const allStrikes = legs.map(leg => leg.strike);
        const minStrike = Math.min(...allStrikes) - 500;
        const maxStrike = Math.max(...allStrikes) + 500;
        const step = Math.max(5, Math.floor((maxStrike - minStrike) / 200));
        
        const payoffData = [];
        let netCredit = 0;
        let maxProfit = -Infinity;
        let maxLoss = Infinity;
        
        // Calculate net credit/debit
        legs.forEach(leg => {
            const credit = leg.action === 'Sell' ? leg.premium * leg.qty : -leg.premium * leg.qty;
            netCredit += credit;
        });
        
        for (let spotPrice = minStrike; spotPrice <= maxStrike; spotPrice += step) {
            let totalPayoff = netCredit; // Start with net credit/debit
            
            legs.forEach(leg => {
                let optionValue = 0;
                
                if (leg.type === 'CE') {
                    optionValue = Math.max(0, spotPrice - leg.strike);
                } else { // PE
                    optionValue = Math.max(0, leg.strike - spotPrice);
                }
                
                if (leg.action === 'Buy') {
                    totalPayoff += (optionValue - leg.premium) * leg.qty;
                } else { // Sell
                    totalPayoff += (leg.premium - optionValue) * leg.qty;
                }
            });
            
            payoffData.push([spotPrice, totalPayoff]);
            maxProfit = Math.max(maxProfit, totalPayoff);
            maxLoss = Math.min(maxLoss, totalPayoff);
        }
        
        payoffChart.series[0].setData(payoffData, true);
        updateMarginInfo(netCredit, maxProfit, maxLoss);
    }
    
    // Create payoff chart from loaded option chain data - step by step on button click
    function createPayoffChartFromOptionChain() {
        if (!payoffChart) {
            initPayoffChart();
        }
        
        if (!payoffChart) return;
        
        const legs = [];
        let totalPositions = 0;
        
        // Read directly from the loaded option chain table
        const tableRows = document.querySelectorAll('#optionChainTable tbody tr');
        
        tableRows.forEach((row, rowIndex) => {
            if (!counters[rowIndex]) return;
            
            // Get strike price from the table (column 19 = strike column)
            const strikeTd = row.children[19];
            if (!strikeTd) return;
            
            const strike = parseFloat(strikeTd.textContent.trim());
            if (isNaN(strike) || strike === 0) return;
            
            // Get CE LTP (column 17) and PE LTP (column 21) from the loaded table
            const ceLtpTd = row.children[17];
            const peLtpTd = row.children[21];
            
            const ceLtp = ceLtpTd ? parseFloat(ceLtpTd.textContent.trim()) : 0;
            const peLtp = peLtpTd ? parseFloat(peLtpTd.textContent.trim()) : 0;
            
            // CE Buy positions
            if (counters[rowIndex].ceBuy > 0 && ceLtp > 0) {
                legs.push({
                    type: 'CE',
                    action: 'Buy',
                    strike: strike,
                    premium: ceLtp,
                    lots: counters[rowIndex].ceBuy,
                    qty: counters[rowIndex].ceBuy * defaultLotSize
                });
                totalPositions += counters[rowIndex].ceBuy;
                console.log(`Added CE Buy: Strike ${strike}, Premium ${ceLtp}, Lots ${counters[rowIndex].ceBuy}`);
            }
            
            // CE Sell positions
            if (counters[rowIndex].ceSell > 0 && ceLtp > 0) {
                legs.push({
                    type: 'CE',
                    action: 'Sell',
                    strike: strike,
                    premium: ceLtp,
                    lots: counters[rowIndex].ceSell,
                    qty: counters[rowIndex].ceSell * defaultLotSize
                });
                totalPositions += counters[rowIndex].ceSell;
                console.log(`Added CE Sell: Strike ${strike}, Premium ${ceLtp}, Lots ${counters[rowIndex].ceSell}`);
            }
            
            // PE Buy positions
            if (counters[rowIndex].peBuy > 0 && peLtp > 0) {
                legs.push({
                    type: 'PE',
                    action: 'Buy',
                    strike: strike,
                    premium: peLtp,
                    lots: counters[rowIndex].peBuy,
                    qty: counters[rowIndex].peBuy * defaultLotSize
                });
                totalPositions += counters[rowIndex].peBuy;
                console.log(`Added PE Buy: Strike ${strike}, Premium ${peLtp}, Lots ${counters[rowIndex].peBuy}`);
            }
            
            // PE Sell positions
            if (counters[rowIndex].peSell > 0 && peLtp > 0) {
                legs.push({
                    type: 'PE',
                    action: 'Sell',
                    strike: strike,
                    premium: peLtp,
                    lots: counters[rowIndex].peSell,
                    qty: counters[rowIndex].peSell * defaultLotSize
                });
                totalPositions += counters[rowIndex].peSell;
                console.log(`Added PE Sell: Strike ${strike}, Premium ${peLtp}, Lots ${counters[rowIndex].peSell}`);
            }
        });
        
        console.log(`Total legs created: ${legs.length}, Total positions: ${totalPositions}`);
        
        if (legs.length === 0) {
            // Clear chart if no positions
            payoffChart.series[0].setData([], true);
            updateMarginInfo(0, 0, 0);
            console.log('No positions found, chart cleared');
            return;
        }
        
        // Calculate payoff curve using real option chain data
        const allStrikes = legs.map(leg => leg.strike);
        const minStrike = Math.min(...allStrikes) - 500;
        const maxStrike = Math.max(...allStrikes) + 500;
        const step = Math.max(5, Math.floor((maxStrike - minStrike) / 200));
        
        const payoffData = [];
        let netCredit = 0;
        let maxProfit = -Infinity;
        let maxLoss = Infinity;
        
        // Calculate net credit/debit from real premiums
        legs.forEach(leg => {
            const credit = leg.action === 'Sell' ? leg.premium * leg.qty : -leg.premium * leg.qty;
            netCredit += credit;
        });
        
        console.log(`Net Credit/Debit: â‚¹${netCredit.toFixed(2)}`);
        
        // Generate payoff curve points
        for (let spotPrice = minStrike; spotPrice <= maxStrike; spotPrice += step) {
            let totalPayoff = netCredit; // Start with net credit/debit
            
            legs.forEach(leg => {
                let optionValue = 0;
                
                // Calculate intrinsic value
                if (leg.type === 'CE') {
                    optionValue = Math.max(0, spotPrice - leg.strike);
                } else { // PE
                    optionValue = Math.max(0, leg.strike - spotPrice);
                }
                
                // Calculate payoff based on position
                if (leg.action === 'Buy') {
                    totalPayoff += (optionValue - leg.premium) * leg.qty;
                } else { // Sell
                    totalPayoff += (leg.premium - optionValue) * leg.qty;
                }
            });
            
            payoffData.push([spotPrice, totalPayoff]);
            maxProfit = Math.max(maxProfit, totalPayoff);
            maxLoss = Math.min(maxLoss, totalPayoff);
        }
        
        // Update chart with real data
        payoffChart.series[0].setData(payoffData, true);
        updateMarginInfo(netCredit, maxProfit, maxLoss);
        
        console.log(`Payoff chart updated with ${payoffData.length} data points`);
        console.log(`Max Profit: â‚¹${maxProfit.toFixed(2)}, Max Loss: â‚¹${maxLoss.toFixed(2)}`);
    }
    
    // Update margin info display
    function updateMarginInfo(netCredit, maxProfit, maxLoss) {
        const netCreditEl = document.getElementById('netCreditValue');
        const maxProfitEl = document.getElementById('maxProfitValue');
        const maxLossEl = document.getElementById('maxLossValue');
        
        if (netCreditEl) {
            netCreditEl.textContent = `â‚¹${netCredit.toFixed(2)}`;
            netCreditEl.className = netCredit >= 0 ? 'metric-value text-success' : 'metric-value text-danger';
        }
        
        if (maxProfitEl) {
            maxProfitEl.textContent = maxProfit === -Infinity ? 'â‚¹0.00' : `â‚¹${maxProfit.toFixed(2)}`;
            maxProfitEl.className = 'metric-value text-success';
        }
        
        if (maxLossEl) {
            maxLossEl.textContent = maxLoss === Infinity ? 'â‚¹0.00' : `â‚¹${maxLoss.toFixed(2)}`;
            maxLossEl.className = 'metric-value text-danger';
        }
    }
    
    // Calculate single option payoff
    function calculateOptionPayoff(action, strike, premium, count, spotPrice) {
        let payoff = 0;
        const lotSize = defaultLotSize;
        
        switch (action) {
            case 'CE Buy':
                payoff = Math.max(spotPrice - strike, 0) - premium;
                break;
            case 'CE Sell':
                payoff = premium - Math.max(spotPrice - strike, 0);
                break;
            case 'PE Buy':
                payoff = Math.max(strike - spotPrice, 0) - premium;
                break;
            case 'PE Sell':
                payoff = premium - Math.max(strike - spotPrice, 0);
                break;
        }
        
        return payoff * count * lotSize;
    }
    
    // Global click handler to close dropdowns
    document.addEventListener('click', closeAllDropdowns);
    
    // Make functions globally available
    window.createOptionButton = createOptionButton;
    window.handleButtonClick = handleButtonClick;
    window.updateButtonDisplay = updateButtonDisplay;
    window.updatePayoffChart = updatePayoffChart;
    window.createPayoffChartFromOptionChain = createPayoffChartFromOptionChain;
    window.initPayoffChart = initPayoffChart;
    window.counters = counters;
    window.firstClickFlags = firstClickFlags;
    
    // Initialize payoff chart when document is ready
    initPayoffChart();
    
    // Add candlestick chart function
    window.openCandlestickChart = function() {
        // Try multiple ways to get the current symbol
        let currentSymbol = null;
        
        // Method 1: Check websocket handler
        if (window.websocketHandler && window.websocketHandler.currentSymbol) {
            currentSymbol = window.websocketHandler.currentSymbol;
        }
        
        // Method 2: Check the fyersSymbolDisplay element
        if (!currentSymbol) {
            const symbolDisplay = document.getElementById('fyersSymbolDisplay');
            if (symbolDisplay && symbolDisplay.textContent.trim()) {
                const symbolMatch = symbolDisplay.textContent.match(/([A-Z]+:[A-Z0-9-]+)/);
                if (symbolMatch) {
                    currentSymbol = symbolMatch[1];
                }
            }
        }
        
        // Method 3: Check if NSE:NIFTY50-INDEX is showing in the interface
        if (!currentSymbol) {
            const allText = document.body.textContent;
            if (allText.includes('NSE:NIFTY50-INDEX')) {
                currentSymbol = 'NSE:NIFTY50-INDEX';
            }
        }
        
        console.log('Chart icon clicked, detected symbol:', currentSymbol);
        
        if (currentSymbol) {
            // Check if modal exists before proceeding
            const modalElement = document.getElementById('candlestickModal');
            if (!modalElement) {
                console.error('Modal element not found in DOM');
                // Try to wait and retry
                setTimeout(() => {
                    const retryModal = document.getElementById('candlestickModal');
                    if (retryModal) {
                        console.log('Modal found on retry');
                        window.openCandlestickChart();
                    } else {
                        alert('Chart feature is loading, please try again in a moment');
                    }
                }, 500);
                return;
            }
            
            if (window.candlestickChart) {
                window.candlestickChart.show(currentSymbol);
            } else {
                // Try to initialize if not already done
                if (typeof CandlestickChart !== 'undefined') {
                    window.candlestickChart = new CandlestickChart();
                    window.candlestickChart.show(currentSymbol);
                } else {
                    console.error('CandlestickChart class not available');
                    alert('Chart feature is loading, please try again in a moment');
                }
            }
        } else {
            alert('Please select a symbol first');
        }
    };
    
    window.refreshCandlestickChart = function() {
        if (window.candlestickChart) {
            window.candlestickChart.refresh();
        }
    };
});
</script>




<!-- Candlestick Chart Modal -->
<div class="modal fade" id="candlestickModal" tabindex="-1" aria-labelledby="candlestickModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 95%; height: 90vh;">
    <div class="modal-content h-100">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title" id="candlestickModalLabel">
          <i class="fas fa-chart-line text-primary me-2"></i>
          <span id="chartSymbolTitle">Chart Analysis</span>
        </h5>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="maximizeChart" title="Maximize">
            <i class="fas fa-expand"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="minimizeChart" title="Minimize">
            <i class="fas fa-minus"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <!-- Timeframe Controls -->
        <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light border-bottom">
          <div class="d-flex gap-2">
            <div class="btn-group" role="group" aria-label="Timeframe">
              <input type="radio" class="btn-check" name="timeframe" id="tf1m" value="1" checked>
              <label class="btn btn-outline-primary btn-sm" for="tf1m">1m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf3m" value="3">
              <label class="btn btn-outline-primary btn-sm" for="tf3m">3m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf5m" value="5">
              <label class="btn btn-outline-primary btn-sm" for="tf5m">5m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf15m" value="15">
              <label class="btn btn-outline-primary btn-sm" for="tf15m">15m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf1h" value="60">
              <label class="btn btn-outline-primary btn-sm" for="tf1h">1h</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfD" value="D">
              <label class="btn btn-outline-primary btn-sm" for="tfD">Daily</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfW" value="W">
              <label class="btn btn-outline-primary btn-sm" for="tfW">Weekly</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfM" value="M">
              <label class="btn btn-outline-primary btn-sm" for="tfM">Monthly</label>
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <!-- Support/Resistance Toggle -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="supportResistanceToggle" checked>
              <label class="form-check-label" for="supportResistanceToggle">
                Support/Resistance
              </label>
            </div>
            
            <!-- Refresh Button -->
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshCandlestickChart()">
              <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
          </div>
        </div>
        
        <!-- Chart Container -->
        <div id="candlestickChartContainer" style="height: calc(90vh - 160px); position: relative; padding-bottom: 40px;">
          <div id="candlestickChart" style="height: 100%; width: 100%;"></div>
          <div id="chartLoading" class="d-flex justify-content-center align-items-center position-absolute top-50 start-50 translate-middle" style="display: none !important;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading chart...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
