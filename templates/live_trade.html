<!-- templates/live_trade.html -->
{% extends "base.html" %}
{% block title %}Live Trading Platform{% endblock %}

{% block content %}



<style>
/* ATM Strike Highlighting Styles */
.atm-strike-highlight {
  background-color: rgba(255, 193, 7, 0.3) !important;
  border: 1px solid #ffc107 !important;
}

.atm-strike-highlight:hover {
  background-color: rgba(255, 193, 7, 0.5) !important;
}

/* ATM Controls Styling */
#atmCheckbox {
  margin-right: 5px;
}

#atmDisplay {
  font-family: 'Courier New', monospace;
  letter-spacing: 0.5px;
}

/* ITM/OTM Color Coding */
.itm-call {
  background-color: #fff3cd !important; /* Light yellow for ITM calls */
}

.otm-call {
  background-color: #ffffff !important; /* White for OTM calls */
}

.itm-put {
  background-color: #fff3cd !important; /* Light yellow for ITM puts */
}

.otm-put {
  background-color: #ffffff !important; /* White for OTM puts */
}

/* Live update animation */
.live-updated {
  background-color: #28a745 !important;
  transition: background-color 0.3s ease;
  color: white !important;
}

/* Strike distance indicator */
.strike-distance {
  font-size: 8px;
  color: #6c757d;
  display: block;
  margin-top: 2px;
}

/* Market Data Carousel Styles */
.carousel-container {
  overflow: hidden;
  width: 100%;
  position: relative;
}

#marketDataCarousel {
  display: flex;
  width: 700%; /* 7 pages × 100% each */
  transition: transform 0.3s ease;
}

.carousel-page {
  flex-shrink: 0;
  width: 14.2857%; /* Each page takes 1/7 of the total carousel width */
  min-width: 14.2857%;
}

/* Saved Tables Icon Button Styles */
.saved-tables-controls .btn {
  transition: all 0.2s ease;
  border-radius: 6px;
  padding: 6px 10px;
  margin: 0 2px;
}

.saved-tables-controls .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.saved-tables-controls .btn i {
  font-size: 14px;
}

.saved-tables-controls .btn-primary:hover {
  background-color: #0056b3;
  border-color: #004085;
}

.saved-tables-controls .btn-success:hover {
  background-color: #218838;
}

/* Position Highlighting Styles for Three-Card Synchronization */
.position-highlight {
  background-color: rgba(13, 110, 253, 0.1) !important;
  border-left: 3px solid #0d6efd !important;
}

.position-active {
  background-color: rgba(13, 110, 253, 0.2) !important;
  font-weight: bold !important;
  border: 1px solid #0d6efd !important;
}

.position-highlight:hover {
  background-color: rgba(13, 110, 253, 0.15) !important;
}

/* Payoff Chart Fullscreen Styles */
.payoff-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.payoff-fullscreen .card-body {
  height: calc(100vh - 60px) !important;
  overflow-y: auto;
}

.payoff-fullscreen #chartContainer {
  height: calc(100vh - 300px) !important;
  min-height: 400px;
}

.payoff-fullscreen-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998;
  display: none;
}

.fullscreen-exit-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10000;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
}

.fullscreen-exit-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Option Chain Fullscreen Styles */
.option-chain-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.option-chain-fullscreen .card-body {
  height: calc(100vh - 120px) !important;
  overflow: auto;
}

.option-chain-fullscreen .table-container {
  height: calc(100vh - 140px) !important;
  overflow: auto;
}

/* Clean B/S Button Styles - Match original design */
.option_button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 4px;
  height: 16px;
  font-size: 9px;
  border: 1px solid;
  border-radius: 2px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
  min-width: 14px;
  font-weight: normal;
}

.option_button:hover {
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 40px;
  text-align: center;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #28a745;
  border-color: #28a745;
  background: #fff;
}

.buy_button:hover {
  background: #28a745;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: #fff;
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

/* Count Badge and Dropdown Menu Styles */
.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Option Chain Table Enhanced Styling */
.option-chain-content {
  position: relative;
}

.saved-tables-controls .btn-danger:hover {
  background-color: #c82333;
  border-color: #bd2130;
}

.saved-tables-controls .btn-info:hover {
  background-color: #138496;
  border-color: #117a8b;
}

/* Enhanced Live Trading Styling */
.card {
  border: none;
  border-radius: 8px;
}

.card-header {
  border-radius: 8px 8px 0 0 !important;
  font-weight: 600;
}

.option_button {
  display: none;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 6px;
  height: 20px;
  font-size: 10px;
  border: 1px solid;
  border-radius: 3px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
}

.option_button:hover {
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transform: translateY(-1px);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 60px;
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 2px !important;
}

/* Four Tab Styles */
.option-chain-tab-pane {
  display: none;
}

.option-chain-tab-pane.active {
  display: block;
}

.active-option-tab {
  background-color: #fff !important;
  color: #000 !important;
  border-color: #fff !important;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #198754;
  border-color: #198754;
  background: rgba(25, 135, 84, 0.1);
}

.buy_button:hover {
  background: #198754;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.1);
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Expiry buttons */
.expiry_button {
  display: inline-block;
  padding: 4px 8px;
  margin: 2px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  font-size: 11px;
  transition: all 0.2s;
}

.expiry_button:hover {
  background: #e9ecef;
  border-color: #007bff;
}

.expiry_button.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

/* Buy/Sell button styling - using attached code approach */
.option_button {
  display: none;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 0 10px;
  height: 28px;
  font-size: 12px;
  border: 1px solid;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  margin: 0 5px;
  transition: 0.3s;
}

/* Position Management Card Styles */
.position-management-card {
  position: absolute;
  top: calc(100% + 5px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  min-width: 280px;
  z-index: 10000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.position-card-header {
  background: #f8f9fa;
  padding: 12px 16px;
  border-bottom: 1px solid #dee2e6;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  font-size: 14px;
  color: #495057;
  display: flex;
  align-items: center;
  gap: 8px;
}

.position-card-header i {
  color: #6c757d;
}

.position-card-content {
  padding: 16px;
  max-height: 300px;
  overflow-y: auto;
}

.position-entry {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid #f0f0f0;
}

.position-entry:last-child {
  margin-bottom: 8px;
  padding-bottom: 0;
  border-bottom: none;
}

.position-expiry-tag {
  background: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 12px;
  letter-spacing: 0.5px;
}

.position-lot-control {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.position-lot-label {
  font-size: 13px;
  color: #495057;
  display: flex;
  align-items: center;
  gap: 6px;
}

.position-lot-label i {
  color: #6c757d;
}

.position-control-buttons {
  display: flex;
  gap: 6px;
}

.position-btn-decrease,
.position-btn-increase {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  transition: all 0.2s;
}

.position-btn-decrease {
  background: #dc3545;
  color: white;
}

.position-btn-decrease:hover {
  background: #c82333;
  transform: scale(1.05);
}

.position-btn-increase {
  background: #28a745;
  color: white;
}

.position-btn-increase:hover {
  background: #218838;
  transform: scale(1.05);
}

.position-add-btn {
  width: 100%;
  padding: 10px;
  background: #f8f9fa;
  border: 2px dashed #dee2e6;
  border-radius: 6px;
  color: #6c757d;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.position-add-btn:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #495057;
}

.option_button:hover {
  box-shadow: 0 0 5px -1px rgba(0, 0, 0, 0.5);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.5rem !important;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #03b760;
  border-color: #03b760;
}

.sell_button {
  color: #ef6161;
  border-color: #ef6161;
}

.count_badge {
  display: none;
  position: absolute;
  top: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  line-height: 18px;
  text-align: center;
  font-size: 11px;
  color: #fff;
  border-radius: 50%;
}

.buy_button .count_badge {
  background: #03b760;
}

.sell_button .count_badge {
  background: #ef6161;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 12px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 12px;
}

.dropdown_menu button:hover {
  background: #f2f2f2;
}

/* Position table enhancements */
.position-row {
  transition: background-color 0.2s;
}

.position-row:hover {
  background-color: rgba(0,123,255,0.1);
}

/* Option Chain Table Header Styling */
#optionChainTable thead {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 2px solid #dee2e6;
  font-size: 10px; /* Reduced font size for better look and feel */
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #333;
}

#optionChainTable thead th {
  padding: 8px 6px;
  text-align: center;
  border-right: 1px solid #e9ecef;
  white-space: nowrap;
}

#optionChainTable thead th:last-child,
#optionChainTable thead th:first-child {
  border-right: none;
}

#optionChainTable th[style*="background-color: #f39c12"] {
  background: #f39c12 !important;
  color: #fff !important;
  font-weight: 700;
}

/* Enhanced Option Chain Table Professional Styling */
#optionChainTable {
  border-collapse: collapse;
  width: 100%;
  font-size: 11px;
  border: 1px solid #dee2e6;
}

#optionChainTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

/* Enhanced table body styling */
#optionChainTable tbody tr {
  border-bottom: 1px solid #f1f3f4;
  transition: background-color 0.15s ease;
}

#optionChainTable tbody tr:hover {
  background-color: #f8f9fa;
}

#optionChainTable tbody tr:nth-child(even) {
  background-color: #fafafa;
}

#optionChainTable tbody tr:nth-child(even):hover {
  background-color: #f0f0f0;
}

#optionChainTable tbody td {
  padding: 4px 6px;
  text-align: center;
  border-right: 1px solid #f1f3f4;
  white-space: nowrap;
  font-size: 10px;
  line-height: 1.4;
}

#optionChainTable tbody td:last-child {
  border-right: none;
}

/* Remove ATM highlighting */
#optionChainTable .atm-strike {
  background-color: inherit !important;
}

/* Strike column enhancement */
#optionChainTable tbody td:nth-child(20) {
  font-weight: 600;
  background-color: #fff3cd;
  border-left: 2px solid #f39c12;
  border-right: 2px solid #f39c12;
}

/* ITM styling with yellow color for calls and puts */
.itm-call {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM calls */
}

.itm-put {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM puts */
}

/* Maintain hover effects for ITM rows */
.itm-call:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

.itm-put:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .card-body {
    padding: 0.75rem;
  }

  .option_button {
    height: 18px;
    font-size: 9px;
    padding: 1px 4px;
  }

  #chartContainer {
    height: 250px !important;
  }
}

/* Live data indicator animation */
@keyframes pulse {
  0% { background-color: #6c757d; }
  50% { background-color: #28a745; }
  100% { background-color: #6c757d; }
}

.badge.bg-secondary {
  animation: pulse 2s infinite;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<!-- Live Trading Container with Enhanced Bootstrap Design -->
<div class="container-fluid py-3">
  <!-- Resizable Layout Container -->
  <div class="resizable-container">
    <!-- Left Panel - Symbol Selection & Option Chain -->
    <div class="resizable-panel left-panel">
      <!-- Symbol Selection & Expiry Dates Card -->
      <div class="card shadow-sm mb-2">
        <div class="card-body">
          <!-- Symbol Selection Row -->
          <div class="row g-2 align-items-center mb-3">
            <!-- Index Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 50px;">Index:</label>
              <select id="indexSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Index</option>
                <optgroup label="NSE">
                  <option value="NIFTY" selected>NIFTY 50</option>
                  <option value="BANKNIFTY">BANK NIFTY</option>
                  <option value="FINNIFTY">FIN NIFTY</option>
                  <option value="MIDCPNIFTY">MIDCAP NIFTY</option>
                </optgroup>
                <optgroup label="BSE">
                  <option value="SENSEX">SENSEX</option>
                  <option value="BANKEX">BANKEX</option>
                </optgroup>
              </select>
            </div>

            <!-- Exchange Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 70px;">Exchange:</label>
              <select id="exchangeSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Exchange</option>
                <option value="NSE">NSE</option>
                <option value="BSE">BSE</option>
                <option value="MCX">MCX</option>
                <option value="Crypto">Crypto</option>
                <option value="NSE–Commodity">NSE Commodity</option>
              </select>
            </div>

            <!-- Symbol Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 55px;">Symbol:</label>
              <select id="extraSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Symbol</option>
              </select>
            </div>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Expiry Dates Row -->
          <div class="d-flex align-items-center mb-3">
            <label class="form-label small fw-semibold me-3 mb-0" style="min-width: 80px;">
              <i class="fas fa-calendar-alt me-1"></i>Expiry:
            </label>
            <button id="expiryPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden">
              <div id="expiryViewerCarousel" class="d-flex gap-2 transition-all" style="transition: transform 0.3s ease;">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            <button id="expiryNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Market Data Carousel -->
          <div class="d-flex align-items-center">
            <button id="marketDataPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden carousel-container">
              <div id="marketDataCarousel" class="d-flex" style="transition: transform 0.3s ease; width: 700%;">
                <!-- Page 1: Primary Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Spot Price:</small>
                      <strong id="spotPrice" class="text-muted">Select Symbol</strong>
                      <i id="chartIcon" class="fas fa-chart-line text-primary ms-2" 
                         style="cursor: pointer; font-size: 14px; display: none;" 
                         title="Open Candlestick Chart"
                         onclick="openCandlestickChart()"></i>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Open:</small><strong class="text-secondary">23,649</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Future:</small><strong class="text-secondary">23,700</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">VIX:</small><strong class="text-warning">14.56</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 2: Extended Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Day High:</small><strong class="text-success">23,850</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Low:</small><strong class="text-danger">23,420</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Volume:</small><strong class="text-secondary">2.5M</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">OI:</small><strong class="text-secondary">1.8M</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 3: Additional Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Prev Close:</small><strong class="text-secondary">23,590</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change:</small><strong class="text-success">+18</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change %:</small><strong class="text-success">+0.08%</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">LTP:</small><strong class="text-muted">--</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 4: Options Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">PCR:</small><strong class="text-info">0.85</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Max Pain:</small><strong class="text-secondary">23,600</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Call OI:</small><strong class="text-success">12.5L</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Put OI:</small><strong class="text-danger">10.6L</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 5: Technical Indicators -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">RSI:</small><strong class="text-warning">62.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">MACD:</small><strong class="text-success">+15.2</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">EMA 20:</small><strong class="text-secondary">23,580</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">SMA 50:</small><strong class="text-secondary">23,520</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 6: Market Sentiment -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">FII Net:</small><strong class="text-success">+450Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">DII Net:</small><strong class="text-danger">-120Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">ADX:</small><strong class="text-info">28.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Bollinger:</small><strong class="text-secondary">Mid</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 7: Performance Metrics -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">52W High:</small><strong class="text-success">25,980</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">52W Low:</small><strong class="text-danger">19,280</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Beta:</small><strong class="text-secondary">1.05</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Avg Vol:</small><strong class="text-secondary">3.2M</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button id="marketDataNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Option Chain Card (Single Table) -->
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <!-- ATM Display Only - No checkbox -->
            <div class="d-flex align-items-center gap-2">
              <span id="atmDisplay" class="badge bg-warning text-dark" style="font-size: 10px; min-width: 50px; display: none;">
                ATM
              </span>
            </div>
            <!-- Strike Count Dropdown -->
            <div class="d-flex align-items-center gap-2">
              <label for="strikeCountSelect" class="form-label mb-0 text-light" style="font-size: 11px; font-weight: 500;">Strike Count:</label>
              <select id="strikeCountSelect" class="form-select form-select-sm" style="width: 80px; font-size: 11px;">
                <option value="5">5</option>
                <option value="7">7</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="ALL">ALL</option>
              </select>
            </div>
            <span id="fyersSymbolDisplay" class="d-none" style="font-size: 10px; color: #6c757d; font-weight: 500;">
              <span id="fyersSymbolText">NSE:NIFTY50-INDEX</span>
            </span>
          </div>
          <div class="d-flex align-items-center gap-3">
            <div id="selectedDetailsDisplay" style="font-size: 11px; color: #adb5bd; font-weight: 500;">
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="refreshBtn" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;">
                <i class="fas fa-sync"></i>
              </button>
              <button id="fullscreenOptionChain" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
              <div id="liveDataControls" class="d-flex align-items-center gap-2">
              <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle p-1" type="button" id="columnVisibilityDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="height: 30px; font-size: 11px;" title="Column Visibility">
                  <i class="fas fa-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="columnVisibilityDropdown" style="min-width: 250px; max-height: 400px; overflow-y: auto;">
                  <li><h6 class="dropdown-header">Column Visibility</h6></li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3 py-1">
                    <div class="d-flex gap-2 mb-2">
                      <button id="selectAllColumns" class="btn btn-success btn-sm flex-fill" style="font-size: 10px;">Select All</button>
                      <button id="deselectAllColumns" class="btn btn-secondary btn-sm flex-fill" style="font-size: 10px;">Clear All</button>
                      <button id="resetToDefaults" class="btn btn-primary btn-sm flex-fill" style="font-size: 10px;">Defaults</button>
                    </div>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3">
                    <div class="row" style="font-size: 11px;">
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="16" id="col16"><label class="form-check-label" for="col16">CE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="17" id="col17"><label class="form-check-label" for="col17">CE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="15" id="col15"><label class="form-check-label" for="col15">CE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="14" id="col14"><label class="form-check-label" for="col14">CE OI</label></div>
                      </div>
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="21" id="col21"><label class="form-check-label" for="col21">PE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="22" id="col22"><label class="form-check-label" for="col22">PE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="23" id="col23"><label class="form-check-label" for="col23">PE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="24" id="col24"><label class="form-check-label" for="col24">PE OI</label></div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
                <span id="liveDataStatus" style="font-size: 12px; color: #6c757d;">
                  <i class="fas fa-circle text-secondary"></i> Live Data Ready
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Single Option Chain Navigation -->
        <div class="card-header bg-secondary text-white p-2 border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1" style="font-size: 12px;">
            <span class="text-light" style="font-size: 11px; font-weight: 500;">
              Option Chain
            </span>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Loading Indicator -->
          <div id="optionChainLoading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">
              <small class="text-muted">Loading option chain data...</small>
            </div>
          </div>
          <!-- Single Option Chain Table -->
          <div id="optionChainContainer" style="max-height: 60vh; overflow-y: auto;">

            <div class="table-container">
              <table class="table table-sm mb-0" id="optionChainTable">
                <thead>
                  <tr>
                    <th>CE B/S</th>
                    <th>Veta</th>
                    <th>Volga</th>
                    <th>Charm</th>
                    <th>Vanna</th>
                    <th>Vega</th>
                    <th>Theta</th>
                    <th>Gamma</th>
                    <th>Chng</th>
                    <th>Bid Qty</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Ask Qty</th>
                    <th>Chng in OI</th>
                    <th>OI</th>
                    <th>Vol</th>
                    <th>Chart</th>
                    <th>LTP</th>
                    <th>Δ</th>
                    <th style="background-color: #f39c12; color: #000;">Strike</th>
                    <th>Δ</th>
                    <th>LTP</th>
                    <th>Chart</th>
                    <th>Vol</th>
                    <th>OI</th>
                    <th>Chng in OI</th>
                    <th>Ask Qty</th>
                    <th>Ask</th>
                    <th>Bid</th>
                    <th>Bid Qty</th>
                    <th>Chng</th>
                    <th>Gamma</th>
                    <th>Theta</th>
                    <th>Vega</th>
                    <th>Vanna</th>
                    <th>Charm</th>
                    <th>Volga</th>
                    <th>Veta</th>
                    <th>PE B/S</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resizable Separator -->
    <div class="resizer"></div>

    <!-- Right Panel - Charts & Trading -->
    <div class="resizable-panel right-panel">
      <!-- Enhanced Saved Tables Control with Broker Management (Responsive Fixed) -->
      <div class="mb-1 p-2 bg-light rounded">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <!-- Left Side: Saved Tables Controls -->
          <div class="d-flex align-items-center gap-2 saved-tables-controls flex-shrink-0">
            <label for="savedTablesSelect" class="form-label mb-0 me-1" style="white-space: nowrap; font-size: 12px;">Saved Tables:</label>
            <select id="savedTablesSelect" class="form-select form-select-sm" style="min-width: 120px; max-width: 150px;">
              <option value="">-- Select Saved Table --</option>
            </select>
            <div class="btn-group" role="group">
              <button id="addNewBtn" class="btn btn-primary btn-sm" title="Add New Table">
                <i class="fas fa-plus"></i>
              </button>
              <button id="saveBtn" class="btn btn-success btn-sm" title="Save Table">
                <i class="fas fa-save"></i>
              </button>
              <button id="deleteBtn" class="btn btn-danger btn-sm" title="Delete Table">
                <i class="fas fa-trash"></i>
              </button>
              <button id="newTabBtn" class="btn btn-info btn-sm" title="Open Selected in New Tab">
                <i class="fas fa-external-link-alt"></i>
              </button>
              <button id="viewBasketBtn" class="btn btn-secondary btn-sm" title="View Strategy Basket" onclick="window.location.href='/basket'">
                <i class="fas fa-shopping-basket"></i>
              </button>
            </div>
          </div>

          <!-- Broker Management - Enhanced Visual -->
          <div class="d-flex align-items-center gap-2 broker-management-controls flex-shrink-0">
            <!-- User Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="userSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">User:</label>
              <select id="userSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
            </div>

            <!-- Broker Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="brokerSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">Broker:</label>
              <select id="brokerSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
              <span id="tokenStatus" class="badge bg-secondary ms-1" style="font-size: 10px; white-space: nowrap; padding: 4px 6px;">No Token</span>
            </div>

            <!-- Token Management -->
            <div class="btn-group ms-2" role="group">
              <button id="createTokenBtn" class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Create New Token">
                <i class="fas fa-key me-1"></i>Create
              </button>
              <button id="refreshTokenBtn" class="btn btn-outline-warning btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Refresh Token">
                <i class="fas fa-sync me-1"></i>Refresh
              </button>
              <button id="brokerSettingsBtn" class="btn btn-outline-dark btn-sm" style="padding:4px 8px;font-size:11px;" title="Manage Broker Credentials">
                <i class="fas fa-user-cog me-1"></i>Broker Settings
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Tabs - Compact Single Line -->
      <div class="card shadow-sm">
        <div class="card-header p-2 bg-white border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1 flex-wrap" style="font-size: 13px;">
            <button class="btn btn-sm btn-primary active-tab-btn" id="payoff-tab" data-bs-toggle="tab" data-bs-target="#payoff-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Payoff Chart
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="mtm-tab" data-bs-toggle="tab" data-bs-target="#mtm-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              MTM
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Strategy
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="oi-tab" data-bs-toggle="tab" data-bs-target="#oi-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              OI
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="rolling-tab" data-bs-toggle="tab" data-bs-target="#rolling-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Rolling Straddle
            </button>
            <div class="ms-auto d-flex align-items-center gap-2">
              <label class="form-check-label" for="payoffSettings" style="font-size: 11px;">
                <input class="form-check-input" type="checkbox" id="payoffSettings"> Payoff Settings
              </label>
              <button id="togglePayoffView" class="btn btn-outline-secondary btn-sm" title="Hide/Show Payoff Chart">
                <i class="fas fa-chevron-up"></i>
              </button>
              <button id="fullscreenPayoff" class="btn btn-outline-primary btn-sm" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="payoffCardBody" class="card-body p-0">
          <div class="tab-content" id="analysisTabContent">
            <!-- Payoff Chart Tab Content -->
            <div class="tab-pane fade show active" id="payoff-content" role="tabpanel">
              <div class="p-3">

      <!-- Payoff Chart Content (Hideable) -->
      <div id="payoffChartContent">
        <!-- Risk Metrics - Label Top, Value Bottom -->
        <div class="mb-2 py-1">
          <div class="d-flex justify-content-between align-items-start flex-wrap" style="font-size: 12px;">
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Req. Margin</div>
              <div id="marginValue" class="fw-bold text-primary">₹3,391 <span class="text-muted">□</span></div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P&L</div>
              <div id="pnlValue" class="fw-bold text-success">₹0 (0.00)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Profit</div>
              <div id="maxProfitValue" class="fw-bold text-success">₹11,493 (1.3%)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Loss</div>
              <div id="maxLossValue" class="fw-bold text-danger">(Unlimited)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P.O.P.</div>
              <div id="popValue" class="fw-bold text-info">55.24%</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Net Credit</div>
              <div id="netCreditValue" class="fw-bold text-success">₹11,487.5</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Breakeven</div>
              <div id="breakevenValue" class="fw-bold text-warning">26037 (+ 0.5%), 24902 (- 1.5%)</div>
            </div>
          </div>
        </div>

        <!-- Payoff Chart - No Header -->
        <div class="mb-1">
          <div id="chartContainer" style="width: 100%; height: 450px; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #fff;"></div>
        </div>
      </div>

      <!-- Current Positions Card -->
      <div class="card shadow-sm mb-2" style="margin-top: 0.5rem;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 me-3">
              <i class="fas fa-briefcase me-2"></i>Current Positions
            </h6>
            <div id="brokerInfo" class="small text-white-75" style="display: none;">
              <span id="selectedBrokerName">No Broker Selected</span>
              <span class="mx-2">|</span>
              <span id="selectedBrokerUserId">No User ID</span>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button id="clearAllBtn" class="btn btn-outline-light btn-sm">
              <i class="fas fa-trash me-1"></i>Clear All
            </button>
            <span id="positionCount" class="badge bg-light text-dark">0 Positions</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm mb-0" style="font-size: 11px;">
              <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <tr>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">
                    <input type="checkbox" id="selectAllPositions" style="transform: scale(0.8);">
                  </th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 35px; text-align: center;">Type</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">Action</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Lots</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Qty</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 140px; text-align: center;">Symbol</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Trade Date/Time</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Strike</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Expiry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 60px; text-align: center;">Entry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">LTP</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Delta</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">P&L</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Lots Exit</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Lock In</th>
                  <th style="padding: 8px 6px; width: 40px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="positionTableBody">
                <tr>
                  <td colspan="16" class="text-center text-muted py-3">
                    <i class="fas fa-plus-circle me-2"></i>No positions yet. Start trading!
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Position Table Footer with Controls -->
          <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 11px;">
            <div class="d-flex align-items-center gap-2">
              <span>Multiplier:</span>
              <select class="form-select form-select-sm" style="width: 60px; font-size: 10px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <span>Lot Size: 75</span>
              <button class="btn btn-outline-primary btn-sm" style="padding: 2px 8px; font-size: 10px;">Add Alert</button>
              <button class="btn btn-outline-success btn-sm" style="padding: 2px 8px; font-size: 10px;">Save</button>
              <button class="btn btn-outline-info btn-sm" style="padding: 2px 8px; font-size: 10px;">Share</button>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span id="totalDelta" class="text-info" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <span id="totalPnLSummary" class="text-success" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <button class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; font-size: 10px;">Exit</button>
              <button class="btn btn-outline-danger btn-sm" style="padding: 2px 8px; font-size: 10px;">Clear</button>
            </div>
          </div>
        </div>
      </div>

              </div>
            </div>

            <!-- MTM Tab Content -->
            <div class="tab-pane fade" id="mtm-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-calculator fa-3x mb-3"></i>
                  <h5>MTM Analysis</h5>
                  <p>Mark-to-market analysis and real-time P&L tracking will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Strategy Tab Content -->
            <div class="tab-pane fade" id="strategy-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chess fa-3x mb-3"></i>
                  <h5>Strategy Builder</h5>
                  <p>Advanced strategy creation and backtesting tools will be available here.</p>
                </div>
              </div>
            </div>

            <!-- OI Tab Content -->
            <div class="tab-pane fade" id="oi-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chart-bar fa-3x mb-3"></i>
                  <h5>Open Interest Analysis</h5>
                  <p>Open interest charts and PCR analysis will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Rolling Straddle Tab Content -->
            <div class="tab-pane fade" id="rolling-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-sync-alt fa-3x mb-3"></i>
                  <h5>Rolling Straddle</h5>
                  <p>Rolling straddle analysis and optimization tools will be available here.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Hidden Loader Template -->
<div id="loaderTemplate" style="display:none;">
  <div class="d-flex justify-content-center">
    <div class="spinner-border spinner-border-sm text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Include Resizable Layout CSS -->
<link href="{{ url_for('static', filename='css/resizable.css') }}" rel="stylesheet">

<!-- Option Chain Styling for WebSocket -->
<style>
  /* ATM Strike Highlighting */
  .atm-strike {
    background-color: #ffc107 !important;
    font-weight: bold;
  }
  
  .atm-strike td {
    background-color: #ffc107 !important;
    color: #000 !important;
  }
  
  /* ITM/OTM Styling - Subtle yellow for ITM like the reference image */
  .call-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .call-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  .put-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .put-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  /* Strike Price Column */
  .strike-price {
    background-color: #495057 !important;
    color: #fff !important;
    font-weight: bold;
  }
  
  /* Spot Price Animation */
  .spot-price-updated {
    animation: priceFlash 0.5s ease-in-out;
  }
  
  @keyframes priceFlash {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
  }
  
  /* Lots Hover Controls */
  .lots-container {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    gap: 2px;
  }
  
  .lots-value {
    display: inline-block;
    font-size: 11px;
    font-weight: 500;
    min-width: 20px;
    text-align: center;
  }
  
  .lots-controls {
    display: none;
    align-items: center;
    gap: 1px;
  }
  
  .lots-cell:hover .lots-controls {
    display: inline-flex;
  }
  
  .lots-btn {
    background: #fff;
    border: 1px solid #ccc;
    width: 20px;
    height: 20px;
    font-size: 12px;
    line-height: 1;
    cursor: pointer;
    margin: 0 1px;
    border-radius: 2px;
    color: #333;
  }
  
  .lots-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
    color: #007bff;
  }
  
  .lots-minus:hover {
    background: #f8d7da;
    border-color: #dc3545;
    color: #dc3545;
  }
  
  .lots-plus:hover {
    background: #d4edda;
    border-color: #28a745;
    color: #28a745;
  }
</style>

<!-- *** NEW: symbol / expiry logic *** -->
<script src="{{ url_for('static', filename='js/symbol_selector_fixed.js') }}"></script>
<script src="{{ url_for('static', filename='js/websocket_handler.js') }}?v=2.0&t=1751872760"></script>
<script>
// Auto-load NIFTY option chain for live data updates
window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const indexSelect = document.getElementById('indexSelect');
        const expirySelect = document.getElementById('expirySelect');
        
        if (indexSelect && !indexSelect.value) {
            console.log('Auto-loading NIFTY 50 for live updates...');
            indexSelect.value = 'NIFTY 50';
            indexSelect.dispatchEvent(new Event('change'));
            
            // Wait for expiry options to load
            setTimeout(function() {
                if (expirySelect && expirySelect.options.length > 1) {
                    expirySelect.selectedIndex = 1; // First actual expiry
                    expirySelect.dispatchEvent(new Event('change'));
                    console.log('Auto-loaded option chain for live streaming');
                    
                    // Wait for option chain to load, then update subscriptions
                    setTimeout(function() {
                        console.log('🔄 Triggering subscription update for auto-loaded option chain');
                        updateSubscriptionsFromTable();
                    }, 3000);
                }
            }, 2000);
        }
        
        // Function to update subscriptions based on current table content
        async function updateSubscriptionsFromTable() {
            try {
                const table = document.getElementById('optionChainTable');
                if (!table) {
                    console.log('❌ Option chain table not found');
                    return;
                }
                
                const symbols = [];
                const rows = table.querySelectorAll('tbody tr');
                
                console.log(`🔍 Scanning ${rows.length} rows for symbols`);
                
                rows.forEach((row, index) => {
                    const cells = row.children;
                    if (cells && cells.length >= 20) {
                        // Extract CE symbol (column 17)
                        const ceCell = cells[17];
                        if (ceCell && ceCell.textContent.trim()) {
                            const ceMatch = ceCell.textContent.match(/NSE:[A-Z0-9]+/);
                            if (ceMatch) symbols.push(ceMatch[0]);
                        }
                        
                        // Extract PE symbol (column 21)  
                        const peCell = cells[21];
                        if (peCell && peCell.textContent.trim()) {
                            const peMatch = peCell.textContent.match(/NSE:[A-Z0-9]+/);
                            if (peMatch) symbols.push(peMatch[0]);
                        }
                    }
                });
                
                // Add spot symbol
                symbols.push('NSE:NIFTY50-INDEX');
                
                if (symbols.length > 0) {
                    console.log(`🔄 Updating subscriptions for ${symbols.length} symbols from table`);
                    
                    const response = await fetch('/websocket/update_subscriptions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ symbols: symbols })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`✅ Subscription update successful: ${result.message}`);
                    } else {
                        const error = await response.json();
                        console.error('❌ Subscription update failed:', error.error);
                    }
                } else {
                    console.log('❌ No symbols found in table');
                }
            } catch (error) {
                console.error('❌ Error updating subscriptions from table:', error);
            }
        }
        
        // Export for global access
        window.updateSubscriptionsFromTable = updateSubscriptionsFromTable;
    }, 3000);
});
</script>
<script src="{{ url_for('static', filename='js/option_microchart.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart_popup.js') }}"></script>
<script src="{{ url_for('static', filename='js/candlestick_chart.js') }}"></script>


<!-- Highcharts (Pay-off chart) -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/stock.js"></script>

<!-- Resizable layout behaviour -->
<script src="{{ url_for('static', filename='js/resizable.js') }}"></script>

<!-- Chart controller (pay-off & option-chain fullscreen) -->
<script src="{{ url_for('static', filename='js/chart_controller.js') }}"></script>

<!-- Market data carousel -->
<script src="{{ url_for('static', filename='js/market_data_carousel.js') }}"></script>

<!-- Broker settings -->
<script src="{{ url_for('static', filename='js/broker_settings.js') }}"></script>

<script>
// Initialize components when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add World Clock button to payoff settings area
    setTimeout(() => {
        const payoffContainer = document.querySelector('.ms-auto.d-flex.align-items-center.gap-2');
        if (payoffContainer && !document.getElementById('worldClockBtn')) {
            const clockBtn = document.createElement('button');
            clockBtn.id = 'worldClockBtn';
            clockBtn.className = 'btn btn-warning btn-sm';
            clockBtn.title = 'World Market Times';
            clockBtn.innerHTML = '<i class="fas fa-clock me-1"></i>Markets';
            clockBtn.onclick = function() {
                if (window.marketClock) {
                    window.marketClock.showPopup();
                } else {
                    alert('Market clock not loaded. Please refresh the page.');
                }
            };
            
            // Insert before the first child (payoff settings)
            payoffContainer.insertBefore(clockBtn, payoffContainer.firstChild);
        }
        
        // Load market clock script if not already loaded
        if (!window.marketClock) {
            const script = document.createElement('script');
            script.src = '/static/js/market_clock.js';
            document.head.appendChild(script);
        }
    }, 1000);
    
    // Position tracking variables - using attached code approach
    const defaultLotSize = 75;
    const defaultLot = 1;
    let counters = [];
    let firstClickFlags = [];
    let payoffChart = null;
    
    // Initialize payoff chart when DOM is ready
    setTimeout(() => {
        initPayoffChart();
        console.log('Payoff chart initialized in Payoff Chart tab');
    }, 1500);
    
    // Initialize payoff chart in the existing Payoff Chart tab
    function initPayoffChart() {
        const chartContainer = document.getElementById('chartContainer');
        if (chartContainer) {
            payoffChart = Highcharts.chart('chartContainer', {
                chart: { 
                    type: 'line', 
                    height: 450,
                    backgroundColor: '#fafafa',
                    zoomType: 'xy',
                    panning: {
                        enabled: true,
                        type: 'xy'
                    },
                    panKey: 'shift',
                    resetZoomButton: {
                        theme: {
                            fill: '#ffffff',
                            stroke: '#cccccc',
                            style: {
                                fontSize: '10px',
                                color: '#333333'
                            }
                        },
                        position: {
                            align: 'right',
                            verticalAlign: 'top',
                            x: -10,
                            y: 10
                        }
                    },
                    marginTop: 10,
                    marginBottom: 30,
                    spacingTop: 5,
                    spacingBottom: 5
                },
                title: { 
                    text: null
                },
                xAxis: { 
                    title: { text: 'Underlying Price' }, 
                    crosshair: {
                        width: 2,
                        color: '#007BFF',
                        dashStyle: 'solid',
                        label: {
                            enabled: true,
                            format: '₹{value:.0f}',
                            style: {
                                backgroundColor: '#007BFF',
                                color: '#ffffff',
                                fontSize: '10px',
                                fontWeight: 'bold'
                            }
                        }
                    },
                    gridLineWidth: 1,
                    gridLineColor: '#e0e0e0'
                },
                yAxis: { 
                    title: { text: 'Net P&L (₹)' },
                    crosshair: {
                        width: 2,
                        color: '#28a745',
                        dashStyle: 'solid',
                        label: {
                            enabled: true,
                            format: '₹{value:.0f}',
                            style: {
                                backgroundColor: '#28a745',
                                color: '#ffffff',
                                fontSize: '10px',
                                fontWeight: 'bold'
                            }
                        }
                    },
                    plotLines: [{
                        value: 0,
                        color: '#000000',
                        width: 2,
                        zIndex: 5,
                        label: {
                            text: 'Breakeven Line',
                            align: 'right',
                            style: {
                                color: '#000000',
                                fontSize: '10px'
                            }
                        }
                    }],
                    plotBands: [], // Will be populated dynamically
                    gridLineWidth: 1,
                    gridLineColor: '#e0e0e0'
                },
                legend: {
                    enabled: false
                },
                tooltip: { 
                    shared: true,
                    crosshairs: true,
                    useHTML: true,
                    formatter: function() {
                        let tooltip = '<div style="font-size: 11px; padding: 6px; background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 4px;">';
                        tooltip += '<div style="font-weight: bold; color: #333;">₹' + this.x.toFixed(0) + '</div>';
                        
                        this.points.forEach(function(point) {
                            if (point.series.name === 'Net P&L') {
                                const pnl = point.y;
                                const color = pnl >= 0 ? '#28a745' : '#dc3545';
                                tooltip += '<div style="color: ' + color + '; font-weight: bold;">₹' + pnl.toFixed(0) + '</div>';
                            }
                        });
                        
                        tooltip += '</div>';
                        return tooltip;
                    },
                    valueDecimals: 0,
                    backgroundColor: 'rgba(255,255,255,0.95)',
                    borderColor: '#cccccc',
                    borderWidth: 1,
                    borderRadius: 4,
                    shadow: false
                },
                plotOptions: {
                    line: {
                        marker: { enabled: false },
                        lineWidth: 2
                    },
                    area: {
                        marker: { enabled: false },
                        lineWidth: 2,
                        fillOpacity: 0.3
                    }
                },
                series: [],
                credits: { enabled: false }
            });
        }
    }
    
    // Global position tracking system
    window.globalPositions = window.globalPositions || {};
    
    // Create Buy/Sell button with position management card - using attached code approach
    function createOptionButton(rowIndex, key, label, extraClass) {
        const div = document.createElement('div');
        div.className = `option_button ${extraClass}`;
        div.id = `${key}Btn_${rowIndex}`;
        div.textContent = label + ' ';
        
        // Position management card (initially hidden)
        const positionCard = document.createElement('div');
        positionCard.className = 'position-management-card';
        positionCard.id = `${key}Card_${rowIndex}`;
        positionCard.style.display = 'none';
        
        // Card header
        const cardHeader = document.createElement('div');
        cardHeader.className = 'position-card-header';
        cardHeader.innerHTML = '<i class="fas fa-cog"></i> Position Management';
        
        // Card content container
        const cardContent = document.createElement('div');
        cardContent.className = 'position-card-content';
        cardContent.id = `${key}CardContent_${rowIndex}`;
        
        positionCard.appendChild(cardHeader);
        positionCard.appendChild(cardContent);
        div.appendChild(positionCard);
        
        // The numeric badge that shows how many lots (kept for initial display)
        const badge = document.createElement('span');
        badge.className = 'count_badge';
        badge.id = `${key}Badge_${rowIndex}`;
        badge.textContent = '0';
        div.appendChild(badge);
        
        // Main click handler
        div.onclick = (e) => {
            e.stopPropagation();
            if (firstClickFlags[rowIndex][key]) {
                handleButtonClick(rowIndex, key, 'add');
                firstClickFlags[rowIndex][key] = false;
            } else {
                togglePositionCard(rowIndex, key);
            }
        };
        
        return div;
    }
    
    // Handle expiry-specific position changes from position cards
    function handleExpirySpecificPositionChange(rowIndex, key, action, targetExpiry) {
        console.log(`[EXPIRY POSITION CHANGE] START - Action: ${action}, rowIndex: ${rowIndex}, key: ${key}, targetExpiry: ${targetExpiry}`);
        
        // Get current strike information
        const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
        let strike = 0;
        if (row) {
            const strikeTd = row.children[19]; // Strike column
            strike = parseFloat(strikeTd?.textContent || 0);
        }
        
        // Create position key for global tracking with target expiry
        const positionKey = `${strike}-${targetExpiry}-${key}`;
        console.log(`[EXPIRY POSITION CHANGE] Position key: ${positionKey}`);
        
        // Log current position state before change
        const currentPosition = window.globalPositions[positionKey];
        console.log(`[EXPIRY POSITION CHANGE] Current position:`, currentPosition);
        
        if (action === 'add') {
            // Store in global positions
            if (!window.globalPositions[positionKey]) {
                console.log(`[EXPIRY POSITION CHANGE] Creating new position for ${positionKey}`);
                window.globalPositions[positionKey] = {
                    strike: strike,
                    expiry: targetExpiry,
                    optionType: key.includes('ce') ? 'CE' : 'PE',
                    action: key.includes('Buy') ? 'Buy' : 'Sell',
                    lots: 0,
                    rowIndex: rowIndex,
                    key: key
                };
            }
            const beforeLots = window.globalPositions[positionKey].lots;
            window.globalPositions[positionKey].lots++;
            const afterLots = window.globalPositions[positionKey].lots;
            console.log(`[EXPIRY POSITION CHANGE] ADD: ${beforeLots} -> ${afterLots}`);
        } else if (action === 'remove') {
            // Update global positions
            if (window.globalPositions[positionKey] && window.globalPositions[positionKey].lots > 0) {
                const beforeLots = window.globalPositions[positionKey].lots;
                window.globalPositions[positionKey].lots--;
                const afterLots = window.globalPositions[positionKey].lots;
                console.log(`[EXPIRY POSITION CHANGE] REMOVE: ${beforeLots} -> ${afterLots}`);
                
                if (window.globalPositions[positionKey].lots <= 0) {
                    delete window.globalPositions[positionKey];
                    console.log(`[POSITION REMOVE] Deleted position key: ${positionKey}, remaining positions:`, Object.keys(window.globalPositions).length);
                }
            } else {
                console.log(`[EXPIRY POSITION CHANGE] Cannot remove - position not found or lots already 0`);
            }
        }
        
        // Update current expiry counter if this matches current expiry
        const currentExpiry = window.tradingState?.currentExpiry || window.webSocketHandler?.currentExpiry;
        if (targetExpiry === currentExpiry) {
            if (action === 'add') {
                counters[rowIndex][key]++;
            } else if (action === 'remove' && counters[rowIndex][key] > 0) {
                counters[rowIndex][key]--;
            }
        }
        
        // Close position card if no positions remain for this strike/option type/action combination
        const currentStrike = strike;
        const currentOptionType = key.includes('ce') ? 'CE' : 'PE';
        const currentAction = key.includes('Buy') ? 'Buy' : 'Sell';
        
        const remainingPositions = Object.values(window.globalPositions || {}).filter(pos => 
            pos.strike === currentStrike && pos.optionType === currentOptionType && 
            pos.action === currentAction && pos.lots > 0
        );
        
        if (remainingPositions.length === 0) {
            closeAllPositionCards();
        }
        
        // Force update of button displays for all buttons to ensure proper synchronization
        console.log(`[SYNC UPDATE] Before restore - Global positions count: ${Object.keys(window.globalPositions || {}).length}`);
        restoreButtonStatesFromGlobalPositions();
        updatePositionCard(rowIndex, key);
        
        // Update current positions table
        updateCurrentPositionsTable();
        
        // Immediately create and update payoff chart using loaded option chain data
        createPayoffChartFromOptionChain();
        
        // Update real-time payoff chart lines if WebSocket handler exists
        if (window.webSocketHandler && typeof window.webSocketHandler.updatePayoffChartSpotPrice === 'function') {
            window.webSocketHandler.updatePayoffChartSpotPrice();
        }
        
        console.log(`${action} ${key} for row ${rowIndex}, expiry ${targetExpiry}`);
    }

    // Handle button clicks - create payoff chart immediately on click
    function handleButtonClick(rowIndex, key, action) {
        // Get current expiry and strike information
        const currentExpiry = window.tradingState?.currentExpiry || window.webSocketHandler?.currentExpiry;
        const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
        let strike = 0;
        if (row) {
            const strikeTd = row.children[19]; // Strike column
            strike = parseFloat(strikeTd?.textContent || 0);
        }
        
        // Create position key for global tracking
        const positionKey = `${strike}-${currentExpiry}-${key}`;
        
        if (action === 'add') {
            counters[rowIndex][key]++;
            // Store in global positions
            if (!window.globalPositions[positionKey]) {
                window.globalPositions[positionKey] = {
                    strike: strike,
                    expiry: currentExpiry,
                    optionType: key.includes('ce') ? 'CE' : 'PE',
                    action: key.includes('Buy') ? 'Buy' : 'Sell',
                    lots: 0,
                    rowIndex: rowIndex,
                    key: key
                };
            }
            window.globalPositions[positionKey].lots++;
        } else if (action === 'remove' && counters[rowIndex][key] > 0) {
            counters[rowIndex][key]--;
            // Update global positions
            if (window.globalPositions[positionKey]) {
                window.globalPositions[positionKey].lots--;
                if (window.globalPositions[positionKey].lots <= 0) {
                    delete window.globalPositions[positionKey];
                }
            }
        }
        
        updateButtonDisplay(rowIndex, key);
        updatePositionCard(rowIndex, key);
        closeAllPositionCards();
        
        // Update current positions table
        updateCurrentPositionsTable();
        
        // Immediately create and update payoff chart using loaded option chain data
        createPayoffChartFromOptionChain();
        
        // Update real-time payoff chart lines if WebSocket handler exists
        console.log(`[BUTTON CLICK] Checking WebSocket handler: exists=${!!window.webSocketHandler}, updateFunction=${window.webSocketHandler && typeof window.webSocketHandler.updatePayoffChartSpotPrice === 'function'}`);
        if (window.webSocketHandler && typeof window.webSocketHandler.updatePayoffChartSpotPrice === 'function') {
            console.log(`[BUTTON CLICK] Calling WebSocket handler updatePayoffChartSpotPrice`);
            window.webSocketHandler.updatePayoffChartSpotPrice();
        } else {
            console.log(`[BUTTON CLICK] WebSocket handler not available or updatePayoffChartSpotPrice not found`);
        }
        
        // Keep existing position table intact - just log the action
        console.log(`${action} ${key} for row ${rowIndex}, new count: ${counters[rowIndex][key]}`);
    }
    
    // Global function to force payoff chart update with live spot price - called by WebSocket handler
    window.forcePayoffChartUpdate = function(spotPrice) {
        console.log(`[FORCE UPDATE] forcePayoffChartUpdate called with spot: ${spotPrice}`);
        
        if (!payoffChart) {
            console.log('[FORCE UPDATE] No payoff chart available - deferring until chart is created');
            // Store the pending spot price for when chart is created
            window.pendingSpotPrice = spotPrice;
            return false;
        }
        
        if (!spotPrice && window.webSocketHandler && window.webSocketHandler.currentSpotPrice) {
            spotPrice = window.webSocketHandler.currentSpotPrice;
        }
        
        if (!spotPrice) {
            console.log('[FORCE UPDATE] No spot price available');
            return false;
        }
        
        console.log(`[FORCE UPDATE] Updating payoff chart with spot price: ${spotPrice}`);
        
        // Remove existing spot price line
        payoffChart.xAxis[0].removePlotLine('currentSpot');
        
        // Add updated spot price line
        payoffChart.xAxis[0].addPlotLine({
            id: 'currentSpot',
            value: spotPrice,
            color: '#007BFF',
            width: 2,
            zIndex: 7,
            label: {
                text: 'Spot: ₹' + spotPrice.toFixed(0),
                align: 'center',
                rotation: 0,
                verticalAlign: 'bottom',
                y: -5,
                x: 0,
                useHTML: true,
                style: {
                    color: '#007BFF',
                    fontSize: '12px',
                    fontWeight: 'bold',
                    fontFamily: 'Arial, sans-serif',
                    zIndex: 1000
                }
            }
        });
        
        // Recalculate and update breakeven lines
        if (typeof updateBreakevenLinesFromPositions === 'function') {
            updateBreakevenLinesFromPositions();
        } else {
            console.log('[FORCE UPDATE] updateBreakevenLinesFromPositions not available, chart updated without breakeven lines');
        }
        
        console.log(`[FORCE UPDATE] Successfully updated payoff chart spot line to: ${spotPrice}`);
        return true;
    };
    
    // Update button display - using attached code approach
    function updateButtonDisplay(rowIndex, key) {
        const count = counters[rowIndex][key];
        const button = document.getElementById(`${key}Btn_${rowIndex}`);
        const badge = document.getElementById(`${key}Badge_${rowIndex}`);
        
        if (button && badge) {
            badge.textContent = count;
            if (count > 0) {
                button.classList.add('active');
                badge.style.display = 'block';
            } else {
                button.classList.remove('active');
                badge.style.display = 'none';
                firstClickFlags[rowIndex][key] = true;
            }
        }
    }
    
    // Restore button states from global positions when option chain is rebuilt
    function restoreButtonStatesFromGlobalPositions() {
        const currentExpiry = window.tradingState?.currentExpiry || window.webSocketHandler?.currentExpiry;
        if (!currentExpiry) return;
        
        // Reset ALL counters for current table to 0 first
        if (window.counters) {
            window.counters.forEach((rowCounters, rowIndex) => {
                if (rowCounters) {
                    Object.keys(rowCounters).forEach(key => {
                        rowCounters[key] = 0;
                        // Immediately update button display to clear badges
                        updateButtonDisplay(rowIndex, key);
                    });
                }
            });
        }
        
        // If no global positions exist at all, we're done - all badges should be hidden
        if (!window.globalPositions || Object.keys(window.globalPositions).length === 0) {
            console.log('[RESTORE BUTTONS] No global positions exist - all badges cleared');
            return;
        }
        
        // Restore positions for current expiry and any cross-expiry positions
        Object.values(window.globalPositions).forEach(position => {
            const { strike, optionType, action, lots, expiry } = position;
            
            // Find the row index for this strike
            const table = document.getElementById('optionChainTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row, rowIndex) => {
                const strikeTd = row.children[19]; // Strike column
                const rowStrike = parseFloat(strikeTd?.textContent || 0);
                
                if (rowStrike === strike) {
                    // Determine all keys (option types and actions) for this strike
                    const keys = ['ceBuy', 'ceSell', 'peBuy', 'peSell'];
                    
                    keys.forEach(key => {
                        if (window.counters[rowIndex] && window.counters[rowIndex][key] !== undefined) {
                            const keyOptionType = key.includes('ce') ? 'CE' : 'PE';
                            const keyAction = key.includes('Buy') ? 'Buy' : 'Sell';
                            
                            // Calculate total lots for current expiry for this specific key
                            const currentExpiryLots = Object.values(window.globalPositions)
                                .filter(pos => pos.strike === strike && pos.optionType === keyOptionType && 
                                       pos.action === keyAction && pos.expiry === currentExpiry)
                                .reduce((sum, pos) => sum + pos.lots, 0);
                            
                            // Calculate total lots across all expiries to check if any positions exist
                            const totalPositionLots = Object.values(window.globalPositions || {})
                                .filter(pos => pos.strike === strike && pos.optionType === keyOptionType && 
                                       pos.action === keyAction && pos.lots > 0)
                                .reduce((sum, pos) => sum + pos.lots, 0);
                            
                            // Set the counter based on current expiry lots only
                            if (currentExpiryLots > 0) {
                                // Show actual current expiry lots
                                window.counters[rowIndex][key] = currentExpiryLots;
                            } else if (totalPositionLots > 0) {
                                // Show cross-expiry indicator only if there are actually positions in other expiries
                                window.counters[rowIndex][key] = 1; 
                            } else {
                                // No positions anywhere - clear the button completely
                                window.counters[rowIndex][key] = 0;
                            }
                            
                            updateButtonDisplay(rowIndex, key);
                        }
                    });
                }
            });
        });
    }
    
    // Toggle position card - using attached code approach
    function togglePositionCard(rowIndex, key) {
        closeAllPositionCards();
        const card = document.getElementById(`${key}Card_${rowIndex}`);
        if (card) {
            card.style.display = card.style.display === 'block' ? 'none' : 'block';
            if (card.style.display === 'block') {
                updatePositionCard(rowIndex, key);
            }
        }
    }
    
    // Close all position cards
    function closeAllPositionCards() {
        document.querySelectorAll('.position-management-card').forEach(card => {
            card.style.display = 'none';
        });
    }
    
    // Update position card content
    function updatePositionCard(rowIndex, key) {
        const cardContent = document.getElementById(`${key}CardContent_${rowIndex}`);
        if (!cardContent) return;
        
        // Get current expiry and strike information
        const currentExpiry = window.tradingState?.currentExpiry || window.webSocketHandler?.currentExpiry;
        const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
        let strike = 0;
        if (row) {
            const strikeTd = row.children[19]; // Strike column
            strike = parseFloat(strikeTd?.textContent || 0);
        }
        
        // Find all positions for this strike (across all expiries)
        const strikePositions = Object.values(window.globalPositions).filter(pos => 
            pos.strike === strike && pos.optionType === (key.includes('ce') ? 'CE' : 'PE') && 
            pos.action === (key.includes('Buy') ? 'Buy' : 'Sell')
        );
        
        // Clear existing content
        cardContent.innerHTML = '';
        
        if (strikePositions.length === 0) {
            const noPositionMsg = document.createElement('div');
            noPositionMsg.className = 'no-position-message';
            noPositionMsg.innerHTML = '<i class="fas fa-info-circle"></i> No positions found';
            noPositionMsg.style.textAlign = 'center';
            noPositionMsg.style.color = '#6c757d';
            noPositionMsg.style.padding = '10px';
            cardContent.appendChild(noPositionMsg);
            return;
        }
        
        // Group positions by expiry
        const positionsByExpiry = {};
        strikePositions.forEach(pos => {
            if (!positionsByExpiry[pos.expiry]) {
                positionsByExpiry[pos.expiry] = [];
            }
            positionsByExpiry[pos.expiry].push(pos);
        });
        
        // Create position entries for each expiry
        Object.entries(positionsByExpiry).forEach(([expiry, positions]) => {
            positions.forEach(pos => {
                const positionEntry = document.createElement('div');
                positionEntry.className = 'position-entry';
                
                const expiryTag = document.createElement('div');
                expiryTag.className = 'position-expiry-tag';
                expiryTag.textContent = formatExpiryDisplay(expiry);
                
                const lotControl = document.createElement('div');
                lotControl.className = 'position-lot-control';
                
                const lotLabel = document.createElement('span');
                lotLabel.className = 'position-lot-label';
                lotLabel.innerHTML = `<i class="fas fa-layer-group"></i> ${pos.lots} lots`;
                
                const controlButtons = document.createElement('div');
                controlButtons.className = 'position-control-buttons';
                
                const decreaseBtn = document.createElement('button');
                decreaseBtn.className = 'position-btn-decrease';
                decreaseBtn.innerHTML = '<i class="fas fa-minus"></i>';
                decreaseBtn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log(`[POSITION CARD] Decrease button clicked - rowIndex: ${rowIndex}, key: ${key}, expiry: ${pos.expiry}`);
                    handleExpirySpecificPositionChange(rowIndex, key, 'remove', pos.expiry);
                };
                
                const increaseBtn = document.createElement('button');
                increaseBtn.className = 'position-btn-increase';
                increaseBtn.innerHTML = '<i class="fas fa-plus"></i>';
                increaseBtn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log(`[POSITION CARD] Increase button clicked - rowIndex: ${rowIndex}, key: ${key}, expiry: ${pos.expiry}`);
                    handleExpirySpecificPositionChange(rowIndex, key, 'add', pos.expiry);
                };
                
                controlButtons.appendChild(decreaseBtn);
                controlButtons.appendChild(increaseBtn);
                
                lotControl.appendChild(lotLabel);
                lotControl.appendChild(controlButtons);
                
                positionEntry.appendChild(expiryTag);
                positionEntry.appendChild(lotControl);
                
                cardContent.appendChild(positionEntry);
            });
        });
    }
    
    // Update Current Positions Table - synchronize with global positions
    function updateCurrentPositionsTable() {
        const tableBody = document.getElementById('positionTableBody');
        if (!tableBody) return;
        
        // Clear existing content
        tableBody.innerHTML = '';
        
        // Get all positions from global positions
        const allPositions = Object.values(window.globalPositions || {}).filter(pos => pos.lots > 0);
        
        if (allPositions.length === 0) {
            // Show empty state
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="15" class="text-center text-muted py-3">
                    <i class="fas fa-plus-circle me-2"></i>No positions yet. Start trading!
                </td>
            `;
            tableBody.appendChild(emptyRow);
            return;
        }
        
        // Sort positions by expiry, then by strike
        allPositions.sort((a, b) => {
            if (a.expiry !== b.expiry) {
                return new Date(a.expiry) - new Date(b.expiry);
            }
            return a.strike - b.strike;
        });
        
        // Create rows for each position
        allPositions.forEach((position, index) => {
            const { strike, expiry, optionType, action, lots } = position;
            
            // Build symbol name (approximation for display)
            const expiryFormatted = formatExpiryForSymbol(expiry);
            const symbol = `NSE:NIFTY${expiryFormatted}${strike}${optionType}`;
            
            // Determine row colors based on action
            const typeClass = optionType === 'CE' ? 'text-success' : 'text-primary';
            const actionClass = action === 'Buy' ? 'text-success' : 'text-danger';
            const actionBadge = action === 'Buy' ? 
                '<span class="badge bg-success text-white">BUY</span>' : 
                '<span class="badge bg-danger text-white">SELL</span>';
            
            const row = document.createElement('tr');
            row.className = 'position-row';
            row.innerHTML = `
                <td style="text-align: center;"><input type="checkbox"></td>
                <td style="text-align: center;">
                    <span class="badge bg-${optionType === 'CE' ? 'success' : 'primary'} text-white">${optionType}</span>
                </td>
                <td style="text-align: center;">${actionBadge}</td>
                <td style="text-align: center; position: relative;" class="lots-cell">
                    <div class="lots-container" data-position-key="${strike}-${expiry}-${optionType.toLowerCase()}${action}">
                        <div class="lots-controls">
                            <button class="lots-btn lots-minus" onclick="adjustLots('${strike}-${expiry}-${optionType.toLowerCase()}${action}', -1, event)">−</button>
                        </div>
                        <span class="lots-value">${lots}</span>
                        <div class="lots-controls">
                            <button class="lots-btn lots-plus" onclick="adjustLots('${strike}-${expiry}-${optionType.toLowerCase()}${action}', 1, event)">+</button>
                        </div>
                    </div>
                </td>
                <td style="text-align: center;" class="qty-cell" data-position-key="${strike}-${expiry}-${optionType.toLowerCase()}${action}">${lots * 75}</td>
                <td style="text-align: center; font-size: 10px; max-width: 140px; overflow: hidden; text-overflow: ellipsis;">${symbol}</td>
                <td style="text-align: center; font-size: 10px;">${new Date().toLocaleDateString('en-IN')} ${new Date().toLocaleTimeString('en-IN', {hour12: true, hour: '2-digit', minute: '2-digit'}).toLowerCase()}</td>
                <td style="text-align: center;">${strike}</td>
                <td style="text-align: center; font-size: 10px;">${formatExpiryDisplay(expiry)}</td>
                <td style="text-align: center;">₹0.00</td>
                <td style="text-align: center;">₹0.00</td>
                <td style="text-align: center;">0.00</td>
                <td style="text-align: center;">₹0.00</td>
                <td style="text-align: center;">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" style="font-size: 9px; padding: 1px 4px;" data-bs-toggle="dropdown">Exit</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Partial Exit</a></li>
                            <li><a class="dropdown-item" href="#">Full Exit</a></li>
                        </ul>
                    </div>
                </td>
                <td style="text-align: center;">
                    <button class="btn btn-outline-secondary btn-sm" style="font-size: 9px; padding: 1px 4px;">
                        <i class="fas fa-lock" style="font-size: 8px;"></i>
                    </button>
                </td>
                <td style="text-align: center;">
                    <button class="btn btn-outline-danger btn-sm" style="font-size: 10px; padding: 2px 4px;" onclick="removePosition('${strike}-${expiry}-${optionType.toLowerCase()}${action}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Update positions count in header
        const positionsCount = document.querySelector('.card-header h6');
        if (positionsCount && positionsCount.textContent.includes('Current Positions')) {
            const countText = allPositions.length === 1 ? '1 Position' : `${allPositions.length} Positions`;
            positionsCount.innerHTML = `<i class="fas fa-briefcase me-2"></i>Current Positions <span class="badge bg-light text-dark ms-2">${countText}</span>`;
        }
    }
    
    // Helper function to format expiry for symbol name
    function formatExpiryForSymbol(expiry) {
        if (!expiry) return '';
        try {
            const date = new Date(expiry);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${year}${month}${day}`;
        } catch (e) {
            return expiry.replace(/-/g, '');
        }
    }
    
    // Remove position function for delete button in current positions table
    function removePosition(positionKey) {
        if (window.globalPositions && window.globalPositions[positionKey]) {
            delete window.globalPositions[positionKey];
            
            // Update all components
            updateCurrentPositionsTable();
            restoreButtonStatesFromGlobalPositions();
            createPayoffChartFromOptionChain();
            
            console.log(`Removed position: ${positionKey}`);
        }
    }
    
    // Adjust lots function for + and - buttons in current positions table
    window.adjustLots = function adjustLots(positionKey, change, event) {
        // Prevent event bubbling
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        console.log(`[ADJUST LOTS] Called with Position: ${positionKey}, Change: ${change}`);
        console.log(`[ADJUST LOTS] Available positions:`, Object.keys(window.globalPositions || {}));
        
        if (!window.globalPositions || !window.globalPositions[positionKey]) {
            console.log(`[ADJUST LOTS] Position not found: ${positionKey}`);
            return;
        }
        
        const position = window.globalPositions[positionKey];
        const oldLots = position.lots;
        
        // Apply the change
        if (change > 0) {
            // Increment lots
            position.lots += Math.abs(change);
            console.log(`[ADJUST LOTS] INCREMENT: ${oldLots} -> ${position.lots}`);
        } else if (change < 0 && position.lots > 0) {
            // Decrement lots (but don't go below 0)
            position.lots = Math.max(0, position.lots - Math.abs(change));
            console.log(`[ADJUST LOTS] DECREMENT: ${oldLots} -> ${position.lots}`);
            
            // If lots reach 0, remove the position
            if (position.lots <= 0) {
                delete window.globalPositions[positionKey];
                console.log(`[ADJUST LOTS] Removed position with 0 lots: ${positionKey}`);
            }
        }
        
        // Immediately update the current row's displays for instant feedback
        const lotsValueElement = document.querySelector(`[data-position-key="${positionKey}"] .lots-value`);
        const qtyElement = document.querySelector(`.qty-cell[data-position-key="${positionKey}"]`);
        
        if (lotsValueElement && window.globalPositions[positionKey]) {
            lotsValueElement.textContent = window.globalPositions[positionKey].lots;
        }
        
        if (qtyElement && window.globalPositions[positionKey]) {
            qtyElement.textContent = window.globalPositions[positionKey].lots * 75;
        }
        
        // Update all three components to maintain synchronization
        updateCurrentPositionsTable();
        restoreButtonStatesFromGlobalPositions();
        createPayoffChartFromOptionChain();
        
        console.log(`[ADJUST LOTS] Synchronization complete. Total positions: ${Object.keys(window.globalPositions || {}).length}`);
    }
    
    // Format expiry for display (convert from YYYY-MM-DD to DD-MMM-YY)
    function formatExpiryDisplay(expiry) {
        if (!expiry) return 'N/A';
        try {
            const date = new Date(expiry);
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
            const year = date.getFullYear().toString().slice(-2);
            return `${day}-${month}-${year}`;
        } catch (e) {
            return expiry;
        }
    }
    
    // Update payoff chart - using attached code approach
    function updatePayoffChart() {
        if (!payoffChart) return;
        
        const legs = [];
        
        // Check if there are any positions at all
        const hasAnyPositions = Object.values(window.globalPositions || {}).some(pos => pos.lots > 0);
        
        if (!hasAnyPositions) {
            // Clear the payoff chart when no positions exist
            payoffChart.series[0].setData([]);
            
            // Remove all plot lines and bands
            payoffChart.xAxis[0].removePlotLine('currentSpot');
            payoffChart.yAxis[0].plotBands.forEach((band, index) => {
                payoffChart.yAxis[0].removePlotBand(`breakeven-${index}`);
            });
            
            console.log('[PAYOFF CHART] Cleared chart - no positions exist');
            return;
        }
        
        // Iterate through all rows and their counters
        counters.forEach((rowCounters, rowIndex) => {
            if (!rowCounters) return;
            
            // Get strike and premiums from the table row
            const row = document.querySelector(`#optionChainTable tbody tr:nth-child(${rowIndex + 1})`);
            if (!row) return;
            
            const strikeTd = row.children[19]; // Strike column
            const strike = parseFloat(strikeTd?.textContent || 0);
            if (strike === 0) return;
            
            // CE Buy
            if (rowCounters.ceBuy > 0) {
                const ltpTd = row.children[17]; // CE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'CE',
                        action: 'Buy',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.ceBuy,
                        qty: rowCounters.ceBuy * defaultLotSize
                    });
                }
            }
            
            // CE Sell
            if (rowCounters.ceSell > 0) {
                const ltpTd = row.children[17]; // CE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'CE',
                        action: 'Sell',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.ceSell,
                        qty: rowCounters.ceSell * defaultLotSize
                    });
                }
            }
            
            // PE Buy
            if (rowCounters.peBuy > 0) {
                const ltpTd = row.children[21]; // PE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'PE',
                        action: 'Buy',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.peBuy,
                        qty: rowCounters.peBuy * defaultLotSize
                    });
                }
            }
            
            // PE Sell
            if (rowCounters.peSell > 0) {
                const ltpTd = row.children[21]; // PE LTP column
                const premium = parseFloat(ltpTd?.textContent || 0);
                if (premium > 0) {
                    legs.push({
                        type: 'PE',
                        action: 'Sell',
                        strike: strike,
                        premium: premium,
                        lots: rowCounters.peSell,
                        qty: rowCounters.peSell * defaultLotSize
                    });
                }
            }
        });
        
        if (legs.length === 0) {
            payoffChart.series[0].setData([], true);
            updateMarginInfo(0, 0, 0);
            return;
        }
        
        // Calculate payoff curve
        const allStrikes = legs.map(leg => leg.strike);
        const minStrike = Math.min(...allStrikes) - 500;
        const maxStrike = Math.max(...allStrikes) + 500;
        const step = Math.max(5, Math.floor((maxStrike - minStrike) / 200));
        
        const payoffData = [];
        let netCredit = 0;
        let maxProfit = -Infinity;
        let maxLoss = Infinity;
        
        // Calculate net credit/debit
        legs.forEach(leg => {
            const credit = leg.action === 'Sell' ? leg.premium * leg.qty : -leg.premium * leg.qty;
            netCredit += credit;
        });
        
        for (let spotPrice = minStrike; spotPrice <= maxStrike; spotPrice += step) {
            let totalPayoff = netCredit; // Start with net credit/debit
            
            legs.forEach(leg => {
                let optionValue = 0;
                
                if (leg.type === 'CE') {
                    optionValue = Math.max(0, spotPrice - leg.strike);
                } else { // PE
                    optionValue = Math.max(0, leg.strike - spotPrice);
                }
                
                if (leg.action === 'Buy') {
                    totalPayoff += (optionValue - leg.premium) * leg.qty;
                } else { // Sell
                    totalPayoff += (leg.premium - optionValue) * leg.qty;
                }
            });
            
            payoffData.push([spotPrice, totalPayoff]);
            maxProfit = Math.max(maxProfit, totalPayoff);
            maxLoss = Math.min(maxLoss, totalPayoff);
        }
        
        payoffChart.series[0].setData(payoffData, true);
        updateMarginInfo(netCredit, maxProfit, maxLoss);
    }
    
    // Create multi-leg payoff chart from loaded option chain data - proper multi-leg concept
    function createPayoffChartFromOptionChain() {
        if (!payoffChart) {
            initPayoffChart();
        }
        
        if (!payoffChart) return;
        
        const legs = [];
        let totalPositions = 0;
        
        // Read directly from the loaded option chain table
        const tableRows = document.querySelectorAll('#optionChainTable tbody tr');
        
        tableRows.forEach((row, rowIndex) => {
            if (!counters[rowIndex]) return;
            
            // Get strike price from the table (column 19 = strike column)
            const strikeTd = row.children[19];
            if (!strikeTd) return;
            
            const strike = parseFloat(strikeTd.textContent.trim());
            if (isNaN(strike) || strike === 0) return;
            
            // Get CE LTP (column 17) and PE LTP (column 21) from the loaded table
            const ceLtpTd = row.children[17];
            const peLtpTd = row.children[21];
            
            const ceLtp = ceLtpTd ? parseFloat(ceLtpTd.textContent.trim()) : 0;
            const peLtp = peLtpTd ? parseFloat(peLtpTd.textContent.trim()) : 0;
            
            // Create individual legs for each position
            if (counters[rowIndex].ceBuy > 0 && ceLtp > 0) {
                legs.push({
                    type: 'CE',
                    action: 'Buy',
                    strike: strike,
                    premium: ceLtp,
                    lots: counters[rowIndex].ceBuy,
                    qty: counters[rowIndex].ceBuy * defaultLotSize,
                    name: `CE ${strike} Buy (${counters[rowIndex].ceBuy})`
                });
                totalPositions += counters[rowIndex].ceBuy;
            }
            
            if (counters[rowIndex].ceSell > 0 && ceLtp > 0) {
                legs.push({
                    type: 'CE',
                    action: 'Sell',
                    strike: strike,
                    premium: ceLtp,
                    lots: counters[rowIndex].ceSell,
                    qty: counters[rowIndex].ceSell * defaultLotSize,
                    name: `CE ${strike} Sell (${counters[rowIndex].ceSell})`
                });
                totalPositions += counters[rowIndex].ceSell;
            }
            
            if (counters[rowIndex].peBuy > 0 && peLtp > 0) {
                legs.push({
                    type: 'PE',
                    action: 'Buy',
                    strike: strike,
                    premium: peLtp,
                    lots: counters[rowIndex].peBuy,
                    qty: counters[rowIndex].peBuy * defaultLotSize,
                    name: `PE ${strike} Buy (${counters[rowIndex].peBuy})`
                });
                totalPositions += counters[rowIndex].peBuy;
            }
            
            if (counters[rowIndex].peSell > 0 && peLtp > 0) {
                legs.push({
                    type: 'PE',
                    action: 'Sell',
                    strike: strike,
                    premium: peLtp,
                    lots: counters[rowIndex].peSell,
                    qty: counters[rowIndex].peSell * defaultLotSize,
                    name: `PE ${strike} Sell (${counters[rowIndex].peSell})`
                });
                totalPositions += counters[rowIndex].peSell;
            }
        });
        
        console.log(`Total legs created: ${legs.length}, Total positions: ${totalPositions}`);
        
        if (legs.length === 0) {
            // Clear all series
            while (payoffChart.series.length > 0) {
                payoffChart.series[0].remove(false);
            }
            payoffChart.redraw();
            updateMarginInfo(0, 0, 0, []);
            console.log('No positions found, chart cleared');
            return;
        }
        
        // Calculate chart range
        const allStrikes = legs.map(leg => leg.strike);
        const minStrike = Math.min(...allStrikes) - 500;
        const maxStrike = Math.max(...allStrikes) + 500;
        const step = Math.max(5, Math.floor((maxStrike - minStrike) / 200));
        
        // Clear existing series
        while (payoffChart.series.length > 0) {
            payoffChart.series[0].remove(false);
        }
        
        // Color palette for different legs
        const colors = ['#2E86C1', '#E74C3C', '#28B463', '#F39C12', '#8E44AD', '#17A2B8', '#DC3545', '#FFC107'];
        
        let netCredit = 0;
        let maxProfit = -Infinity;
        let maxLoss = Infinity;
        
        // Calculate net position payoff (combined)
        const combinedPayoffData = [];
        
        for (let spotPrice = minStrike; spotPrice <= maxStrike; spotPrice += step) {
            let totalPayoff = 0;
            
            legs.forEach(leg => {
                let optionValue = 0;
                
                // Calculate intrinsic value
                if (leg.type === 'CE') {
                    optionValue = Math.max(0, spotPrice - leg.strike);
                } else { // PE
                    optionValue = Math.max(0, leg.strike - spotPrice);
                }
                
                // Calculate leg payoff
                let legPayoff = 0;
                if (leg.action === 'Buy') {
                    legPayoff = (optionValue - leg.premium) * leg.qty;
                } else { // Sell
                    legPayoff = (leg.premium - optionValue) * leg.qty;
                }
                
                totalPayoff += legPayoff;
            });
            
            combinedPayoffData.push([spotPrice, totalPayoff]);
            maxProfit = Math.max(maxProfit, totalPayoff);
            maxLoss = Math.min(maxLoss, totalPayoff);
        }
        
        // Calculate net credit/debit
        legs.forEach(leg => {
            const credit = leg.action === 'Sell' ? leg.premium * leg.qty : -leg.premium * leg.qty;
            netCredit += credit;
        });
        
        // Add individual leg series
        legs.forEach((leg, index) => {
            const legData = [];
            const color = colors[index % colors.length];
            
            for (let spotPrice = minStrike; spotPrice <= maxStrike; spotPrice += step) {
                let optionValue = 0;
                
                if (leg.type === 'CE') {
                    optionValue = Math.max(0, spotPrice - leg.strike);
                } else {
                    optionValue = Math.max(0, leg.strike - spotPrice);
                }
                
                let legPayoff = 0;
                if (leg.action === 'Buy') {
                    legPayoff = (optionValue - leg.premium) * leg.qty;
                } else {
                    legPayoff = (leg.premium - optionValue) * leg.qty;
                }
                
                legData.push([spotPrice, legPayoff]);
            }
            
            payoffChart.addSeries({
                name: leg.name,
                data: legData,
                color: color,
                lineWidth: 1,
                dashStyle: 'ShortDash'
            }, false);
        });
        
        // Calculate breakeven points
        const breakevenPoints = findBreakevenPoints(combinedPayoffData);
        
        // Clear existing plot lines
        for (let i = 0; i < 10; i++) {
            payoffChart.xAxis[0].removePlotLine('breakeven' + i);
        }
        payoffChart.xAxis[0].removePlotLine('currentSpot');
        
        // Add current spot price vertical line
        const currentSpotPrice = getCurrentSpotPrice();
        if (currentSpotPrice > 0) {
            payoffChart.xAxis[0].addPlotLine({
                id: 'currentSpot',
                value: currentSpotPrice,
                color: '#007BFF',
                width: 2,
                zIndex: 7,
                label: {
                    text: 'Spot: ₹' + currentSpotPrice.toFixed(0),
                    align: 'center',
                    rotation: 0,
                    verticalAlign: 'bottom',
                    y: -5,
                    x: 0,
                    useHTML: true,
                    style: {
                        color: '#007BFF',
                        fontSize: '12px',
                        fontWeight: 'bold',
                        fontFamily: 'Arial, sans-serif',
                        zIndex: 1000
                    }
                }
            });
        }
        
        // Add breakeven point plot lines
        breakevenPoints.forEach((point, index) => {
            payoffChart.xAxis[0].addPlotLine({
                id: 'breakeven' + index,
                value: point,
                color: '#FF6B35',
                width: 2,
                dashStyle: 'dash',
                zIndex: 6,
                label: {
                    text: 'BE: ₹' + point.toFixed(0),
                    align: 'center',
                    rotation: 0,
                    verticalAlign: 'bottom',
                    y: -5,
                    x: 0,
                    useHTML: true,
                    style: {
                        color: '#FF6B35',
                        fontSize: '12px',
                        fontWeight: 'bold',
                        fontFamily: 'Arial, sans-serif',
                        zIndex: 1000
                    }
                }
            });
        });
        
        // Create profit/loss background areas
        const { profitArea, lossArea } = createProfitLossAreas(combinedPayoffData, breakevenPoints);
        
        // Add profit area (green background)
        if (profitArea.length > 0) {
            payoffChart.addSeries({
                name: 'Profit Zone',
                type: 'area',
                data: profitArea,
                color: 'rgba(40, 167, 69, 0.3)',
                fillColor: 'rgba(40, 167, 69, 0.3)',
                lineWidth: 0,
                enableMouseTracking: false,
                showInLegend: false,
                zIndex: 1,
                states: {
                    hover: {
                        enabled: false
                    },
                    inactive: {
                        enabled: false
                    }
                },
                marker: {
                    enabled: false
                }
            }, false);
        }
        
        // Add loss area (red background)
        if (lossArea.length > 0) {
            payoffChart.addSeries({
                name: 'Loss Zone',
                type: 'area',
                data: lossArea,
                color: 'rgba(255, 76, 76, 0.3)',
                fillColor: 'rgba(255, 76, 76, 0.3)',
                lineWidth: 0,
                enableMouseTracking: false,
                showInLegend: false,
                zIndex: 1,
                states: {
                    hover: {
                        enabled: false
                    },
                    inactive: {
                        enabled: false
                    }
                },
                marker: {
                    enabled: false
                }
            }, false);
        }
        
        // Add combined strategy line (on top of colored areas)
        payoffChart.addSeries({
            name: 'Net P&L',
            type: 'line',
            data: combinedPayoffData,
            color: '#000000',
            lineWidth: 3,
            zIndex: 10
        }, false);
        
        payoffChart.redraw();
        updateMarginInfo(netCredit, maxProfit, maxLoss, breakevenPoints);
        
        console.log(`Multi-leg payoff chart updated with ${legs.length} individual legs plus combined strategy`);
        console.log(`Net Credit: ₹${netCredit.toFixed(2)}, Max Profit: ₹${maxProfit.toFixed(2)}, Max Loss: ₹${maxLoss.toFixed(2)}`);
    }
    
    // Enhanced margin info update with breakeven calculation
    function updateMarginInfo(netCredit, maxProfit, maxLoss, breakevenPoints = []) {
        const netCreditElement = document.getElementById('netCreditValue');
        const maxProfitElement = document.getElementById('maxProfitValue');
        const maxLossElement = document.getElementById('maxLossValue');
        const breakevenElement = document.getElementById('breakevenValue');
        
        if (netCreditElement) {
            netCreditElement.textContent = `₹${netCredit.toFixed(2)}`;
            netCreditElement.className = netCredit >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
        }
        
        if (maxProfitElement) {
            maxProfitElement.textContent = maxProfit === Infinity ? 'Unlimited' : `₹${maxProfit.toFixed(2)}`;
        }
        
        if (maxLossElement) {
            maxLossElement.textContent = maxLoss === -Infinity ? 'Unlimited' : `₹${maxLoss.toFixed(2)}`;
        }
        
        // Update breakeven display with percentage from current spot
        if (breakevenElement && breakevenPoints.length > 0) {
            const currentSpot = getCurrentSpotPrice();
            const beText = breakevenPoints.map((point, index) => {
                const percentage = currentSpot > 0 ? ((point - currentSpot) / currentSpot * 100) : 0;
                return `₹${point.toFixed(0)} (${percentage >= 0 ? '+' : ''}${percentage.toFixed(1)}%)`;
            }).join(', ');
            breakevenElement.textContent = beText;
        } else if (breakevenElement) {
            breakevenElement.textContent = 'No breakeven points';
        }
    }
    
    // Helper function to find breakeven points
    function findBreakevenPoints(payoffData) {
        const breakevenPoints = [];
        for (let i = 0; i < payoffData.length - 1; i++) {
            const current = payoffData[i];
            const next = payoffData[i + 1];
            
            // Check if the line crosses zero between these two points
            if ((current[1] <= 0 && next[1] >= 0) || (current[1] >= 0 && next[1] <= 0)) {
                // Linear interpolation to find exact breakeven point
                const slope = (next[1] - current[1]) / (next[0] - current[0]);
                const breakevenX = current[0] - (current[1] / slope);
                breakevenPoints.push(breakevenX);
            }
        }
        return breakevenPoints;
    }
    
    // Helper function to create separate profit/loss areas
    function createProfitLossAreas(payoffData, breakevenPoints) {
        if (!payoffData || payoffData.length === 0) return { profitArea: [], lossArea: [] };
        
        const profitArea = [];
        const lossArea = [];
        
        console.log('Creating profit/loss areas, breakeven points:', breakevenPoints);
        
        // Create profit areas (where P&L >= 0) and loss areas (where P&L < 0)
        for (let i = 0; i < payoffData.length; i++) {
            const [strike, pnl] = payoffData[i];
            
            if (pnl >= 0) {
                // Profit zone: fill from 0 to actual P&L
                profitArea.push([strike, pnl]);
            } else {
                // Loss zone: fill from actual P&L to 0
                lossArea.push([strike, pnl]);
            }
        }
        
        console.log('Profit area points:', profitArea.length, 'Loss area points:', lossArea.length);
        
        return { profitArea, lossArea };
    }
    
    // Helper function to get current spot price
    function getCurrentSpotPrice() {
        // Try to get from websocket handler
        if (window.websocketHandler && window.websocketHandler.latestData) {
            const data = window.websocketHandler.latestData;
            if (data.lp) {
                return parseFloat(data.lp);
            }
        }
        
        // Try to get from market data carousel
        const priceElements = document.querySelectorAll('.market-price');
        for (let elem of priceElements) {
            const priceText = elem.textContent.trim();
            const priceMatch = priceText.match(/[\d,]+\.?\d*/);
            if (priceMatch) {
                const price = parseFloat(priceMatch[0].replace(/,/g, ''));
                if (price > 1000) { // Valid index price
                    return price;
                }
            }
        }
        
        // Try to get from any element with price data
        const spotElements = document.querySelectorAll('[id*="spot"], [class*="spot"], [id*="price"], [class*="price"]');
        for (let elem of spotElements) {
            const spotText = elem.textContent.trim();
            const spotMatch = spotText.match(/[\d,]+\.?\d*/);
            if (spotMatch) {
                const price = parseFloat(spotMatch[0].replace(/,/g, ''));
                if (price > 1000 && price < 50000) { // Valid index price range
                    return price;
                }
            }
        }
        
        // Get from ATM strike as fallback (approximate spot)
        const atmRow = document.querySelector('.atm-row');
        if (atmRow) {
            const strikeTd = atmRow.children[19];
            if (strikeTd) {
                const atmStrike = parseFloat(strikeTd.textContent.trim());
                if (atmStrike > 0) {
                    return atmStrike;
                }
            }
        }
        
        return 25000; // Default fallback
    }
    
    // Update margin info display
    function updateMarginInfo(netCredit, maxProfit, maxLoss) {
        const netCreditEl = document.getElementById('netCreditValue');
        const maxProfitEl = document.getElementById('maxProfitValue');
        const maxLossEl = document.getElementById('maxLossValue');
        
        if (netCreditEl) {
            netCreditEl.textContent = `₹${netCredit.toFixed(2)}`;
            netCreditEl.className = netCredit >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
        }
        
        if (maxProfitEl) {
            maxProfitEl.textContent = maxProfit === -Infinity ? '₹0.00' : `₹${maxProfit.toFixed(2)}`;
            maxProfitEl.className = 'fw-bold text-success';
        }
        
        if (maxLossEl) {
            if (maxLoss === Infinity || maxLoss === -Infinity) {
                maxLossEl.textContent = '(Unlimited)';
            } else {
                maxLossEl.textContent = `₹${Math.abs(maxLoss).toFixed(2)}`;
            }
            maxLossEl.className = 'fw-bold text-danger';
        }
    }
    
    // Calculate single option payoff
    function calculateOptionPayoff(action, strike, premium, count, spotPrice) {
        let payoff = 0;
        const lotSize = defaultLotSize;
        
        switch (action) {
            case 'CE Buy':
                payoff = Math.max(spotPrice - strike, 0) - premium;
                break;
            case 'CE Sell':
                payoff = premium - Math.max(spotPrice - strike, 0);
                break;
            case 'PE Buy':
                payoff = Math.max(strike - spotPrice, 0) - premium;
                break;
            case 'PE Sell':
                payoff = premium - Math.max(strike - spotPrice, 0);
                break;
        }
        
        return payoff * count * lotSize;
    }
    
    // Global click handler to close position cards
    document.addEventListener('click', closeAllPositionCards);
    
    // Calculate breakeven points for current positions
    function calculateBreakevens() {
        const positions = [];
        
        // Collect all current positions from the table
        const positionTable = document.getElementById('currentPositionsTable');
        if (!positionTable) return [];
        
        const rows = positionTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                const action = cells[0].textContent.trim();
                const strike = parseFloat(cells[1].textContent) || 0;
                const quantity = parseInt(cells[2].textContent) || 0;
                const premium = parseFloat(cells[3].textContent) || 0;
                
                if (strike > 0 && quantity > 0 && premium > 0) {
                    positions.push({ action, strike, quantity, premium });
                }
            }
        });
        
        if (positions.length === 0) return [];
        
        // Calculate breakeven points based on position types
        const breakevens = [];
        
        // For simple strategies, calculate breakevens
        if (positions.length === 1) {
            const pos = positions[0];
            if (pos.action === 'CE Buy') {
                breakevens.push(pos.strike + pos.premium);
            } else if (pos.action === 'PE Buy') {
                breakevens.push(pos.strike - pos.premium);
            } else if (pos.action === 'CE Sell') {
                breakevens.push(pos.strike + pos.premium);
            } else if (pos.action === 'PE Sell') {
                breakevens.push(pos.strike - pos.premium);
            }
        } else {
            // For complex strategies, find zero crossings
            const spotRange = [];
            const minStrike = Math.min(...positions.map(p => p.strike));
            const maxStrike = Math.max(...positions.map(p => p.strike));
            const range = maxStrike - minStrike;
            
            // Create a wider range for calculation
            const startPrice = Math.max(0, minStrike - range * 0.5);
            const endPrice = maxStrike + range * 0.5;
            
            // Sample points to find zero crossings
            for (let price = startPrice; price <= endPrice; price += 5) {
                let totalPayoff = 0;
                
                positions.forEach(pos => {
                    const lotSize = defaultLotSize;
                    let payoff = 0;
                    
                    switch (pos.action) {
                        case 'CE Buy':
                            payoff = Math.max(price - pos.strike, 0) - pos.premium;
                            break;
                        case 'CE Sell':
                            payoff = pos.premium - Math.max(price - pos.strike, 0);
                            break;
                        case 'PE Buy':
                            payoff = Math.max(pos.strike - price, 0) - pos.premium;
                            break;
                        case 'PE Sell':
                            payoff = pos.premium - Math.max(pos.strike - price, 0);
                            break;
                    }
                    
                    totalPayoff += payoff * pos.quantity * lotSize;
                });
                
                spotRange.push({ price, payoff: totalPayoff });
            }
            
            // Find zero crossings
            for (let i = 1; i < spotRange.length; i++) {
                const prev = spotRange[i - 1];
                const curr = spotRange[i];
                
                if ((prev.payoff <= 0 && curr.payoff > 0) || (prev.payoff > 0 && curr.payoff <= 0)) {
                    // Linear interpolation to find exact breakeven
                    const slope = (curr.payoff - prev.payoff) / (curr.price - prev.price);
                    const breakeven = prev.price - (prev.payoff / slope);
                    
                    if (breakeven > 0 && breakeven >= startPrice && breakeven <= endPrice) {
                        breakevens.push(Math.round(breakeven * 100) / 100);
                    }
                }
            }
        }
        
        return [...new Set(breakevens)].sort((a, b) => a - b);
    }
    
    // Make functions globally available
    window.createOptionButton = createOptionButton;
    window.handleButtonClick = handleButtonClick;
    window.updateButtonDisplay = updateButtonDisplay;
    window.updatePayoffChart = updatePayoffChart;
    window.createPayoffChartFromOptionChain = createPayoffChartFromOptionChain;
    window.initPayoffChart = initPayoffChart;
    window.restoreButtonStatesFromGlobalPositions = restoreButtonStatesFromGlobalPositions;
    window.togglePositionCard = togglePositionCard;
    window.closeAllPositionCards = closeAllPositionCards;
    window.updatePositionCard = updatePositionCard;
    window.handleExpirySpecificPositionChange = handleExpirySpecificPositionChange;
    window.updateCurrentPositionsTable = updateCurrentPositionsTable;
    window.removePosition = removePosition;
    window.calculateBreakevens = calculateBreakevens;
    window.counters = counters;
    window.firstClickFlags = firstClickFlags;
    
    // Initialize payoff chart when document is ready
    initPayoffChart();
    
    // Add candlestick chart function
    window.openCandlestickChart = function() {
        // Try multiple ways to get the current symbol
        let currentSymbol = null;
        
        // Method 1: Check websocket handler
        if (window.websocketHandler && window.websocketHandler.currentSymbol) {
            currentSymbol = window.websocketHandler.currentSymbol;
        }
        
        // Method 2: Check the fyersSymbolDisplay element
        if (!currentSymbol) {
            const symbolDisplay = document.getElementById('fyersSymbolDisplay');
            if (symbolDisplay && symbolDisplay.textContent.trim()) {
                const symbolMatch = symbolDisplay.textContent.match(/([A-Z]+:[A-Z0-9-]+)/);
                if (symbolMatch) {
                    currentSymbol = symbolMatch[1];
                }
            }
        }
        
        // Method 3: Check if NSE:NIFTY50-INDEX is showing in the interface
        if (!currentSymbol) {
            const allText = document.body.textContent;
            if (allText.includes('NSE:NIFTY50-INDEX')) {
                currentSymbol = 'NSE:NIFTY50-INDEX';
            }
        }
        
        console.log('Chart icon clicked, detected symbol:', currentSymbol);
        
        if (currentSymbol) {
            // Check if modal exists before proceeding
            const modalElement = document.getElementById('candlestickModal');
            if (!modalElement) {
                console.error('Modal element not found in DOM');
                // Try to wait and retry
                setTimeout(() => {
                    const retryModal = document.getElementById('candlestickModal');
                    if (retryModal) {
                        console.log('Modal found on retry');
                        window.openCandlestickChart();
                    } else {
                        alert('Chart feature is loading, please try again in a moment');
                    }
                }, 500);
                return;
            }
            
            if (window.candlestickChart) {
                window.candlestickChart.show(currentSymbol);
            } else {
                // Try to initialize if not already done
                if (typeof CandlestickChart !== 'undefined') {
                    window.candlestickChart = new CandlestickChart();
                    window.candlestickChart.show(currentSymbol);
                } else {
                    console.error('CandlestickChart class not available');
                    alert('Chart feature is loading, please try again in a moment');
                }
            }
        } else {
            alert('Please select a symbol first');
        }
    };
    
    window.refreshCandlestickChart = function() {
        if (window.candlestickChart) {
            window.candlestickChart.refresh();
        }
    };
});
</script>




<!-- Candlestick Chart Modal -->
<div class="modal fade" id="candlestickModal" tabindex="-1" aria-labelledby="candlestickModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 95%; height: 90vh;">
    <div class="modal-content h-100">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title" id="candlestickModalLabel">
          <i class="fas fa-chart-line text-primary me-2"></i>
          <span id="chartSymbolTitle">Chart Analysis</span>
        </h5>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="maximizeChart" title="Maximize">
            <i class="fas fa-expand"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="minimizeChart" title="Minimize">
            <i class="fas fa-minus"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <!-- Timeframe Controls -->
        <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light border-bottom">
          <div class="d-flex gap-2">
            <div class="btn-group" role="group" aria-label="Timeframe">
              <input type="radio" class="btn-check" name="timeframe" id="tf1m" value="1" checked>
              <label class="btn btn-outline-primary btn-sm" for="tf1m">1m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf3m" value="3">
              <label class="btn btn-outline-primary btn-sm" for="tf3m">3m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf5m" value="5">
              <label class="btn btn-outline-primary btn-sm" for="tf5m">5m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf15m" value="15">
              <label class="btn btn-outline-primary btn-sm" for="tf15m">15m</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tf1h" value="60">
              <label class="btn btn-outline-primary btn-sm" for="tf1h">1h</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfD" value="D">
              <label class="btn btn-outline-primary btn-sm" for="tfD">Daily</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfW" value="W">
              <label class="btn btn-outline-primary btn-sm" for="tfW">Weekly</label>
              
              <input type="radio" class="btn-check" name="timeframe" id="tfM" value="M">
              <label class="btn btn-outline-primary btn-sm" for="tfM">Monthly</label>
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <!-- Support/Resistance Toggle -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="supportResistanceToggle" checked>
              <label class="form-check-label" for="supportResistanceToggle">
                Support/Resistance
              </label>
            </div>
            
            <!-- Refresh Button -->
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshCandlestickChart()">
              <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
          </div>
        </div>
        
        <!-- Chart Container -->
        <div id="candlestickChartContainer" style="height: calc(90vh - 160px); position: relative; padding-bottom: 40px;">
          <div id="candlestickChart" style="height: 100%; width: 100%;"></div>
          <div id="chartLoading" class="d-flex justify-content-center align-items-center position-absolute top-50 start-50 translate-middle" style="display: none !important;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading chart...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
