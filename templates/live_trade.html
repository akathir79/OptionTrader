<!-- templates/live_trade.html -->
{% extends "base.html" %}
{% block title %}Live Trading Platform{% endblock %}

{% block content %}

<style>
/* ATM Strike Highlighting Styles */
.atm-strike-highlight {
  background-color: rgba(255, 193, 7, 0.3) !important;
  border: 1px solid #ffc107 !important;
}

.atm-strike-highlight:hover {
  background-color: rgba(255, 193, 7, 0.5) !important;
}

/* ATM Controls Styling */
#atmCheckbox {
  margin-right: 5px;
}

#atmDisplay {
  font-family: 'Courier New', monospace;
  letter-spacing: 0.5px;
}

/* ITM/OTM Color Coding */
.itm-call {
  background-color: #fff3cd !important; /* Light yellow for ITM calls */
}

.otm-call {
  background-color: #ffffff !important; /* White for OTM calls */
}

.itm-put {
  background-color: #fff3cd !important; /* Light yellow for ITM puts */
}

.otm-put {
  background-color: #ffffff !important; /* White for OTM puts */
}

/* Strike distance indicator */
.strike-distance {
  font-size: 8px;
  color: #6c757d;
  display: block;
  margin-top: 2px;
}

/* Market Data Carousel Styles */
.carousel-container {
  overflow: hidden;
  width: 100%;
  position: relative;
}

#marketDataCarousel {
  display: flex;
  width: 700%; /* 7 pages × 100% each */
  transition: transform 0.3s ease;
}

.carousel-page {
  flex-shrink: 0;
  width: 14.2857%; /* Each page takes 1/7 of the total carousel width */
  min-width: 14.2857%;
}

/* Saved Tables Icon Button Styles */
.saved-tables-controls .btn {
  transition: all 0.2s ease;
  border-radius: 6px;
  padding: 6px 10px;
  margin: 0 2px;
}

.saved-tables-controls .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.saved-tables-controls .btn i {
  font-size: 14px;
}

.saved-tables-controls .btn-primary:hover {
  background-color: #0056b3;
  border-color: #004085;
}

.saved-tables-controls .btn-success:hover {
  background-color: #218838;
}

/* Position Highlighting Styles for Three-Card Synchronization */
.position-highlight {
  background-color: rgba(13, 110, 253, 0.1) !important;
  border-left: 3px solid #0d6efd !important;
}

.position-active {
  background-color: rgba(13, 110, 253, 0.2) !important;
  font-weight: bold !important;
  border: 1px solid #0d6efd !important;
}

.position-highlight:hover {
  background-color: rgba(13, 110, 253, 0.15) !important;
}

/* Payoff Chart Fullscreen Styles */
.payoff-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.payoff-fullscreen .card-body {
  height: calc(100vh - 60px) !important;
  overflow-y: auto;
}

.payoff-fullscreen #chartContainer {
  height: calc(100vh - 300px) !important;
  min-height: 400px;
}

.payoff-fullscreen-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998;
  display: none;
}

.fullscreen-exit-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10000;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
}

.fullscreen-exit-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Option Chain Fullscreen Styles */
.option-chain-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: white !important;
  margin: 0 !important;
  border-radius: 0 !important;
}

.option-chain-fullscreen .card-body {
  height: calc(100vh - 120px) !important;
  overflow: auto;
}

.option-chain-fullscreen .table-container {
  height: calc(100vh - 140px) !important;
  overflow: auto;
}

/* Clean B/S Button Styles - Match original design */
.option_button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 4px;
  height: 16px;
  font-size: 9px;
  border: 1px solid;
  border-radius: 2px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
  min-width: 14px;
  font-weight: normal;
}

.option_button:hover {
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 40px;
  text-align: center;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #28a745;
  border-color: #28a745;
  background: #fff;
}

.buy_button:hover {
  background: #28a745;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: #fff;
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

/* Count Badge and Dropdown Menu Styles */
.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Option Chain Table Enhanced Styling */
.option-chain-content {
  position: relative;
}

.saved-tables-controls .btn-danger:hover {
  background-color: #c82333;
  border-color: #bd2130;
}

.saved-tables-controls .btn-info:hover {
  background-color: #138496;
  border-color: #117a8b;
}

/* Enhanced Live Trading Styling */
.card {
  border: none;
  border-radius: 8px;
}

.card-header {
  border-radius: 8px 8px 0 0 !important;
  font-weight: 600;
}

.option_button {
  display: none;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 1px 6px;
  height: 20px;
  font-size: 10px;
  border: 1px solid;
  border-radius: 3px;
  background: #fff;
  cursor: pointer;
  margin: 0 1px;
  transition: all 0.2s ease;
}

.option_button:hover {
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transform: translateY(-1px);
}

.option_button.active {
  display: inline-flex !important;
}

.buy_sell_cell {
  position: relative;
  vertical-align: middle !important;
  padding: 0.25rem !important;
  width: 60px;
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 2px !important;
}

/* Four Tab Styles */
.option-chain-tab-pane {
  display: none;
}

.option-chain-tab-pane.active {
  display: block;
}

.active-option-tab {
  background-color: #fff !important;
  color: #000 !important;
  border-color: #fff !important;
}

.buy_sell_cell:hover .option_button {
  display: inline-flex;
}

.buy_button {
  color: #198754;
  border-color: #198754;
  background: rgba(25, 135, 84, 0.1);
}

.buy_button:hover {
  background: #198754;
  color: white;
}

.sell_button {
  color: #dc3545;
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.1);
}

.sell_button:hover {
  background: #dc3545;
  color: white;
}

.count_badge {
  display: none;
  position: absolute;
  top: -4px;
  right: -4px;
  width: 14px;
  height: 14px;
  line-height: 14px;
  text-align: center;
  font-size: 9px;
  color: #fff;
  border-radius: 50%;
  font-weight: bold;
}

.buy_button .count_badge {
  background: #198754;
}

.sell_button .count_badge {
  background: #dc3545;
}

.dropdown_menu {
  display: none;
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  min-width: 80px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.dropdown_menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 11px;
  transition: background-color 0.2s;
}

.dropdown_menu button:hover {
  background: #f8f9fa;
}

.dropdown_menu button:first-child:hover {
  color: #198754;
}

.dropdown_menu button:last-child:hover {
  color: #dc3545;
}

/* Expiry buttons */
.expiry_button {
  display: inline-block;
  padding: 4px 8px;
  margin: 2px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  font-size: 11px;
  transition: all 0.2s;
}

.expiry_button:hover {
  background: #e9ecef;
  border-color: #007bff;
}

.expiry_button.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

/* Position table enhancements */
.position-row {
  transition: background-color 0.2s;
}

.position-row:hover {
  background-color: rgba(0,123,255,0.1);
}

/* Option Chain Table Header Styling */
#optionChainTable thead {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 2px solid #dee2e6;
  font-size: 10px; /* Reduced font size for better look and feel */
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #333;
}

#optionChainTable thead th {
  padding: 8px 6px;
  text-align: center;
  border-right: 1px solid #e9ecef;
  white-space: nowrap;
}

#optionChainTable thead th:last-child,
#optionChainTable thead th:first-child {
  border-right: none;
}

#optionChainTable th[style*="background-color: #f39c12"] {
  background: #f39c12 !important;
  color: #fff !important;
  font-weight: 700;
}

/* Enhanced Option Chain Table Professional Styling */
#optionChainTable {
  border-collapse: collapse;
  width: 100%;
  font-size: 11px;
  border: 1px solid #dee2e6;
}

#optionChainTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

/* Enhanced table body styling */
#optionChainTable tbody tr {
  border-bottom: 1px solid #f1f3f4;
  transition: background-color 0.15s ease;
}

#optionChainTable tbody tr:hover {
  background-color: #f8f9fa;
}

#optionChainTable tbody tr:nth-child(even) {
  background-color: #fafafa;
}

#optionChainTable tbody tr:nth-child(even):hover {
  background-color: #f0f0f0;
}

#optionChainTable tbody td {
  padding: 4px 6px;
  text-align: center;
  border-right: 1px solid #f1f3f4;
  white-space: nowrap;
  font-size: 10px;
  line-height: 1.4;
}

#optionChainTable tbody td:last-child {
  border-right: none;
}

/* Remove ATM highlighting */
#optionChainTable .atm-strike {
  background-color: inherit !important;
}

/* Strike column enhancement */
#optionChainTable tbody td:nth-child(20) {
  font-weight: 600;
  background-color: #fff3cd;
  border-left: 2px solid #f39c12;
  border-right: 2px solid #f39c12;
}

/* ITM styling with yellow color for calls and puts */
.itm-call {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM calls */
}

.itm-put {
  background-color: rgba(255, 235, 59, 0.35) !important; /* Yellow for ITM puts */
}

/* Maintain hover effects for ITM rows */
.itm-call:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

.itm-put:hover {
  background-color: rgba(255, 235, 59, 0.45) !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .card-body {
    padding: 0.75rem;
  }

  .option_button {
    height: 18px;
    font-size: 9px;
    padding: 1px 4px;
  }

  #chartContainer {
    height: 250px !important;
  }
}

/* Live data indicator animation */
@keyframes pulse {
  0% { background-color: #6c757d; }
  50% { background-color: #28a745; }
  100% { background-color: #6c757d; }
}

.badge.bg-secondary {
  animation: pulse 2s infinite;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<!-- Live Trading Container with Enhanced Bootstrap Design -->
<div class="container-fluid py-3">
  <!-- Resizable Layout Container -->
  <div class="resizable-container">
    <!-- Left Panel - Symbol Selection & Option Chain -->
    <div class="resizable-panel left-panel">
      <!-- Symbol Selection & Expiry Dates Card -->
      <div class="card shadow-sm mb-2">
        <div class="card-body">
          <!-- Symbol Selection Row -->
          <div class="row g-2 align-items-center mb-3">
            <!-- Index Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 50px;">Index:</label>
              <select id="indexSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Index</option>
                <optgroup label="NSE">
                  <option value="NIFTY" selected>NIFTY 50</option>
                  <option value="BANKNIFTY">BANK NIFTY</option>
                  <option value="FINNIFTY">FIN NIFTY</option>
                  <option value="MIDCPNIFTY">MIDCAP NIFTY</option>
                </optgroup>
                <optgroup label="BSE">
                  <option value="SENSEX">SENSEX</option>
                  <option value="BANKEX">BANKEX</option>
                </optgroup>
              </select>
            </div>

            <!-- Exchange Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 70px;">Exchange:</label>
              <select id="exchangeSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Exchange</option>
                <option value="NSE">NSE</option>
                <option value="BSE">BSE</option>
                <option value="MCX">MCX</option>
                <option value="Crypto">Crypto</option>
                <option value="NSE–Commodity">NSE Commodity</option>
              </select>
            </div>

            <!-- Symbol Selection -->
            <div class="col-md-4 d-flex align-items-center">
              <label class="form-label small fw-semibold me-2 mb-0" style="min-width: 55px;">Symbol:</label>
              <select id="extraSelect" class="form-select form-select-sm flex-grow-1">
                <option value="">Select Symbol</option>
              </select>
            </div>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Expiry Dates Row -->
          <div class="d-flex align-items-center mb-3">
            <label class="form-label small fw-semibold me-3 mb-0" style="min-width: 80px;">
              <i class="fas fa-calendar-alt me-1"></i>Expiry:
            </label>
            <button id="expiryPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden">
              <div id="expiryViewerCarousel" class="d-flex gap-2 transition-all" style="transition: transform 0.3s ease;">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            <button id="expiryNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Horizontal Separator -->
          <hr class="my-2" style="border-color: #dee2e6;">

          <!-- Market Data Carousel -->
          <div class="d-flex align-items-center">
            <button id="marketDataPrevBtn" class="btn btn-link text-secondary p-1 me-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-grow-1 position-relative overflow-hidden carousel-container">
              <div id="marketDataCarousel" class="d-flex" style="transition: transform 0.3s ease; width: 700%;">
                <!-- Page 1: Primary Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Spot Price:</small><strong id="spotPrice" class="text-muted">Select Symbol</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Open:</small><strong class="text-secondary">23,649</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Future:</small><strong class="text-secondary">23,700</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">VIX:</small><strong class="text-warning">14.56</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 2: Extended Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Day High:</small><strong class="text-success">23,850</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Day Low:</small><strong class="text-danger">23,420</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Volume:</small><strong class="text-secondary">2.5M</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">OI:</small><strong class="text-secondary">1.8M</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 3: Additional Market Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">Prev Close:</small><strong class="text-secondary">23,590</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change:</small><strong class="text-success">+18</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Change %:</small><strong class="text-success">+0.08%</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">LTP:</small><strong class="text-muted">--</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 4: Options Data -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">PCR:</small><strong class="text-info">0.85</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Max Pain:</small><strong class="text-secondary">23,600</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Call OI:</small><strong class="text-success">12.5L</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Put OI:</small><strong class="text-danger">10.6L</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 5: Technical Indicators -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">RSI:</small><strong class="text-warning">62.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">MACD:</small><strong class="text-success">+15.2</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">EMA 20:</small><strong class="text-secondary">23,580</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">SMA 50:</small><strong class="text-secondary">23,520</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 6: Market Sentiment -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">FII Net:</small><strong class="text-success">+450Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">DII Net:</small><strong class="text-danger">-120Cr</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">ADX:</small><strong class="text-info">28.5</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Bollinger:</small><strong class="text-secondary">Mid</strong>
                    </div>
                  </div>
                </div>
                <!-- Page 7: Performance Metrics -->
                <div class="carousel-page">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                      <small class="text-muted me-1">52W High:</small><strong class="text-success">25,980</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">52W Low:</small><strong class="text-danger">19,280</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Beta:</small><strong class="text-secondary">1.05</strong>
                    </div>
                    <div class="text-center">
                      <small class="text-muted me-1">Avg Vol:</small><strong class="text-secondary">3.2M</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button id="marketDataNextBtn" class="btn btn-link text-secondary p-1 ms-2" style="min-width: 30px; border: none; background: none;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Option Chain Card (Single Table) -->
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <!-- ATM Display Only - No checkbox -->
            <div class="d-flex align-items-center gap-2">
              <span id="atmDisplay" class="badge bg-warning text-dark" style="font-size: 10px; min-width: 50px; display: none;">
                ATM
              </span>
            </div>
            <!-- Strike Count Dropdown -->
            <div class="d-flex align-items-center gap-2">
              <label for="strikeCountSelect" class="form-label mb-0 text-light" style="font-size: 11px; font-weight: 500;">Strike Count:</label>
              <select id="strikeCountSelect" class="form-select form-select-sm" style="width: 80px; font-size: 11px;">
                <option value="5">5</option>
                <option value="7">7</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="ALL">ALL</option>
              </select>
            </div>
            <span id="fyersSymbolDisplay" class="d-none" style="font-size: 10px; color: #6c757d; font-weight: 500;">
              <span id="fyersSymbolText">NSE:NIFTY50-INDEX</span>
            </span>
          </div>
          <div class="d-flex align-items-center gap-3">
            <div id="selectedDetailsDisplay" style="font-size: 11px; color: #adb5bd; font-weight: 500;">
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="refreshBtn" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;">
                <i class="fas fa-sync"></i>
              </button>
              <button id="fullscreenOptionChain" class="btn btn-outline-light btn-sm p-1" style="width: 30px; height: 30px;" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
              <div id="liveDataControls" class="d-flex align-items-center gap-2">
              <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle p-1" type="button" id="columnVisibilityDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="height: 30px; font-size: 11px;" title="Column Visibility">
                  <i class="fas fa-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="columnVisibilityDropdown" style="min-width: 250px; max-height: 400px; overflow-y: auto;">
                  <li><h6 class="dropdown-header">Column Visibility</h6></li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3 py-1">
                    <div class="d-flex gap-2 mb-2">
                      <button id="selectAllColumns" class="btn btn-success btn-sm flex-fill" style="font-size: 10px;">Select All</button>
                      <button id="deselectAllColumns" class="btn btn-secondary btn-sm flex-fill" style="font-size: 10px;">Clear All</button>
                      <button id="resetToDefaults" class="btn btn-primary btn-sm flex-fill" style="font-size: 10px;">Defaults</button>
                    </div>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3">
                    <div class="row" style="font-size: 11px;">
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="16" id="col16"><label class="form-check-label" for="col16">CE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="17" id="col17"><label class="form-check-label" for="col17">CE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="15" id="col15"><label class="form-check-label" for="col15">CE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="14" id="col14"><label class="form-check-label" for="col14">CE OI</label></div>
                      </div>
                      <div class="col-6">
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="21" id="col21"><label class="form-check-label" for="col21">PE LTP</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="22" id="col22"><label class="form-check-label" for="col22">PE Chart</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="23" id="col23"><label class="form-check-label" for="col23">PE Vol</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" data-column="24" id="col24"><label class="form-check-label" for="col24">PE OI</label></div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
                <span id="liveDataStatus" style="font-size: 12px; color: #6c757d;">
                  <i class="fas fa-circle text-secondary"></i> Live Data Ready
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Single Option Chain Navigation -->
        <div class="card-header bg-secondary text-white p-2 border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1" style="font-size: 12px;">
            <span class="text-light" style="font-size: 11px; font-weight: 500;">
              Option Chain
            </span>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Loading Indicator -->
          <div id="optionChainLoading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">
              <small class="text-muted">Loading option chain data...</small>
            </div>
          </div>
          <!-- Single Option Chain Table -->
          <div id="optionChainContainer" style="max-height: 60vh; overflow-y: auto;">

            <div class="table-container">
              <table class="table table-sm mb-0" id="optionChainTable">
                <thead>
                  <tr>
                    <th>CE B/S</th>
                    <th>Veta</th>
                    <th>Volga</th>
                    <th>Charm</th>
                    <th>Vanna</th>
                    <th>Vega</th>
                    <th>Theta</th>
                    <th>Gamma</th>
                    <th>Chng</th>
                    <th>Bid Qty</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Ask Qty</th>
                    <th>Chng in OI</th>
                    <th>OI</th>
                    <th>Vol</th>
                    <th>Chart</th>
                    <th>LTP</th>
                    <th>Δ</th>
                    <th style="background-color: #f39c12; color: #000;">Strike</th>
                    <th>Δ</th>
                    <th>LTP</th>
                    <th>Chart</th>
                    <th>Vol</th>
                    <th>OI</th>
                    <th>Chng in OI</th>
                    <th>Ask Qty</th>
                    <th>Ask</th>
                    <th>Bid</th>
                    <th>Bid Qty</th>
                    <th>Chng</th>
                    <th>Gamma</th>
                    <th>Theta</th>
                    <th>Vega</th>
                    <th>Vanna</th>
                    <th>Charm</th>
                    <th>Volga</th>
                    <th>Veta</th>
                    <th>PE B/S</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resizable Separator -->
    <div class="resizer"></div>

    <!-- Right Panel - Charts & Trading -->
    <div class="resizable-panel right-panel">
      <!-- Enhanced Saved Tables Control with Broker Management (Responsive Fixed) -->
      <div class="mb-1 p-2 bg-light rounded">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <!-- Left Side: Saved Tables Controls -->
          <div class="d-flex align-items-center gap-2 saved-tables-controls flex-shrink-0">
            <label for="savedTablesSelect" class="form-label mb-0 me-1" style="white-space: nowrap; font-size: 12px;">Saved Tables:</label>
            <select id="savedTablesSelect" class="form-select form-select-sm" style="min-width: 120px; max-width: 150px;">
              <option value="">-- Select Saved Table --</option>
            </select>
            <div class="btn-group" role="group">
              <button id="addNewBtn" class="btn btn-primary btn-sm" title="Add New Table">
                <i class="fas fa-plus"></i>
              </button>
              <button id="saveBtn" class="btn btn-success btn-sm" title="Save Table">
                <i class="fas fa-save"></i>
              </button>
              <button id="deleteBtn" class="btn btn-danger btn-sm" title="Delete Table">
                <i class="fas fa-trash"></i>
              </button>
              <button id="newTabBtn" class="btn btn-info btn-sm" title="Open Selected in New Tab">
                <i class="fas fa-external-link-alt"></i>
              </button>
              <button id="viewBasketBtn" class="btn btn-secondary btn-sm" title="View Strategy Basket" onclick="window.location.href='/basket'">
                <i class="fas fa-shopping-basket"></i>
              </button>
            </div>
          </div>

          <!-- Broker Management - Enhanced Visual -->
          <div class="d-flex align-items-center gap-2 broker-management-controls flex-shrink-0">
            <!-- User Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="userSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">User:</label>
              <select id="userSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
            </div>

            <!-- Broker Selection -->
            <div class="d-flex align-items-center gap-1">
              <label for="brokerSelect" class="form-label mb-0" style="font-size: 12px; white-space: nowrap; font-weight: 500;">Broker:</label>
              <select id="brokerSelect" class="form-select form-select-sm" style="width: 90px; font-size: 12px; height: 30px;">
                <option value="">Select</option>
              </select>
              <span id="tokenStatus" class="badge bg-secondary ms-1" style="font-size: 10px; white-space: nowrap; padding: 4px 6px;">No Token</span>
            </div>

            <!-- Token Management -->
            <div class="btn-group ms-2" role="group">
              <button id="createTokenBtn" class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Create New Token">
                <i class="fas fa-key me-1"></i>Create
              </button>
              <button id="refreshTokenBtn" class="btn btn-outline-warning btn-sm" style="padding: 4px 8px; font-size: 11px; height: 30px;" disabled title="Refresh Token">
                <i class="fas fa-sync me-1"></i>Refresh
              </button>
              <button id="brokerSettingsBtn" class="btn btn-outline-dark btn-sm" style="padding:4px 8px;font-size:11px;" title="Manage Broker Credentials">
                <i class="fas fa-user-cog me-1"></i>Broker Settings
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Tabs - Compact Single Line -->
      <div class="card shadow-sm">
        <div class="card-header p-2 bg-white border-bottom">
          <div class="d-flex justify-content-start align-items-center gap-1 flex-wrap" style="font-size: 13px;">
            <button class="btn btn-sm btn-primary active-tab-btn" id="payoff-tab" data-bs-toggle="tab" data-bs-target="#payoff-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Payoff Chart
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="mtm-tab" data-bs-toggle="tab" data-bs-target="#mtm-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              MTM
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Strategy
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="oi-tab" data-bs-toggle="tab" data-bs-target="#oi-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              OI
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="rolling-tab" data-bs-toggle="tab" data-bs-target="#rolling-content" type="button" role="tab" style="padding: 4px 12px; font-size: 12px;">
              Rolling Straddle
            </button>
            <div class="ms-auto d-flex align-items-center gap-2">
              <label class="form-check-label" for="payoffSettings" style="font-size: 11px;">
                <input class="form-check-input" type="checkbox" id="payoffSettings"> Payoff Settings
              </label>
              <button id="togglePayoffView" class="btn btn-outline-secondary btn-sm" title="Hide/Show Payoff Chart">
                <i class="fas fa-chevron-up"></i>
              </button>
              <button id="fullscreenPayoff" class="btn btn-outline-primary btn-sm" title="Fullscreen View">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="payoffCardBody" class="card-body p-0">
          <div class="tab-content" id="analysisTabContent">
            <!-- Payoff Chart Tab Content -->
            <div class="tab-pane fade show active" id="payoff-content" role="tabpanel">
              <div class="p-3">

      <!-- Payoff Chart Content (Hideable) -->
      <div id="payoffChartContent">
        <!-- Risk Metrics - Label Top, Value Bottom -->
        <div class="mb-2 py-1">
          <div class="d-flex justify-content-between align-items-start flex-wrap" style="font-size: 12px;">
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Req. Margin</div>
              <div id="marginValue" class="fw-bold text-primary">₹3,391 <span class="text-muted">□</span></div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P&L</div>
              <div id="pnlValue" class="fw-bold text-success">₹0 (0.00)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Profit</div>
              <div id="maxProfitValue" class="fw-bold text-success">₹11,493 (1.3%)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Max Loss</div>
              <div id="maxLossValue" class="fw-bold text-danger">(Unlimited)</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">P.O.P.</div>
              <div id="popValue" class="fw-bold text-info">55.24%</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Net Credit</div>
              <div id="netCreditValue" class="fw-bold text-success">₹11,487.5</div>
            </div>
            <div class="text-center">
              <div class="text-muted" style="margin-bottom: 2px; font-size: 10px;">Breakeven</div>
              <div id="breakevenValue" class="fw-bold text-warning">26037 (+ 0.5%), 24902 (- 1.5%)</div>
            </div>
          </div>
        </div>

        <!-- Payoff Chart - No Header -->
        <div class="mb-3">
          <div id="chartContainer" style="width: 100%; height: 350px; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #fff;"></div>
          <canvas id="payoffChart" style="display: none;"></canvas>
        </div>
      </div>

      <!-- Current Positions Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 me-3">
              <i class="fas fa-briefcase me-2"></i>Current Positions
            </h6>
            <div id="brokerInfo" class="small text-white-75" style="display: none;">
              <span id="selectedBrokerName">No Broker Selected</span>
              <span class="mx-2">|</span>
              <span id="selectedBrokerUserId">No User ID</span>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button id="clearAllBtn" class="btn btn-outline-light btn-sm">
              <i class="fas fa-trash me-1"></i>Clear All
            </button>
            <span id="positionCount" class="badge bg-light text-dark">0 Positions</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm mb-0" style="font-size: 11px;">
              <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <tr>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">
                    <input type="checkbox" id="selectAllPositions" style="transform: scale(0.8);">
                  </th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 35px; text-align: center;">Type</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 40px; text-align: center;">Action</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Lots</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 45px; text-align: center;">Qty</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Trade Date/Time</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Strike</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 80px; text-align: center;">Expiry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 60px; text-align: center;">Entry</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">LTP</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Delta</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">P&L</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 70px; text-align: center;">Lots Exit</th>
                  <th style="padding: 8px 6px; border-right: 1px solid #dee2e6; width: 50px; text-align: center;">Lock In</th>
                  <th style="padding: 8px 6px; width: 40px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="positionTableBody">
                <tr>
                  <td colspan="15" class="text-center text-muted py-3">
                    <i class="fas fa-plus-circle me-2"></i>No positions yet. Start trading!
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Position Table Footer with Controls -->
          <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 11px;">
            <div class="d-flex align-items-center gap-2">
              <span>Multiplier:</span>
              <select class="form-select form-select-sm" style="width: 60px; font-size: 10px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <span>Lot Size: 75</span>
              <button class="btn btn-outline-primary btn-sm" style="padding: 2px 8px; font-size: 10px;">Add Alert</button>
              <button class="btn btn-outline-success btn-sm" style="padding: 2px 8px; font-size: 10px;">Save</button>
              <button class="btn btn-outline-info btn-sm" style="padding: 2px 8px; font-size: 10px;">Share</button>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span id="totalDelta" class="text-info" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <span id="totalPnLSummary" class="text-success" style="font-weight: bold; font-size: 11px;">+0.00</span>
              <span class="text-danger">Exit</span>
              <button class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; font-size: 10px;">Clear</button>
            </div>
          </div>
        </div>
      </div>

              </div>
            </div>

            <!-- MTM Tab Content -->
            <div class="tab-pane fade" id="mtm-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-calculator fa-3x mb-3"></i>
                  <h5>MTM Analysis</h5>
                  <p>Mark-to-market analysis and real-time P&L tracking will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Strategy Tab Content -->
            <div class="tab-pane fade" id="strategy-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chess fa-3x mb-3"></i>
                  <h5>Strategy Builder</h5>
                  <p>Advanced strategy creation and backtesting tools will be available here.</p>
                </div>
              </div>
            </div>

            <!-- OI Tab Content -->
            <div class="tab-pane fade" id="oi-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-chart-bar fa-3x mb-3"></i>
                  <h5>Open Interest Analysis</h5>
                  <p>Open interest charts and PCR analysis will be displayed here.</p>
                </div>
              </div>
            </div>

            <!-- Rolling Straddle Tab Content -->
            <div class="tab-pane fade" id="rolling-content" role="tabpanel">
              <div class="p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-sync-alt fa-3x mb-3"></i>
                  <h5>Rolling Straddle</h5>
                  <p>Rolling straddle analysis and optimization tools will be available here.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Hidden Loader Template -->
<div id="loaderTemplate" style="display:none;">
  <div class="d-flex justify-content-center">
    <div class="spinner-border spinner-border-sm text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Include Resizable Layout CSS -->
<link href="{{ url_for('static', filename='css/resizable.css') }}" rel="stylesheet">

<!-- Option Chain Styling for WebSocket -->
<style>
  /* ATM Strike Highlighting */
  .atm-strike {
    background-color: #ffc107 !important;
    font-weight: bold;
  }
  
  .atm-strike td {
    background-color: #ffc107 !important;
    color: #000 !important;
  }
  
  /* ITM/OTM Styling - Subtle yellow for ITM like the reference image */
  .call-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .call-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  .put-ltp.itm {
    background-color: #fff3cd !important;
    color: #856404 !important;
  }
  
  .put-ltp.otm {
    background-color: transparent !important;
    color: inherit !important;
  }
  
  /* Strike Price Column */
  .strike-price {
    background-color: #495057 !important;
    color: #fff !important;
    font-weight: bold;
  }
  
  /* Spot Price Animation */
  .spot-price-updated {
    animation: priceFlash 0.5s ease-in-out;
  }
  
  @keyframes priceFlash {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
  }
</style>

<!-- *** NEW: symbol / expiry logic *** -->
<script src="{{ url_for('static', filename='js/symbol_selector_fixed.js') }}"></script>
<script src="{{ url_for('static', filename='js/websocket_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/option_microchart.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart_popup.js') }}"></script>


<!-- Highcharts (Pay-off chart) -->
<script src="https://code.highcharts.com/highcharts.js"></script>

<!-- Resizable layout behaviour -->
<script src="{{ url_for('static', filename='js/resizable.js') }}"></script>

<!-- Chart controller (pay-off & option-chain fullscreen) -->
<script src="{{ url_for('static', filename='js/chart_controller.js') }}"></script>

<!-- Market data carousel -->
<script src="{{ url_for('static', filename='js/market_data_carousel.js') }}"></script>

<!-- Broker settings -->
<script src="{{ url_for('static', filename='js/broker_settings.js') }}"></script>

<script>
// Initialize components when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Attach click handlers to buy/sell buttons
    attachBuySellHandlers();
});

function attachBuySellHandlers() {
    // Add event listeners to all buy/sell buttons
    document.addEventListener('click', async function(event) {
        if (event.target.classList.contains('option_button')) {
            const button = event.target;
            const row = button.closest('tr');
            const strikeCell = row.querySelector('.strike-price');
            const strike = parseFloat(strikeCell.textContent);
            
            let ltp, optionType, action;
            
            if (button.classList.contains('buy_button')) {
                action = 'BUY';
            } else if (button.classList.contains('sell_button')) {
                action = 'SELL';
            }
            
            // Determine if it's CE or PE based on position
            const buyCell = button.closest('.buy_sell_cell');
            const allCells = Array.from(row.children);
            const cellIndex = allCells.indexOf(buyCell);
            
            if (cellIndex === 0) {
                // First buy_sell_cell is CE
                optionType = 'CE';
                const ltpCell = row.querySelector('.ce-ltp');
                ltp = parseFloat(ltpCell.textContent.replace(/[^\d.-]/g, '')) || 0;
            } else {
                // Last buy_sell_cell is PE
                optionType = 'PE';
                const ltpCell = row.querySelector('.pe-ltp');
                ltp = parseFloat(ltpCell.textContent.replace(/[^\d.-]/g, '')) || 0;
            }
            
            // Add position
            await addPosition(action, optionType, strike, ltp);
        }
    });
}

async function addPosition(action, optionType, strike, ltp) {
    // Get current symbol and expiry from DOM elements
    let currentSymbol = window.wsHandler?.currentSymbol || '';
    let currentExpiry = window.wsHandler?.currentExpiry || '';
    
    // Fallback: get from DOM if not available in wsHandler
    if (!currentSymbol || !currentExpiry) {
        const symbolHeader = document.querySelector('#symbolDisplay');
        const expiryButton = document.querySelector('.expiry-btn.active, .expiry-btn[style*="background"]');
        
        if (symbolHeader) {
            currentSymbol = symbolHeader.textContent.trim() || 'NIFTY50';
        }
        if (expiryButton) {
            currentExpiry = expiryButton.textContent.trim();
        }
    }
    
    // Use default values if still not found
    if (!currentSymbol) currentSymbol = 'NIFTY50';
    if (!currentExpiry) {
        const today = new Date();
        const nextThursday = new Date(today);
        nextThursday.setDate(today.getDate() + (4 - today.getDay() + 7) % 7);
        currentExpiry = nextThursday.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' }).replace(/ /g, '-');
    }

    if (!ltp || ltp <= 0) {
        showAlert('Invalid LTP price', 'warning');
        return;
    }

    const positionData = {
        symbol: currentSymbol,
        strike: strike,
        expiry: currentExpiry,
        option_type: optionType,
        action: action,
        quantity: 75, // Default lot size
        entry_price: ltp,
        current_price: ltp,
        lot_size: 75
    };

    try {
        const response = await fetch('/api/positions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(positionData)
        });

        if (response.ok) {
            const newPosition = await response.json();
            showAlert(`${action} ${optionType} position added successfully`, 'success');
            console.log('Position added:', newPosition);
            
            // Update both the payoff chart and positions table directly
            await updatePayoffChart();
            await updatePositionsTable();
            await updateBadgeCount();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to add position');
        }
    } catch (error) {
        console.error('Error adding position:', error);
        showAlert('Failed to add position: ' + error.message, 'danger');
    }
}

function showAlert(message, type = 'info') {
    // Create a simple toast notification
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// Removed popup functions - using direct table/chart updates instead

async function updatePayoffChart() {
    try {
        const response = await fetch('/api/positions/payoff');
        const data = await response.json();
        
        if (data.payoff_data && data.payoff_data.length > 0) {
            // Use Highcharts with existing chartContainer
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer && typeof Highcharts !== 'undefined') {
                // Get current strike prices from option chain for X-axis range
                const strikeElements = document.querySelectorAll('.strike-price');
                let minStrike = Infinity, maxStrike = -Infinity;
                strikeElements.forEach(el => {
                    const strike = parseFloat(el.textContent);
                    if (strike) {
                        minStrike = Math.min(minStrike, strike);
                        maxStrike = Math.max(maxStrike, strike);
                    }
                });
                
                // If no strikes found, use data range
                if (minStrike === Infinity) {
                    minStrike = Math.min(...data.payoff_data.map(point => point[0]));
                    maxStrike = Math.max(...data.payoff_data.map(point => point[0]));
                }
                
                // Create or update Highcharts chart
                if (!window.payoffChart) {
                    window.payoffChart = Highcharts.chart('chartContainer', {
                        chart: { type: 'line', height: 350 },
                        title: { text: 'Option Strategy Payoff' },
                        xAxis: { 
                            title: { text: 'Underlying Price (₹)' },
                            min: minStrike * 0.9,
                            max: maxStrike * 1.1
                        },
                        yAxis: { 
                            title: { text: 'P&L (₹)' },
                            plotLines: [{ value: 0, color: 'black', dashStyle: 'solid', width: 1 }]
                        },
                        series: [{ name: 'Payoff', data: [], color: '#007bff' }],
                        legend: { enabled: false },
                        tooltip: {
                            formatter: function() {
                                return `<b>Price: ₹${this.x.toFixed(0)}</b><br/>P&L: ₹${this.y.toFixed(2)}`;
                            }
                        }
                    });
                } else {
                    // Update X-axis range
                    window.payoffChart.xAxis[0].setExtremes(minStrike * 0.9, maxStrike * 1.1);
                }
                // Update chart data
                window.payoffChart.series[0].setData(data.payoff_data);
            }
        }
    } catch (error) {
        console.error('Error updating payoff chart:', error);
    }
}

async function updatePositionsTable() {
    try {
        const response = await fetch('/api/positions');
        const positions = await response.json();
        
        const tableBody = document.querySelector('#positionTableBody');
        if (!tableBody) return;
        
        if (positions.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12" class="text-center">No positions yet. Start trading!</td></tr>';
            return;
        }
        
        let totalPnL = 0;
        tableBody.innerHTML = '';
        
        positions.forEach(pos => {
            const pnl = (pos.current_price - pos.entry_price) * pos.quantity;
            if (pos.action === 'BUY') {
                totalPnL += pnl;
            } else {
                totalPnL -= pnl;
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" class="form-check-input"></td>
                <td><span class="badge ${pos.option_type === 'CE' ? 'bg-success' : 'bg-info'}">${pos.option_type}</span></td>
                <td><span class="badge ${pos.action === 'BUY' ? 'bg-primary' : 'bg-warning'}">${pos.action}</span></td>
                <td>1</td>
                <td>${pos.quantity}</td>
                <td>${pos.trade_date}</td>
                <td>${pos.strike}</td>
                <td>${pos.expiry}</td>
                <td>₹${pos.entry_price.toFixed(2)}</td>
                <td>₹${pos.current_price.toFixed(2)}</td>
                <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">₹${pnl.toFixed(2)}</td>
                <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">₹${pnl.toFixed(2)}</td>
                <td>-</td>
                <td>-</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removePositionFromTable(${pos.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Update position count
        const positionCount = document.querySelector('.position-count');
        if (positionCount) {
            positionCount.textContent = positions.length;
        }
        
    } catch (error) {
        console.error('Error updating positions table:', error);
    }
}

async function updateBadgeCount() {
    try {
        const response = await fetch('/api/positions');
        const positions = await response.json();
        
        // Clear all existing badges
        document.querySelectorAll('.count_badge').forEach(badge => {
            badge.textContent = '0';
            badge.style.display = 'none';
        });
        
        // Count positions by strike, option type, and action
        const positionCounts = {};
        positions.forEach(pos => {
            const key = `${pos.strike}_${pos.option_type}_${pos.action}`;
            positionCounts[key] = (positionCounts[key] || 0) + 1;
        });
        
        // Update badges on buy/sell buttons
        Object.entries(positionCounts).forEach(([key, count]) => {
            const [strike, optionType, action] = key.split('_');
            
            // Find the row with this strike
            const strikeRows = document.querySelectorAll('tr');
            strikeRows.forEach(row => {
                const strikeCell = row.querySelector('.strike-price');
                if (strikeCell && parseFloat(strikeCell.textContent) === parseFloat(strike)) {
                    // Determine which cell (CE or PE)
                    const buySellCells = row.querySelectorAll('.buy_sell_cell');
                    let targetCell;
                    if (optionType === 'CE') {
                        targetCell = buySellCells[0]; // First cell is CE
                    } else {
                        targetCell = buySellCells[1]; // Second cell is PE
                    }
                    
                    if (targetCell) {
                        // Find the specific button (Buy or Sell)
                        const buttonClass = action === 'BUY' ? '.buy_button' : '.sell_button';
                        const button = targetCell.querySelector(buttonClass);
                        if (button) {
                            // Create or update badge
                            let badge = button.querySelector('.count_badge');
                            if (!badge) {
                                badge = document.createElement('span');
                                badge.className = 'count_badge';
                                badge.style.cssText = `
                                    position: absolute;
                                    top: -8px;
                                    right: -8px;
                                    width: 18px;
                                    height: 18px;
                                    line-height: 18px;
                                    text-align: center;
                                    font-size: 11px;
                                    color: #fff;
                                    border-radius: 50%;
                                    background: ${action === 'BUY' ? '#28a745' : '#dc3545'};
                                `;
                                button.appendChild(badge);
                            }
                            if (count > 0) {
                                badge.textContent = count;
                                badge.style.display = 'block';
                            }
                        }
                    }
                }
            });
        });
    } catch (error) {
        console.error('Error updating badge counts:', error);
    }
}

async function removePositionFromTable(positionId) {
    try {
        const response = await fetch(`/api/positions/${positionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Position removed successfully', 'success');
            await updatePositionsTable();
            await updatePayoffChart();
        }
    } catch (error) {
        console.error('Error removing position:', error);
        showAlert('Failed to remove position', 'danger');
    }
}

// Initialize positions table and payoff chart on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePositionsTable();
    updatePayoffChart();
});
</script>



{% endblock %}